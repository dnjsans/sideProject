!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.hetajs={})}(this,function(t){"use strict";function e(t){return new z(t)}var i=function(t,e){return e={exports:{}},t(e,e.exports),e.exports}(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});for(var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},o=(function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}()),s=(function t(e,i,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,i);if(void 0===o){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,i,n)}if("value"in o)return o.value;var r=o.get;return void 0!==r?r.call(n):void 0}),r=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},a=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},h={},c={},u=[],l=0;l<256;l++)u[l]=(l<16?"0":"")+l.toString(16);var y=function(){function t(){n(this,t)}return o(t,null,[{key:"UUID",value:function(){var t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return u[255&t]+u[t>>8&255]+u[t>>16&255]+u[t>>24&255]+"-"+u[255&e]+u[e>>8&255]+"-"+u[e>>16&15|64]+u[e>>24&255]+"-"+u[63&i|128]+u[i>>8&255]+"-"+u[i>>16&255]+u[i>>24&255]+u[255&n]+u[n>>8&255]+u[n>>16&255]+u[n>>24&255]}},{key:"Add",value:function(t,e){e.loaded=!1;var i=e.type,n=e.target;if("IMAGE"==i){var o=new Image;o.onload=function(){h[t]=o,e.loaded=!0},o.src=n}else"OBJECT"==i?(h[t]=n,e.loaded=!0):"TEXT"==i?(h[t]=n,e.loaded=!0):"MESH"==i?(h[t]=n,e.loaded=!0):"SOUND"==i?(h[t]=n,e.loaded=!0):"CALLBACK"!=i&&"LINK"!=i||("function"!=typeof n&&console.log("Warning!!! LINK target must be Function"),h[t]=n,e.loaded=!0);c[t]=e}},{key:"Remove",value:function(t){delete h[t],delete c[t]}},{key:"Load",value:function(t){return null==c[t]?null:!0===c[t].loaded?h[t]:"IMAGE"==c[t].type?"":void 0}},{key:"EncodeImageToBase64",value:function(t){var e=document.createElement("canvas");e.width=t.naturalWidth,e.height=t.naturalHeight,e.getContext("2d").drawImage(t,0,0);try{return e.toDataURL("image/png")}catch(t){return console.log(t),""}}}]),t}(),f=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;n(this,t),this.x=e,this.y=i}return o(t,[{key:"set",value:function(t,e){return this.x=t,this.y=e,this}},{key:"clone",value:function(){return new this.constructor(this.x,this.y)}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}},{key:"angle",value:function(){var t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t}},{key:"distanceTo",value:function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this}},{key:"multiplyScalar",value:function(t){return this.x*=t,this.y*=t,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"lenSq",value:function(){return this.x*this.x+this.y*this.y}},{key:"length",value:function(){return Math.sqrt(this.lenSq())}}]),t}(),d=function(){function t(e){n(this,t),this.stage=e,this._eventStoreList={},this._unitsFromEvents={},this.history={mousedown:{x:null,y:null},mouseup:{x:null,y:null},click:{x:null,y:null}}}return o(t,[{key:"_addUnitsFromEvents",value:function(t,e){for(var i in t)null==this._unitsFromEvents[i]&&(this._unitsFromEvents[i]=[]),this._unitsFromEvents[i].push(e)}},{key:"_removeUnitsFromEvents",value:function(t,e){var i=this._eventStoreList[t];for(var n in i)if((null==e||e==n)&&null!=this._unitsFromEvents[n])for(var o=0;o<this._unitsFromEvents[n].length;++o)if(this._unitsFromEvents[n][o].id==t){this._unitsFromEvents[n].splice(o,1);break}}},{key:"Add",value:function(t,e,i){null!=i&&(e.parentId=i),this._eventStoreList[t.id]=e,null!=i&&this._addUnitsFromEvents(e,t)}},{key:"Remove",value:function(t){this._removeUnitsFromEvents(t),delete this._eventStoreList[t]}},{key:"AddAttribute",value:function(t,e){var i=this._eventStoreList[t];for(var n in e)i[n]=e[n];this._eventStoreList[t]=i,this._addUnitsFromEvents(i,this.stage.scene.Units[t])}},{key:"RemoveAttribute",value:function(t,e){var i=this._eventStoreList[t];if(e instanceof Array)for(var n in e)this._removeUnitsFromEvents(t,e[n]),delete i[e[n]];else for(var o in e)this._removeUnitsFromEvents(t,o),delete i[o];this._eventStoreList[t]=i}},{key:"FindItems",value:function(t,e,i){return void 0===i?this._getCollisionObject(this.stage.scene.getOrderdUnits(),new f(t.x,t.y),e):this._getEventOrientedCollision(new f(t.x,t.y),e,i)}},{key:"FindItemOne",value:function(t,e){var i=this.FindItems(new f(t.x,t.y),1,e);return i.length>0?i[0]:null}},{key:"Trigger",value:function(t,e,i){if(this.setHistory(e,i.position),null!=t)for(var n in this._eventStoreList)if(n==t.id){var o=this._eventStoreList[n],s=o[e];if(void 0===s)return;void 0!==o.parentId&&(t.parentId=o.parentId),void 0!==o._before&&o._before.call(t,this.stage,i),void 0!==s&&s.call(t,this.stage,i),void 0!==o._after&&o._after.call(t,this.stage,i)}}},{key:"getHistory",value:function(t){return this.history[t]}},{key:"setHistory",value:function(t,e){void 0!==this.history[t]&&(this.history[t].x=e.x,this.history[t].y=e.y)}},{key:"_getEventOrientedCollision",value:function(t,e,i){var n=[],o=this._unitsFromEvents[i];return null!=o&&(n=this._getCollisionObject(o,t,e)),n}},{key:"_getCollisionObject",value:function(t,e,i){for(var n=[],o=0,s=0;s<t.length;s++){var r=t[s];if(1!=r.hide&&(!0===r.CollisionCheck(e)&&(n.push(r),o++),null!=i&&i<=o))return n}return n}},{key:"AddEvent",value:function(t,e,i){null!=t&&void 0!==t&&(t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent?t.attachEvent("on"+e,i):t["on"+e]=i)}},{key:"RemoveEvent",value:function(t,e,i){null!=t&&void 0!==t&&(t.removeEventListener?t.removeEventListener(e,i,!1):t.detachEvent?t.detachEvent("on"+e,i):delete t["on"+e])}}]),t}(),_={basic:{uniform:[],vs:"attribute vec2 a_position;\r\nattribute vec2 a_texCoord;\r\n\r\nvarying vec2 v_texCoord;\r\nvoid main(){\r\n\tgl_Position = vec4(a_position, 1.0, 1.0);\r\n\tv_texCoord = a_texCoord;\r\n}\r\n",fs:"precision mediump float;\r\nuniform sampler2D u_image;\r\nvarying vec2 v_texCoord;\r\n\r\nvoid main(){\r\n\tgl_FragColor = texture2D(u_image, v_texCoord);\r\n}\r\n"}},v=function(){function t(e){n(this,t),this.gl=e,this.getProgram()}return o(t,[{key:"getProgram",value:function(){var t=this.gl,e=this._getShader(_.basic.vs,"VERTEX"),i=this._getShader(_.basic.fs,"FRAGMENT");if(e&&i){if(this.program=t.createProgram(),t.attachShader(this.program,e),t.attachShader(this.program,i),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))return console.log("Error Linking PROGRAM :"+t.getProgramInfoLog(this.program)),null;if(t.validateProgram(this.program),!t.getProgramParameter(this.program,t.VALIDATE_STATUS))return console.log("Error Validating PROGRAM :"+t.getProgramInfoLog(this.program)),null;t.detachShader(this.program,e),t.detachShader(this.program,i),t.deleteShader(e),t.deleteShader(i),t.useProgram(null)}}},{key:"_getShader",value:function(t,e){var i=this.gl,n=i.VERTEX_SHADER;"FRAGMENT"===e&&(n=i.FRAGMENT_SHADER);var o=i.createShader(n);return i.shaderSource(o,t),i.compileShader(o),i.getShaderParameter(o,i.COMPILE_STATUS)?o:(console.log("Error "+e+" Shader :"+i.getShaderInfoLog(o)),null)}}]),t}(),p=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(this,t),this.isVec3=!0,this.x=e,this.y=i,this.z=o}return o(t,[{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"clamp",value:function(t,e){return this.x=Math.min(e.x,Math.max(t.x,this.x)),this.y=Math.min(e.y,Math.max(t.y,this.y)),this.z=Math.min(e.z,Math.max(t.z,this.z)),this}},{key:"angleTo",value:function(t){var e=this.x*this.x+this.y*this.y+this.z*this.z,i=t.x*t.x+t.y*t.y+t.z*t.z,n=this.dot(t)/Math.sqrt(e*i);return Math.acos(Math.min(1,Math.max(-1,n)))}},{key:"distanceTo",value:function(t){var e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return Math.sqrt(e*e+i*i+n*n)}},{key:"dot",value:function(t){return t.x*this.x+t.y*this.y+t.z*this.z}},{key:"cross",value:function(t){var e=this.x,i=this.y,n=this.z;return this.x=i*t.z-n*t.y,this.y=n*t.x-e*t.z,this.z=e*t.y-i*t.x,this}},{key:"crossVec",value:function(t,e){var i=t.x,n=t.y,o=t.z;return this.x=n*e.z-o*e.y,this.y=o*e.x-i*e.z,this.z=i*e.y-n*e.x,this}},{key:"set",value:function(t,e,i){return this.x=t,this.y=e,this.z=i,this}},{key:"setScalar",value:function(t){return this.x=t,this.y=t,this.z=t,this}},{key:"setX",value:function(t){return this.x=t,this}},{key:"setY",value:function(t){return this.y=t,this}},{key:"setZ",value:function(t){return this.z=t,this}},{key:"setComponent",value:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}},{key:"getComponent",value:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}},{key:"add",value:function(t,e){return void 0!==e?this.addVectors(t,e):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}},{key:"sub",value:function(t,e){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}},{key:"multiply",value:function(t,e){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return this.x*=t,this.y*=t,this.z*=t,this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}},{key:"applyMatrix3",value:function(t){var e=this.x,i=this.y,n=this.z,o=t.ele;return this.x=o[0]*e+o[3]*i+o[6]*n,this.y=o[1]*e+o[4]*i+o[7]*n,this.z=o[2]*e+o[5]*i+o[8]*n,this}},{key:"applyMatrix4",value:function(t){var e=this.x,i=this.y,n=this.z,o=t.ele,s=1/(o[3]*e+o[7]*i+o[11]*n+o[15]);return this.x=(o[0]*e+o[4]*i+o[8]*n+o[12])*s,this.y=(o[1]*e+o[5]*i+o[9]*n+o[13])*s,this.z=(o[2]*e+o[6]*i+o[10]*n+o[14])*s,this}},{key:"applyQuaternion",value:function(t){var e=this.x,i=this.y,n=this.z,o=t.x,s=t.y,r=t.z,a=t.w,h=a*e+s*n-r*i,c=a*i+r*e-o*n,u=a*n+o*i-s*e,l=-o*e-s*i-r*n;return this.x=h*a+l*-o+c*-r-u*-s,this.y=c*a+l*-s+u*-o-h*-r,this.z=u*a+l*-r+h*-s-c*-o,this}},{key:"transformDirection",value:function(t){var e=this.x,i=this.y,n=this.z,o=t.ele;return this.x=o[0]*e+o[4]*i+o[8]*n,this.y=o[1]*e+o[5]*i+o[9]*n,this.z=o[2]*e+o[6]*i+o[10]*n,this.normalize()}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clampScalar",value:function(e,i){return this.clamp(new t(e,e,e),new t(i,i,i))}},{key:"clampLength",value:function(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}},{key:"floor",value:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}},{key:"ceil",value:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}},{key:"round",value:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}},{key:"roundToZero",value:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"manhattanLength",value:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}},{key:"normalize",value:function(){return this.divideScalar(this.length()||1)}},{key:"setLength",value:function(t){return this.normalize().multiplyScalar(t)}},{key:"lerp",value:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}},{key:"lerpVectors",value:function(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t)}},{key:"projectOnVector",value:function(t){var e=t.dot(this)/t.lengthSq();return this.copy(t).multiplyScalar(e)}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}},{key:"manhattanDistanceTo",value:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}},{key:"setFromSpherical",value:function(t){var e=Math.sin(t.phi)*t.radius;return this.x=e*Math.sin(t.theta),this.y=Math.cos(t.phi)*t.radius,this.z=e*Math.cos(t.theta),this}},{key:"setFromCylindrical",value:function(t){return this.x=t.radius*Math.sin(t.theta),this.y=t.y,this.z=t.radius*Math.cos(t.theta),this}},{key:"setFromMatrixPosition",value:function(t){var e=t.ele;return this.x=e[12],this.y=e[13],this.z=e[14],this}},{key:"setFromMatrixScale",value:function(t){var e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}},{key:"setFromMatrixColumn",value:function(t,e){return this.fromArray(t.ele,4*e)}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}},{key:"fromBufferAttribute",value:function(t,e,i){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}}]),t}(),x=function(){function t(){n(this,t),this.isMat4=!0,this.ele=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.lookVecX=new p,this.lookVecY=new p,this.lookVecZ=new p,this.vecApplyBuff=new p,this.extractRotVec=new p}return o(t,[{key:"set",value:function(t,e,i,n,o,s,r,a,h,c,u,l,y,f,d,_){var v=this.ele;return v[0]=t,v[4]=e,v[8]=i,v[12]=n,v[1]=o,v[5]=s,v[9]=r,v[13]=a,v[2]=h,v[6]=c,v[10]=u,v[14]=l,v[3]=y,v[7]=f,v[11]=d,v[15]=_,this}},{key:"identity",value:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}},{key:"clone",value:function(){return(new t).fromArray(this.ele)}},{key:"copy",value:function(t){var e=this.ele,i=t.ele;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}},{key:"copyPosition",value:function(t){var e=this.ele,i=t.ele;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}},{key:"extractBasis",value:function(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}},{key:"makeBasis",value:function(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}},{key:"extractRotation",value:function(t){var e=this.extractRotVec,i=this.ele,n=t.ele,o=1/e.setFromMatrixColumn(t,0).length(),s=1/e.setFromMatrixColumn(t,1).length(),r=1/e.setFromMatrixColumn(t,2).length();return i[0]=n[0]*o,i[1]=n[1]*o,i[2]=n[2]*o,i[4]=n[4]*s,i[5]=n[5]*s,i[6]=n[6]*s,i[8]=n[8]*r,i[9]=n[9]*r,i[10]=n[10]*r,this}},{key:"makeRotationFromEuler",value:function(t){var e=this.ele,i=t.x,n=t.y,o=t.z,s=Math.cos(i),r=Math.sin(i),a=Math.cos(n),h=Math.sin(n),c=Math.cos(o),u=Math.sin(o);if("XYZ"===t.order){var l=s*c,y=s*u,f=r*c,d=r*u;e[0]=a*c,e[4]=-a*u,e[8]=h,e[1]=y+f*h,e[5]=l-d*h,e[9]=-r*a,e[2]=d-l*h,e[6]=f+y*h,e[10]=s*a}else if("YXZ"===t.order){var _=a*c,v=a*u,p=h*c,x=h*u;e[0]=_+x*r,e[4]=p*r-v,e[8]=s*h,e[1]=s*u,e[5]=s*c,e[9]=-r,e[2]=v*r-p,e[6]=x+_*r,e[10]=s*a}else if("ZXY"===t.order){var _=a*c,v=a*u,p=h*c,x=h*u;e[0]=_-x*r,e[4]=-s*u,e[8]=p+v*r,e[1]=v+p*r,e[5]=s*c,e[9]=x-_*r,e[2]=-s*h,e[6]=r,e[10]=s*a}else if("ZYX"===t.order){var l=s*c,y=s*u,f=r*c,d=r*u;e[0]=a*c,e[4]=f*h-y,e[8]=l*h+d,e[1]=a*u,e[5]=d*h+l,e[9]=y*h-f,e[2]=-h,e[6]=r*a,e[10]=s*a}else if("YZX"===t.order){var m=s*a,g=s*h,k=r*a,b=r*h;e[0]=a*c,e[4]=b-m*u,e[8]=k*u+g,e[1]=u,e[5]=s*c,e[9]=-r*c,e[2]=-h*c,e[6]=g*u+k,e[10]=m-b*u}else if("XZY"===t.order){var m=s*a,g=s*h,k=r*a,b=r*h;e[0]=a*c,e[4]=-u,e[8]=h*c,e[1]=m*u+b,e[5]=s*c,e[9]=g*u-k,e[2]=k*u-g,e[6]=r*c,e[10]=b*u+m}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}},{key:"makeRotationFromQuaternion",value:function(t){var e=this.ele,i=t._x,n=t._y,o=t._z,s=t._w,r=i+i,a=n+n,h=o+o,c=i*r,u=i*a,l=i*h,y=n*a,f=n*h,d=o*h,_=s*r,v=s*a,p=s*h;return e[0]=1-(y+d),e[4]=u-p,e[8]=l+v,e[1]=u+p,e[5]=1-(c+d),e[9]=f-_,e[2]=l-v,e[6]=f+_,e[10]=1-(c+y),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}},{key:"lookAt",value:function(t,e,i){var n=this.ele,o=this.lookVecX,s=this.lookVecY,r=this.lookVecZ;return r.subVectors(t,e),0===r.lengthSq()&&(r.z=1),r.normalize(),o.crossVectors(i,r),0===o.lengthSq()&&(1===Math.abs(i.z)?r.x+=1e-4:r.z+=1e-4,r.normalize(),o.crossVectors(i,r)),o.normalize(),s.crossVectors(r,o),n[0]=o.x,n[4]=s.x,n[8]=r.x,n[1]=o.y,n[5]=s.y,n[9]=r.y,n[2]=o.z,n[6]=s.z,n[10]=r.z,this}},{key:"multiply",value:function(t,e){return null!=e?this.multiplyMatrices(t,e):this.multiplyMatrices(this,t)}},{key:"premultiply",value:function(t){return this.multiplyMatrices(t,this)}},{key:"multiplyMatrices",value:function(t,e){var i=t.ele,n=e.ele,o=this.ele,s=i[0],r=i[4],a=i[8],h=i[12],c=i[1],u=i[5],l=i[9],y=i[13],f=i[2],d=i[6],_=i[10],v=i[14],p=i[3],x=i[7],m=i[11],g=i[15],k=n[0],b=n[4],S=n[8],w=n[12],C=n[1],T=n[5],O=n[9],z=n[13],I=n[2],R=n[6],P=n[10],M=n[14],L=n[3],A=n[7],E=n[11],F=n[15];return o[0]=s*k+r*C+a*I+h*L,o[4]=s*b+r*T+a*R+h*A,o[8]=s*S+r*O+a*P+h*E,o[12]=s*w+r*z+a*M+h*F,o[1]=c*k+u*C+l*I+y*L,o[5]=c*b+u*T+l*R+y*A,o[9]=c*S+u*O+l*P+y*E,o[13]=c*w+u*z+l*M+y*F,o[2]=f*k+d*C+_*I+v*L,o[6]=f*b+d*T+_*R+v*A,o[10]=f*S+d*O+_*P+v*E,o[14]=f*w+d*z+_*M+v*F,o[3]=p*k+x*C+m*I+g*L,o[7]=p*b+x*T+m*R+g*A,o[11]=p*S+x*O+m*P+g*E,o[15]=p*w+x*z+m*M+g*F,this}},{key:"multiplyScalar",value:function(t){var e=this.ele;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}},{key:"applyToBufferAttribute",value:function(t){for(var e=this.vecApplyBuff,i=0,n=t.count;i<n;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix4(this),t.setXYZ(i,e.x,e.y,e.z);return t}},{key:"determinant",value:function(){var t=this.ele,e=t[0],i=t[4],n=t[8],o=t[12],s=t[1],r=t[5],a=t[9],h=t[13],c=t[2],u=t[6],l=t[10],y=t[14];return t[3]*(+o*a*u-n*h*u-o*r*l+i*h*l+n*r*y-i*a*y)+t[7]*(+e*a*y-e*h*l+o*s*l-n*s*y+n*h*c-o*a*c)+t[11]*(+e*h*u-e*r*y-o*s*u+i*s*y+o*r*c-i*h*c)+t[15]*(-n*r*c-e*a*u+e*r*l+n*s*u-i*s*l+i*a*c)}},{key:"transpose",value:function(){var t,e=this.ele;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}},{key:"setPosition",value:function(t){var e=this.ele;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this}},{key:"getInverse",value:function(t,e){var i=this.ele,n=t.ele,o=n[0],s=n[1],r=n[2],a=n[3],h=n[4],c=n[5],u=n[6],l=n[7],y=n[8],f=n[9],d=n[10],_=n[11],v=n[12],p=n[13],x=n[14],m=n[15],g=f*x*l-p*d*l+p*u*_-c*x*_-f*u*m+c*d*m,k=v*d*l-y*x*l-v*u*_+h*x*_+y*u*m-h*d*m,b=y*p*l-v*f*l+v*c*_-h*p*_-y*c*m+h*f*m,S=v*f*u-y*p*u-v*c*d+h*p*d+y*c*x-h*f*x,w=o*g+s*k+r*b+a*S;if(0===w){var C="Matrix4 .getInverse() can't invert matrix, determinant is 0";if(!0===e)throw new Error(C);return console.warn(C),this.identity()}var T=1/w;return i[0]=g*T,i[1]=(p*d*a-f*x*a-p*r*_+s*x*_+f*r*m-s*d*m)*T,i[2]=(c*x*a-p*u*a+p*r*l-s*x*l-c*r*m+s*u*m)*T,i[3]=(f*u*a-c*d*a-f*r*l+s*d*l+c*r*_-s*u*_)*T,i[4]=k*T,i[5]=(y*x*a-v*d*a+v*r*_-o*x*_-y*r*m+o*d*m)*T,i[6]=(v*u*a-h*x*a-v*r*l+o*x*l+h*r*m-o*u*m)*T,i[7]=(h*d*a-y*u*a+y*r*l-o*d*l-h*r*_+o*u*_)*T,i[8]=b*T,i[9]=(v*f*a-y*p*a-v*s*_+o*p*_+y*s*m-o*f*m)*T,i[10]=(h*p*a-v*c*a+v*s*l-o*p*l-h*s*m+o*c*m)*T,i[11]=(y*c*a-h*f*a-y*s*l+o*f*l+h*s*_-o*c*_)*T,i[12]=S*T,i[13]=(y*p*r-v*f*r+v*s*d-o*p*d-y*s*x+o*f*x)*T,i[14]=(v*c*r-h*p*r-v*s*u+o*p*u+h*s*x-o*c*x)*T,i[15]=(h*f*r-y*c*r+y*s*u-o*f*u-h*s*d+o*c*d)*T,this}},{key:"scale",value:function(t){var e=this.ele,i=t.x,n=t.y,o=t.z;return e[0]*=i,e[4]*=n,e[8]*=o,e[1]*=i,e[5]*=n,e[9]*=o,e[2]*=i,e[6]*=n,e[10]*=o,e[3]*=i,e[7]*=n,e[11]*=o,this}},{key:"getMaxScaleOnAxis",value:function(){var t=this.ele,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,n))}},{key:"makeTranslation",value:function(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}},{key:"makeRotationX",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}},{key:"makeRotationY",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}},{key:"makeRotationZ",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}},{key:"makeRotationAxis",value:function(t,e){var i=Math.cos(e),n=Math.sin(e),o=1-i,s=t.x,r=t.y,a=t.z,h=o*s,c=o*r;return this.set(h*s+i,h*r-n*a,h*a+n*r,0,h*r+n*a,c*r+i,c*a-n*s,0,h*a-n*r,c*a+n*s,o*a*a+i,0,0,0,0,1),this}},{key:"makeScale",value:function(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}},{key:"makeShear",value:function(t,e,i){return this.set(1,e,i,0,t,1,i,0,t,e,1,0,0,0,0,1),this}},{key:"compose",value:function(t,e,i){return this.makeRotationFromQuaternion(e),this.scale(i),this.setPosition(t),this}},{key:"makePerspective",value:function(t,e,i,n,o,s){var r=this.ele,a=2*o/(e-t),h=2*o/(i-n),c=(e+t)/(e-t),u=(i+n)/(i-n),l=-(s+o)/(s-o),y=-2*s*o/(s-o);return r[0]=a,r[4]=0,r[8]=c,r[12]=0,r[1]=0,r[5]=h,r[9]=u,r[13]=0,r[2]=0,r[6]=0,r[10]=l,r[14]=y,r[3]=0,r[7]=0,r[11]=-1,r[15]=0,this}},{key:"makeOrthographic",value:function(t,e,i,n,o,s){var r=this.ele,a=1/(e-t),h=1/(i-n),c=1/(s-o),u=(e+t)*a,l=(i+n)*h,y=(s+o)*c;return r[0]=2*a,r[4]=0,r[8]=0,r[12]=-u,r[1]=0,r[5]=2*h,r[9]=0,r[13]=-l,r[2]=0,r[6]=0,r[10]=-2*c,r[14]=-y,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this}},{key:"equals",value:function(t){for(var e=this.ele,i=t.ele,n=0;n<16;n++)if(e[n]!==i[n])return!1;return!0}},{key:"fromArray",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<16;i++)this.ele[i]=t[i+e];return this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this.ele;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}]),t}(),m=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;n(this,t),this._x=e,this._y=i,this._z=o,this._w=s,this.UnitVec3=new p,this.EPS=1e-6}return o(t,[{key:"clone",value:function(){return new this.constructor(this._x,this._y,this._z,this._w)}},{key:"set",value:function(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this.onChangeCallback(),this}},{key:"copy",value:function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this.onChangeCallback(),this}},{key:"inverse",value:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this}},{key:"dot",value:function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}},{key:"slerp",value:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this._x,n=this._y,o=this._z,s=this._w,r=s*t._w+i*t._x+n*t._y+o*t._z;if(r<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,r=-r):this.copy(t),r>=1)return this._w=s,this._x=i,this._y=n,this._z=o,this;var a=Math.sqrt(1-r*r);if(Math.abs(a)<.001)return this._w=.5*(s+this._w),this._x=.5*(i+this._x),this._y=.5*(n+this._y),this._z=.5*(o+this._z),this;var h=Math.atan2(a,r),c=Math.sin((1-e)*h)/a,u=Math.sin(e*h)/a;return this._w=s*c+this._w*u,this._x=i*c+this._x*u,this._y=n*c+this._y*u,this._z=o*c+this._z*u,this.onChangeCallback(),this}},{key:"setFromEuler",value:function(t,e){var i=t._x,n=t._y,o=t._z,s=t.order,r=Math.cos,a=Math.sin,h=r(i/2),c=r(n/2),u=r(o/2),l=a(i/2),y=a(n/2),f=a(o/2);return"XYZ"===s?(this._x=l*c*u+h*y*f,this._y=h*y*u-l*c*f,this._z=h*c*f+l*y*u,this._w=h*c*u-l*y*f):"YXZ"===s?(this._x=l*c*u+h*y*f,this._y=h*y*u-l*c*f,this._z=h*c*f-l*y*u,this._w=h*c*u+l*y*f):"ZXY"===s?(this._x=l*c*u-h*y*f,this._y=h*y*u+l*c*f,this._z=h*c*f+l*y*u,this._w=h*c*u-l*y*f):"ZYX"===s?(this._x=l*c*u-h*y*f,this._y=h*y*u+l*c*f,this._z=h*c*f-l*y*u,this._w=h*c*u+l*y*f):"YZX"===s?(this._x=l*c*u+h*y*f,this._y=h*y*u+l*c*f,this._z=h*c*f-l*y*u,this._w=h*c*u-l*y*f):"XZY"===s&&(this._x=l*c*u-h*y*f,this._y=h*y*u-l*c*f,this._z=h*c*f+l*y*u,this._w=h*c*u+l*y*f),!1!==e&&this.onChangeCallback(),this}},{key:"setFromAxisAngle",value:function(t,e){var i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this.onChangeCallback(),this}},{key:"setFromRotationMatrix",value:function(t){var e,i=t.elements,n=i[0],o=i[4],s=i[8],r=i[1],a=i[5],h=i[9],c=i[2],u=i[6],l=i[10],y=n+a+l;return y>0?(e=.5/Math.sqrt(y+1),this._w=.25/e,this._x=(u-h)*e,this._y=(s-c)*e,this._z=(r-o)*e):n>a&&n>l?(e=2*Math.sqrt(1+n-a-l),this._w=(u-h)/e,this._x=.25*e,this._y=(o+r)/e,this._z=(s+c)/e):a>l?(e=2*Math.sqrt(1+a-n-l),this._w=(s-c)/e,this._x=(o+r)/e,this._y=.25*e,this._z=(h+u)/e):(e=2*Math.sqrt(1+l-n-a),this._w=(r-o)/e,this._x=(s+c)/e,this._y=(h+u)/e,this._z=.25*e),this.onChangeCallback(),this}},{key:"setFromUnitVectors",value:function(t,e){var i=this.UnitVec3;return this.r=t.dot(e)+1,this.r<this.EPS?(this.r=0,Math.abs(t.x)>Math.abs(t.z)?i.set(-t.y,t.x,0):i.set(0,-t.z,t.y)):i.crossVectors(t,e),this._x=i.x,this._y=i.y,this._z=i.z,this._w=this.r,this.normalize()}},{key:"lengthSq",value:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}},{key:"length",value:function(){return Math.sqrt(this.lengthSq())}},{key:"normalize",value:function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this.onChangeCallback(),this}},{key:"multiply",value:function(t,e){return void 0!==e?this.multiplyQuaternions(t,e):this.multiplyQuaternions(this,t)}},{key:"premultiply",value:function(t){return this.multiplyQuaternions(t,this)}},{key:"multiplyQuaternions",value:function(t,e){var i=t._x,n=t._y,o=t._z,s=t._w,r=e._x,a=e._y,h=e._z,c=e._w;return this._x=i*c+s*r+n*h-o*a,this._y=n*c+s*a+o*r-i*h,this._z=o*c+s*h+i*a-n*r,this._w=s*c-i*r-n*a-o*h,this.onChangeCallback(),this}},{key:"equals",value:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this.onChangeCallback(),this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}},{key:"onChange",value:function(t){return this.onChangeCallback=t,this}},{key:"onChangeCallback",value:function(){}}]),t}(),g=function(){function t(){n(this,t),this.type="Camera",this.isCamera=!0,this.matrixWorldInverse=new x,this.projectionMatrix=new x,this.quat=new m}return o(t,[{key:"copy",value:function(e,i){return s(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"copy",this).call(this,this,e,i),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"getWorldDirection",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new p,e=this.quat;return this.getWorldQuaternion(e),t.set(0,0,-1).applyQuaternion(e)}},{key:"updateMatrixWorld",value:function(e){s(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateMatrixWorld",this).call(this,e),this.matrixWorldInverse.getInverse(this.matrixWorld)}}]),t}(),k=function(){function t(e){n(this,t),this.gl=e}return o(t,[{key:"Remove",value:function(t){}},{key:"Add",value:function(t){t instanceof g&&console.log("camera")}},{key:"Start",value:function(){}},{key:"Update",value:function(){}},{key:"Render",value:function(){}},{key:"Stop",value:function(){}},{key:"Resize",value:function(t){}}]),t}(),b=function(){function t(){n(this,t),this.activeFPS=!1,this.activeUpdateLoop=!1,this.activeRenderLoop=!1,this.useUpdateLoop=!0,this.useRenderLoop=!0}return o(t,[{key:"useUpdate",value:function(t){this.useUpdateLoop=t}},{key:"useRender",value:function(t){this.useRenderLoop=t}},{key:"Start",value:function(){var t=this;this.activeFPS=!0,this.lastUpdate=Date.now(),this.d=0,!0===this.useUpdateLoop&&(this._Updateloop=setInterval(function(){t._UpdateLoop()},40)),!0===this.useRenderLoop&&function e(){requestAnimationFrame(e),t.activeFPS&&t._RenderLoop()}()}},{key:"Resume",value:function(){!0===this.useUpdateLoop&&(this.activeUpdateLoop=!0),!0===this.useRenderLoop&&(this.activeRenderLoop=!0)}},{key:"Pause",value:function(){!0===this.useUpdateLoop&&(this.activeUpdateLoop=!1),!0===this.useRenderLoop&&(this.activeRenderLoop=!1)}},{key:"Stop",value:function(){this.activeFPS=!1,!0===this.useUpdateLoop&&clearInterval(this._Updateloop)}},{key:"_UpdateLoop",value:function(){if(this.activeUpdateLoop){var t=Date.now(),e=t-this.lastUpdate;this.lastUpdate=t,this.Update(this.d,e),this.d+=e}}},{key:"_RenderLoop",value:function(){this.activeRenderLoop&&this.Render()}},{key:"Update",value:function(){}},{key:"Render",value:function(){}}]),t}(),S=function(t){function e(t){var i=t.id,o=t.canvas,s=void 0===o?null:o;n(this,e);var r=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r._currScene=null,r.id=i,r.ctx=r._WebGLContext(s),r}return r(e,t),o(e,[{key:"_WebGLContext",value:function(t){this.canvas=t;var e=null;if(null==this.canvas)return console.log("No canvas"),null;for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],n=0;n<i.length;++n){try{e=this.canvas.getContext(i[n])}catch(t){}if(e)break}return null==e?(console.log("WebGL Initializing Fail"),null):e}},{key:"Start",value:function(){if(null==this._currScene)return void console.log("Scene is Empty!");s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Start",this).call(this),this._currScene.Start()}},{key:"Update",value:function(){this._currScene.Update()}},{key:"Render",value:function(){this._currScene.Render()}},{key:"Stop",value:function(){this._currScene.Stop(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Stop",this).call(this)}},{key:"Resize",value:function(t){this._currScene.Resize(t)}},{key:"scene",get:function(){return this._currScene},set:function(t){this.Pause(),null==t?null!=this._currScene&&this._currScene.Stop():this._currScene=new t(this.ctx),this.Resume()}}]),e}(b),w=function(t){function e(t){var i=t.id,o=t.canvas,s=void 0===o?null:o;n(this,e);var r=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r._currScene=null,r.id=i,r.ctx=r._GetContext(s),r.EventStore=new d(r),r}return r(e,t),o(e,[{key:"_GetContext",value:function(t){this.canvas=t;var e=null;if(null==this.canvas)return console.log("No canvas"),null;try{e=this.canvas.getContext("2d")}catch(t){}return null==e?(console.log("Canvas Initializing Fail"),null):e}},{key:"Start",value:function(){if(null==this._currScene)return void console.log("Scene is Empty!");s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Start",this).call(this),this._currScene.Start()}},{key:"Update",value:function(){this._currScene.Update()}},{key:"Render",value:function(t,e){this._currScene.Render(t,e)}},{key:"Stop",value:function(){this._currScene.Stop(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Stop",this).call(this)}},{key:"Resize",value:function(t){this._currScene.Resize(t)}},{key:"RemoveAll",value:function(){this.scene.RemoveAll()}},{key:"scene",get:function(){return this._currScene},set:function(t){null==t?null!=this._currScene&&this._currScene.Stop():this._currScene=new t(this.ctx)}}]),e}(b),C=function(t){function e(t,i){var o=t.id,s=t.canvas,r=void 0===s?null:s;n(this,e);var h=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,{id:o,canvas:r}));return h._currScene=null,h.id=o,h.ctx=h._GetContext(r),h.EventStore=new d(h),y.Add(h.id,{type:"OBJECT",target:h}),h}return r(e,t),o(e,[{key:"_GetContext",value:function(t){this.canvas=t;var e=null;if(null==this.canvas)return console.log("No canvas"),null;try{e=this.canvas.getContext("2d")}catch(t){}return null==e?(console.log("Canvas Initializing Fail"),null):e}},{key:"Start",value:function(){if(null==this._currScene)return void console.log("Scene is Empty!");s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Start",this).call(this),this._currScene.Start()}},{key:"Update",value:function(){this._currScene.Update()}},{key:"Render",value:function(t,e){this._currScene.Render(t,e)}},{key:"Stop",value:function(){this._currScene.Stop(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Stop",this).call(this)}},{key:"Resize",value:function(t){this._currScene.Resize(t)}},{key:"RemoveAll",value:function(){this.scene.RemoveAll()}},{key:"scene",get:function(){return this._currScene},set:function(t){null==t?null!=this._currScene&&this._currScene.Stop():this._currScene=new t(this.ctx)}}]),e}(w),T=function(t){function e(t){n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));i.useRender(!1),i.SOCKET_LIST={};var o=i;return t.sockets.on("connection",function(t){t.id=Math.random(),o.SOCKET_LIST[t.id]=t,o.ConnectSocket(t)?console.log("socket connection : "+t.id):console.log("socket disconnected : "+t.id),t.on("disconnect",function(){o.DisConnectSocket(t)})}),i}return r(e,t),o(e,[{key:"Init",value:function(t){}},{key:"Destroy",value:function(t){}},{key:"ConnectSocket",value:function(t){return this.Init(t),!0}},{key:"DisConnectSocket",value:function(t){this.Destroy(t),delete this.SOCKET_LIST[t.id]}},{key:"Update",value:function(t,e){var i={player:[],bullet:[]};for(var n in this.ITEM_LIST)!0!==this.ITEM_LIST[n].REMOVE?i.player.push(this.ITEM_LIST[n].Update()):delete this.ITEM_LIST[n];for(var n in this.BULLET_LIST)!0!==this.BULLET_LIST[n].REMOVE?i.bullet.push(this.BULLET_LIST[n].Update()):delete this.BULLET_LIST[n];for(var n in this.SOCKET_LIST)this.SOCKET_LIST[n].emit("newPosition",i)}}]),e}(b),O=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new f(0,0),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new f(0,0);n(this,t),this.min=e,this.max=i}return o(t,[{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"set",value:function(t,e){return this.min.copy(t),this.max.copy(e),this}},{key:"setFromXYWH",value:function(t){this.min.x=t.x,this.min.y=t.y,this.max.x=t.width+t.x,this.max.y=t.height+t.y}},{key:"setFromPoints",value:function(t){for(var e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}},{key:"isEmpty",value:function(){return this.max.x<this.min.x||this.max.y<this.min.y}},{key:"setCenter",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new f(0,0),e=this.getCenter(),i=e.subVectors(t,e);this.translate(i)}},{key:"getCenter",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new f(0,0)).addVectors(this.min,this.max).multiplyScalar(.5)}},{key:"getSize",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new f(0,0)).subVectors(this.max,this.min)}},{key:"setSize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new f(0,0);return this.max.x=this.min.x+t.x,this.max.y=this.min.y+t.y,this}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"expandByVector",value:function(t){return this.min.sub(t),this.max.add(t),this}},{key:"expandByScalar",value:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this}},{key:"containsPoint",value:function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)}},{key:"containsBox",value:function(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}},{key:"clampPoint",value:function(t){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:new f).copy(t).clamp(this.min,this.max)}},{key:"intersect",value:function(t){return this.min.max(t.min),this.max.min(t.max),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"translate",value:function(t){return this.min.add(t),this.max.add(t),this}},{key:"reconstruct",value:function(){var t=this.min.x,e=this.min.y,i=this.max.x,n=this.max.y;this.min.x=Math.min(t,i),this.min.y=Math.min(e,n),this.max.x=Math.max(t,i),this.max.y=Math.max(e,n)}},{key:"equals",value:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}]),t}(),z=function(){function t(e,i){n(this,t),i=i||{},this.id=i.id||Math.random(),this.ctx=e,this._position=new f(i.x,i.y),this.distance=i.distance||1e3,this._viewport=new O,this._viewport.setFromXYWH({x:0,y:0,width:0,height:0}),this._viewport.scale={x:1,y:1},this.flustrum=[100,5e3],this.fieldOfView=Math.tan(Math.PI/4).toFixed(6),this.eventStore={mousemove:function(t,e){this.OffsetMoveTo(-e.cameraOffset.x,-e.cameraOffset.y)},mousewheel:function(t,e){e.delta>0?this.OffsetZoomTo(-100):this.OffsetZoomTo(100)}},this.UpdateCamera()}return o(t,[{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"GetCenter",value:function(){return this._position}},{key:"RenderStart",value:function(){this.ctx.save(),this.ctx.scale(this._viewport.scale.x,this._viewport.scale.y),this.ctx.translate(-this._viewport.min.x,-this._viewport.min.y)}},{key:"RenderEnd",value:function(){this.ctx.restore()}},{key:"UpdateCamera",value:function(){this.cvsWidth=this.ctx.canvas.width,this.cvsHeight=this.ctx.canvas.height,this.setViewportFromSize(this.cvsWidth,this.cvsHeight)}},{key:"setViewportFromSize",value:function(t,e){var i=t/e,n=this.distance*this.fieldOfView,o=n/i;this._viewport.scale.x=t/n,this._viewport.scale.y=e/o,this._viewport.min.x=this._position.x-n/2,this._viewport.min.y=this._position.y-o/2,this._viewport.max.x=this._viewport.min.x+n,this._viewport.max.y=this._viewport.min.y+o}},{key:"GetScale",value:function(){return{x:this._viewport.scale.x,y:this._viewport.scale.y}}},{key:"SetDistanceFromScale",value:function(t){this.distance=this.cvsWidth/(t*this.fieldOfView),this.UpdateCamera()}},{key:"SetDistanceFromWidth",value:function(t){this.distance=t,this.UpdateCamera()}},{key:"ZoomTo",value:function(t){this.distance=t,this.flustrum[0]>this.distance&&(this.distance=this.flustrum[0]),this.flustrum[1]<this.distance&&(this.distance=this.flustrum[1]),this.UpdateCamera()}},{key:"OffsetZoomTo",value:function(t){this.distance+=t,this.flustrum[0]>this.distance&&(this.distance=this.flustrum[0]),this.flustrum[1]<this.distance&&(this.distance=this.flustrum[1]),this.UpdateCamera()}},{key:"MoveTo",value:function(t,e){this._position.x=t,this._position.y=e,this.UpdateCamera()}},{key:"OffsetMoveTo",value:function(t,e){this._position.x+=t,this._position.y+=e,this.UpdateCamera()}},{key:"ScreenToWorld",value:function(t,e){var i=this.ctx.canvas.getBoundingClientRect(),n={x:t-i.left,y:e-i.top},o={};return o.x=n.x/this._viewport.scale.x+this._viewport.min.x,o.y=n.y/this._viewport.scale.y+this._viewport.min.y,o}},{key:"WorldToScreen",value:function(t,e){var i={};i.x=(t-this._viewport.min.x)*this._viewport.scale.x,i.y=(e-this._viewport.min.y)*this._viewport.scale.y;var n=this.ctx.canvas.getBoundingClientRect();return i={x:i.x+n.left,y:i.y+n.top}}},{key:"Update",value:function(){}},{key:"x",set:function(t){this._position.x=t},get:function(){return this._position.x}},{key:"y",set:function(t){this._position.y=t},get:function(){return this._position.y}}]),t}(),I=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,t),this.id=e.id||y.UUID(),this._position=null,this.originalPosition=null,this.attachs={},this.attachObjects={},this.hide=null!=e.hide&&e.hide,this.originalColor=e.color,this.color=e.color,this.lineColor=e.lineColor||"#000000",this.setLineType(e.lineType),this.lineWidth=e.lineWidth||1,this.opacity=e.opacity||1,this._collisionCheck=void 0===e.collisionCheck||e.collisionCheck,this.order=e.order||0,this.scale=e.scale||[1,1],this.originalScale=e.scale||[1,1],this.offset=[0,0]}return o(t,[{key:"Hide",value:function(){this.hide=!0}},{key:"Show",value:function(){this.hide=!1}},{key:"setCollisionCheck",value:function(t){this._collisionCheck=void 0===t||t}},{key:"setColor",value:function(t){this.color=t}},{key:"setLineType",value:function(t){this.lineType="DASH"==t?[15,5]:"DOT"==t?[5,5]:"SOLID"==t?null:t}},{key:"changeScale",value:function(t){this.scale=t}},{key:"setScale",value:function(){var t=this.originalPosition.getSize(),e=this._position.getSize();this.scale[0]=e.x/t.x,this.scale[1]=e.y/t.y}},{key:"Translate",value:function(t){this._position instanceof f?this._position.add(t):this._position instanceof O&&this._position.translate(t),this.executeAttach()}},{key:"Rotate",value:function(){this.executeAttach()}},{key:"Scale",value:function(){this.executeAttach()}},{key:"GetCenter",value:function(){return this._position instanceof f?this._position:this._position instanceof O?this._position.getCenter():new f(0,0)}},{key:"CollisionCheck",value:function(e){if(!0!==this._collisionCheck)return!1;var i=e;if(e instanceof t&&(i=e._position),this._position instanceof f){var n=this._position.clone();if(i instanceof f){var o=n.sub(i).lenSq();if(o<1/0&&o<this.radius*this.radius)return!0}else if(i instanceof O)return i.containsPoint(this._position)}else if(this._position instanceof O){if(i instanceof f)return this._position.containsPoint(i);if(i instanceof O)return this._position.intersectsBox(i)}return!1}},{key:"Destroy",value:function(){delete this._position,delete this.originalPosition}},{key:"Update",value:function(t){}},{key:"Render",value:function(t){t.strokeStyle=this.lineColor,t.lineWidth=this.lineWidth,null!=this.lineType&&t.setLineDash(this.lineType),this.opacity<1&&(t.globalAlpha=this.opacity)}},{key:"SetOffset",value:function(t,e){this.offset=[t,e]}},{key:"Attach",value:function(t,e){void 0===this.attachs[t.id]?this.attachs[t.id]=[e]:this.attachs[t.id].push(e),this.attachObjects[t.id]=t,this.executeAttach()}},{key:"Detach",value:function(t){delete this.attachs[t.id],delete this.attachObjects[t.id]}},{key:"executeAttach",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(var i in this.attachs)if(t!=i){for(var n=this.attachs[i],o=this.attachObjects[i],s=[],r=0;r<n.length;r++){var a=n[r].call(o,e);null!=a&&(s=a instanceof Array?s.concat(a):s.concat([a]))}null==t&&(t=this.id);for(var h in s)s[h].executeAttach(t,e)}}}]),t}(),R=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,t),this.id=e.id||y.UUID(),this.eventStore=void 0,this.hide=!1,this.order=0}return o(t,[{key:"Hide",value:function(){this.hide=!0}},{key:"Show",value:function(){this.hide=!1}},{key:"CollisionCheck",value:function(t){}},{key:"Picker",value:function(t){}},{key:"Update",value:function(t){}},{key:"Render",value:function(t,e){}},{key:"RenderBefore",value:function(t,e){}},{key:"RenderAfter",value:function(t,e){}},{key:"Destroy",value:function(t){}}]),t}(),P=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._position=new O,i._position.setFromXYWH(t),i.originalPosition=new O,i.originalPosition.setFromXYWH(t),i.round=t.round||0,i}return r(e,t),o(e,[{key:"Render",value:function(t){if(!0===this.hide)return!1;t.save(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t);var i=this._position.min,n=this._position.getSize();this.round>0?(this.drawRoundRect(t,i.x,i.y,n.x,n.y),null!=this.color&&(t.fillStyle=this.color,t.fill())):(null!=this.color&&(t.fillStyle=this.color,t.fillRect(i.x,i.y,n.x,n.y)),t.strokeRect(i.x,i.y,n.x,n.y)),t.scale(this.scale[0],this.scale[1]),t.restore()}},{key:"drawEllipse",value:function(t,e,i,n,o){ox=n/2*.5522848,oy=o/2*.5522848,xe=e+n,ye=i+o,xm=e+n/2,ym=i+o/2,t.beginPath(),t.moveTo(e,ym),t.bezierCurveTo(e,ym-oy,xm-ox,i,xm,i),t.bezierCurveTo(xm+ox,i,xe,ym-oy,xe,ym),t.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye),t.bezierCurveTo(xm-ox,ye,e,ym+oy,e,ym),t.closePath(),t.stroke()}},{key:"drawRoundRect",value:function(t,e,i,n,o){var s=n/2*.5,r=o/2*.5;s<r&&(r=s),s>r&&(s=r);var a=e+n,h=i+o;t.beginPath(),t.moveTo(e,i+r),t.quadraticCurveTo(e,i,e+s,i),t.lineTo(a-s,i),t.quadraticCurveTo(a,i,a,i+r),t.lineTo(a,h-r),t.quadraticCurveTo(a,h,a-s,h),t.lineTo(e+s,h),t.quadraticCurveTo(e,h,e,h-r),t.lineTo(e,i+r),t.closePath(),t.stroke()}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),e}(I),M=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._position=new f(t.x,t.y),i.originalPosition=new f(t.x,t.y),i.radius=t.radius||5,i.pointType=t.pointType||"POINT",i.angle=t.angle||0,i}return r(e,t),o(e,[{key:"set",value:function(t,e){this._position=new f(t,e)}},{key:"setAngle",value:function(t,e){this.angle=Math.atan2(e.y-t.y,e.x-t.x)}},{key:"setPointType",value:function(t){"POINT"!=t&&"ARROW"!=t&&"RECT"!=t||(this.pointType=t)}},{key:"Update",value:function(){}},{key:"Render",value:function(t){if(!0!==this.hide){t.save(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),t.beginPath();var i=this._position.x+this.offset[0],n=this._position.y+this.offset[1];if("POINT"==this.pointType)t.arc(i,n,this.radius,0,2*Math.PI,!1);else if("ARROW"==this.pointType){var o=2*this.radius,r=this.angle;t.moveTo(i,n),t.lineTo(i-o*Math.cos(r-Math.PI/6),n-o*Math.sin(r-Math.PI/6)),t.lineTo(i-o*Math.cos(r+Math.PI/6),n-o*Math.sin(r+Math.PI/6)),t.lineTo(i,n)}else if("RECT"==this.pointType){var a=this.radius;null!=this.color&&(t.fillStyle=this.color,t.fillRect(i-a,n-a,2*a,2*a)),t.strokeRect(i-a,n-a,2*a,2*a)}t.stroke(),t.closePath(),null!=this.color&&(t.fillStyle=this.color,t.fill()),t.restore()}}},{key:"x",set:function(t){this._position.x=t},get:function(){return this._position.x}},{key:"y",set:function(t){this._position.y=t},get:function(){return this._position.y}}]),e}(I),L=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.dataSource=t.dataSource,i.image=y.Load(i.dataSource),""!==i.image&&(null==t.width&&(t.width=i.image.width),null==t.height&&(t.height=i.image.height)),i._position=new O,i._position.setFromXYWH(t),i.originalPosition=new O,i.originalPosition.setFromXYWH(t),i.isDynamic=null!=t.isDynamic&&t.isDynamic,i}return r(e,t),o(e,[{key:"resetImage",value:function(t){null!=t&&(this.dataSource=t),this.image=y.Load(this.dataSource),this.originalPosition.setSize({x:this.image.width,y:this.image.height}),this.setScale()}},{key:"Destroy",value:function(){s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),!0===this.isDynamic&&y.Remove(this.dataSource)}},{key:"Render",value:function(t){if(!0===this.hide)return!1;if(null===this.image)return!1;t.save(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t);var i=this._position.min,n=this._position.getSize();""===this.image&&this.resetImage(),""!==this.image&&t.drawImage(this.image,i.x,i.y,n.x,n.y),t.scale(this.scale[0],this.scale[1]),t.restore()}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),e}(I),A=function(){function t(e){n(this,t),this.id=Math.random(),this.stage=e,this.ctx=e.ctx,this.width=e.canvas.width,this.height=e.canvas.height,this.camera=null,this.EventStore=e.EventStore,this.Items={},this.Units={},this._orderedItems=[],this._orderedUnits=[],this.renderBefore=!1,this.renderAfter=!1}return o(t,[{key:"getOrderdUnits",value:function(){return this._orderedUnits}},{key:"_World",value:function(t){}},{key:"RemoveAll",value:function(){for(var t in this.Items)this.Remove(t)}},{key:"Remove",value:function(t){var e=this.Items[t];if(null!=e){if(e instanceof R)for(var i in e){var n=e[i];n instanceof I&&(this.Units[n.id].Destroy(this.stage),delete this.Units[n.id],void 0!==n.eventStore&&this.EventStore.Remove(n.id))}else e instanceof I&&(this.Units[t].Destroy(this.stage),delete this.Units[t],this.EventStore.Remove(t));this.Items[t].Destroy(),delete this.Items[t]}this.resetOrder()}},{key:"resetOrder",value:function(){this._orderedItems=this._makeOrderedArray(this.Items,!0),this._orderedUnits=this._makeOrderedArray(this.Units)}},{key:"setItemOrder",value:function(t,e){var n=[];"object"==(void 0===e?"undefined":i(e))?n=this.searchItems(e):"string"==typeof e?null!=this.Items[e]&&n.push(this.Items[e]):n=this._orderedItems;for(var o in n)n[o].order=t}},{key:"Add",value:function(t){if(t instanceof z)this.camera=t,void 0!==t.eventStore&&this.EventStore.Add(t,t.eventStore);else if(t instanceof I)this.Items[t.id]=t,this.Units[t.id]=t,void 0!==t.eventStore&&this.EventStore.Add(t,t.eventStore);else if(t instanceof R){this.Items[t.id]=t;for(var e in t){var i=t[e];i instanceof I&&(this.Units[i.id]=i,void 0!==i.eventStore&&this.EventStore.Add(i,i.eventStore,t.id))}}return this.resetOrder(),t.id}},{key:"searchItems",value:function(t){var e=[];for(var i in this.Items){var n=this.Items[i];for(var o in t)if(n[o]===t[o]){e.push(n);break}}return e}},{key:"searchInstance",value:function(t){var e=[];for(var i in this.Items){var n=this.Items[i];n instanceof t&&e.push(n)}return e}},{key:"getItem",value:function(t){return this.Items[t]}},{key:"getUnit",value:function(t){return this.Units[t]}},{key:"_makeOrderedArray",value:function(t,e){var i=new Array,n=new Array;for(var o in t){var s=t[o];null==n[Number(s.order)]?n[Number(s.order)]=[s]:n[Number(s.order)].push(s)}for(var r=0;r<n.length;++r){var a=n[r];if(a instanceof Array)for(var h=0;h<a.length;++h){var c=a[h];!0===e?i.push(c):i.unshift(c)}}return i}},{key:"Start",value:function(){}},{key:"Update",value:function(){for(var t in this.Items)this.Items[t].Update(this.ctx)}},{key:"Render",value:function(){if(this.ctx.clearRect(0,0,this.width,this.height),null!=this.camera&&this.camera.RenderStart(),!0===this.renderBefore)for(var t in this._orderedItems){var e=this._orderedItems[t];if(1!=e.hide)try{e.RenderBefore(this.ctx,this.camera)}catch(t){}}for(var i in this._orderedItems){var n=this._orderedItems[i];1!=n.hide&&n.Render(this.ctx,this.camera)}if(!0===this.renderAfter)for(var o in this._orderedItems){var s=this._orderedItems[o];if(1!=s.hide)try{s.RenderAfter(this.ctx,this.camera)}catch(t){}}null!=this.camera&&this.camera.RenderEnd()}},{key:"Stop",value:function(){}},{key:"Resize",value:function(t){this.width=this.stage.canvas.width,this.height=this.stage.canvas.height,null!=this.camera&&this.camera.UpdateCamera()}}]),t}(),E=function(){function t(){n(this,t),this.ARG_LENGTH={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0}}return o(t,[{key:"_parseValues",value:function(t){var e=t.match(/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/gi);return e?e.map(Number):[]}},{key:"Parse",value:function(t){var e=this,i=[],n=String(t).trim();return"M"!==n[0]&&"m"!==n[0]?i:(n.replace(/([astvzqmhlc])([^astvzqmhlc]*)/gi,function(t,n,o){var s=n.toLowerCase(),r=e._parseValues(o),a=n;if("m"===s&&r.length>2&&(i.push([a].concat(r.splice(0,2))),s="l",a="m"===a?"l":"L"),r.length<e.ARG_LENGTH[s])return"";for(i.push([a].concat(r.splice(0,e.ARG_LENGTH[s])));r.length>=e.ARG_LENGTH[s]&&r.length&&e.ARG_LENGTH[s];)i.push([a].concat(r.splice(0,e.ARG_LENGTH[s])));return""}),i)}}]),t}(),F=function(){function t(e){n(this,t),this.segments=[];var i=new E;this.segments=i.Parse(e)}return o(t,[{key:"Render",value:function(t){this.buildPath(t,this.segments)}},{key:"_rotatePoint",value:function(t,e){var i=t.x*Math.cos(e)-t.y*Math.sin(e),n=t.y*Math.cos(e)+t.x*Math.sin(e);t.x=i,t.y=n}},{key:"_translatePoint",value:function(t,e,i){t.x+=e,t.y+=i}},{key:"_scalePoint",value:function(t,e){t.x*=e,t.y*=e}},{key:"moveTo",value:function(t,e){this.segments.push(["M",t,e])}},{key:"lineTo",value:function(t,e){this.segments.push(["L",t,e])}},{key:"arc",value:function(t,e,i,n,o,s){this.segments.push(["AC",t,e,i,n,o,!!s])}},{key:"arcTo",value:function(t,e,i,n,o){this.segments.push(["AT",t,e,i,n,o])}},{key:"ellipse",value:function(t,e,i,n,o,s,r,a){this.segments.push(["E",t,e,i,n,o,s,r,!!a])}},{key:"closePath",value:function(){this.segments.push(["Z"])}},{key:"bezierCurveTo",value:function(t,e,i,n,o,s){this.segments.push(["C",t,e,i,n,o,s])}},{key:"quadraticCurveTo",value:function(t,e,i,n){this.segments.push(["Q",t,e,i,n])}},{key:"rect",value:function(t,e,i,n){this.segments.push(["R",t,e,i,n])}},{key:"buildPath",value:function(t,e){var i=void 0,n=void 0,o=void 0,s=void 0,r=void 0,a=void 0,h=void 0,c=void 0,u=void 0,l=void 0,y=void 0,f=void 0,d=void 0,_=void 0,v=void 0,p=void 0,x=void 0,m=void 0,g=void 0,k=void 0,b=void 0,S=void 0,w=void 0,C=void 0,T=void 0,O=void 0,z={x:0,y:0},I={x:0,y:0};t.beginPath();for(var R=0;R<e.length;++R){var P=e[R];"S"!==(k=P[0])&&"s"!==k&&"C"!==k&&"c"!==k&&(S=null,w=null),"T"!==k&&"t"!==k&&"Q"!==k&&"q"!==k&&(C=null,T=null),"M"==k||"m"==k?("m"===k?(y+=P[1],d+=P[2]):(y=P[1],d=P[2]),"M"!==k&&z||(z={x:y,y:d}),t.moveTo(y,d)):"l"==k?(y+=P[1],d+=P[2],t.lineTo(y,d)):"L"==k?(y=P[1],d=P[2],t.lineTo(y,d)):"h"==k?(y+=P[1],t.lineTo(y,d)):"H"==k?(y=P[1],t.lineTo(y,d)):"v"==k?(d+=P[1],t.lineTo(y,d)):"V"==k?(d=P[1],t.lineTo(y,d)):"A"==k||"a"==k?("a"===k?(y+=P[6],d+=P[7]):(y=P[6],d=P[7]),p=P[1],x=P[2],h=P[3]*Math.PI/180,o=!!P[4],s=!!P[5],r={x:y,y:d},a={x:(I.x-r.x)/2,y:(I.y-r.y)/2},this._rotatePoint(a,-h),(c=a.x*a.x/(p*p)+a.y*a.y/(x*x))>1&&(p*=c=Math.sqrt(c),x*=c),b={x:p*a.y/x,y:-x*a.x/p},u=p*p*x*x,l=p*p*a.y*a.y+x*x*a.x*a.x,s!==o?this._scalePoint(b,Math.sqrt((u-l)/l)||0):this._scalePoint(b,-Math.sqrt((u-l)/l)||0),n=Math.atan2((a.y-b.y)/x,(a.x-b.x)/p),i=Math.atan2(-(a.y+b.y)/x,-(a.x+b.x)/p),this._rotatePoint(b,h),this._translatePoint(b,(r.x+I.x)/2,(r.y+I.y)/2),t.save(),t.translate(b.x,b.y),t.rotate(h),t.scale(p,x),t.arc(0,0,1,n,i,!s),t.restore()):"c"==k?(t.bezierCurveTo(P[1]+y,P[2]+d,P[3]+y,P[4]+d,P[5]+y,P[6]+d),S=P[3]+y,w=P[4]+d,y+=P[5],d+=P[6]):"C"==k?(S=P[3],w=P[4],y=P[5],d=P[6],t.bezierCurveTo(P[1],P[2],S,w,y,d)):"s"==k?(null!==S&&null!==S||(S=y,w=d),t.bezierCurveTo(2*y-S,2*d-w,P[1]+y,P[2]+d,P[3]+y,P[4]+d),S=P[1]+y,w=P[2]+d,y+=P[3],d+=P[4]):"S"==k?(null!==S&&null!==S||(S=y,w=d),t.bezierCurveTo(2*y-S,2*d-w,P[1],P[2],P[3],P[4]),S=P[1],w=P[2],y=P[3],d=P[4]):"q"==k?(C=P[1]+y,T=P[2]+d,y+=P[3],d+=P[4],t.quadraticCurveTo(C,T,y,d)):"Q"==k?(C=P[1],T=P[2],y=P[3],d=P[4],t.quadraticCurveTo(C,T,y,d)):"t"==k?(null!==C&&null!==C||(C=y,T=d),C=2*y-C,T=2*d-T,y+=P[1],d+=P[2],t.quadraticCurveTo(C,T,y,d)):"T"==k?(null!==C&&null!==C||(C=y,T=d),C=2*y-C,T=2*d-T,y=P[1],d=P[2],t.quadraticCurveTo(C,T,y,d)):"z"==k||"Z"==k?(y=z.x,d=z.y,z=void 0,t.closePath()):"AC"==k?(y=P[1],d=P[2],v=P[3],n=P[4],i=P[5],O=P[6],t.arc(y,d,v,n,i,O)):"AT"==k?(f=P[1],_=P[2],y=P[3],d=P[4],v=P[5],t.arcTo(f,_,y,d,v)):"E"==k?(y=P[1],d=P[2],p=P[3],x=P[4],h=P[5],n=P[6],i=P[7],O=P[8],t.save(),t.translate(y,d),t.rotate(h),t.scale(p,x),t.arc(0,0,1,n,i,O),t.restore()):"R"==k?(y=P[1],d=P[2],m=P[3],g=P[4],z={x:y,y:d},t.rect(y,d,m,g)):console.log(k+"is not implemented"),I.x=y,I.y=d}}}]),t}(),D=function(t){function e(t){n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));if(null==t.pos||t.pos.length<2)return console.error("[pos] is not valid"),a(i);i._position=[];for(var o=0;o<t.pos.length;o++)t.pos[o]instanceof f?i._position[o]=t.pos[o]:t.pos[o]instanceof Array&&(i._position[o]=new f(t.pos[o][0],t.pos[o][1]));return i}return r(e,t),o(e,[{key:"Render",value:function(t){if(!0!==this.hide){t.save(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),t.beginPath();for(var i=0;i<this._position.length;i++)0==i?t.moveTo(this._position[0].x,this._position[0].y):t.lineTo(this._position[i].x,this._position[i].y);t.stroke(),t.closePath(),t.restore()}}}]),e}(I),j=function(t){function e(t){n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));if(null==t.pos||t.pos.length<2)return console.error("[pos] is not valid"),a(i);i._position=[];for(var o=0;o<t.pos.length;o++)t.pos[o]instanceof f?i._position[o]=t.pos[o]:t.pos[o]instanceof Array&&(i._position[o]=new f(t.pos[o][0],t.pos[o][1]));return i.isBezier=t.isBezier||!1,i}return r(e,t),o(e,[{key:"Render",value:function(t){if(!0!==this.hide){t.save(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),t.beginPath();for(var i=[],n=0;n<this._position.length;n++)0==n?t.moveTo(this._position[0].x,this._position[0].y):(i.push(this._position[n].x),i.push(this._position[n].y));t.bezierCurveTo.apply(t,i),t.stroke(),t.closePath(),t.restore()}}}]),e}(I),U=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._position=new O,i._position.setFromXYWH(t),i.originalPosition=new O,i.originalPosition.setFromXYWH(t),null!=t.svg?i.svg=new F(t.svg):console.log("Error : Empty SVG String!!"),i}return r(e,t),o(e,[{key:"changeSvg",value:function(t){null!=t?this.svg=new F(t):console.log("Error : Empty SVG String!!")}},{key:"Render",value:function(t){!0!==this.hide&&(t.save(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),t.fillStyle=this.color,t.translate(this._position.min.x,this._position.min.y),t.scale(this.scale[0],this.scale[1]),null!=this.svg&&this.svg.Render(t),t.fill(),t.restore())}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),e}(I),W=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.text=t.text,i.url=t.url,i._position=new O,i._position.setFromXYWH(t),i.font=t.font||'normal normal 12px "serif"',null!=t.font&&i.makeFontAttr(t.font),null!=t.fontStyle?i.fontStyle=t.fontStyle:null==i.fontStyle&&(i.fontStyle="normal"),null!=t.fontWeight?i.fontWeight=t.fontWeight:null==i.fontWeight&&(i.fontWeight="normal"),null!=t.fontSize?i.fontSize=t.fontSize:null==i.fontSize&&(i.fontSize=12),null!=t.fontFace?i.fontFace=t.fontFace:null==i.fontFace&&(i.fontFace="serif"),i.makeFont(),i.isChangeLine=null!=t.isChangeLine&&t.isChangeLine,i.isEllipsis=null==t.isEllipsis||t.isEllipsis,i.showBoundBox=null!=t.showBoundBox&&t.showBoundBox,i.boundboxOpacity=t.boundboxOpacity||1,i.bgColor=t.bgColor,i.maxTextWidth=0,i.maxTextHeight=1,i}return r(e,t),o(e,[{key:"makeFontAttr",value:function(t){if(t.indexOf(" ")>-1){var e=t.substring(0,t.indexOf('"')-1),i=t.substring(t.indexOf('"'),t.length-1).replace('"',""),n=e.split(" ");n.length>2?(this.fontStyle=n[0],this.fontWeight=n[1],this.fontSize=Number(n[2].replace("px","")),this.fontFace=i):console.log('Error : please check Mask of Font.(style weight size "face")')}else this.fontFace=opts.font}},{key:"makeFont",value:function(){this.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+'px "'+this.fontFace+'"'}},{key:"setFontStyle",value:function(t){this.fontStyle=t||"normal",this.makeFont()}},{key:"setFontWeight",value:function(t){this.fontWeight=t||"normal",this.makeFont()}},{key:"setFontSize",value:function(t){this.fontSize=t||12,this.makeFont()}},{key:"setFontFace",value:function(t){this.fontFace=t||"serif",this.makeFont()}},{key:"setText",value:function(t){this.text=t||""}},{key:"setUrl",value:function(t){this.url=t||""}},{key:"getMaxWidth",value:function(){return this.maxTextWidth}},{key:"getMaxHeight",value:function(){return this.maxTextHeight}},{key:"setMaxWidth",value:function(t){t.save(),t.font=this.font,t.textBaseline="top";var e=this.text.split("\n");this.maxTextHeight=e.length;for(var i in e){var n=t.measureText(e[i]).width;this.maxTextWidth<n&&(this.maxTextWidth=n)}t.restore()}},{key:"setBoxSizeCenter",value:function(t){var e=this._position.getCenter();if(null!=t&&!1===this.isEllipsis){t.save(),t.font=this.font,t.textBaseline="top";var i=t.measureText(this.text).width;i<20&&(i=20),this._position.max.x=this._position.min.x+i,this._position.setCenter(e),t.restore()}}},{key:"Update",value:function(t){}},{key:"Render",value:function(t){if(!0!==this.hide){if(t.save(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),!0===this.showBoundBox){this.boundboxOpacity<1&&(t.globalAlpha=this.boundboxOpacity);var i=this._position.min,n=this._position.getSize();null!=this.bgColor?(t.fillStyle=this.bgColor,t.fillRect(i.x,i.y,n.x,n.y)):(t.fillStyle=this.lineColor,t.strokeRect(i.x,i.y,n.x,n.y))}t.font=this.font,t.textBaseline="top",t.fillStyle=this.color;var o=this._position.getSize();!0===this.isChangeLine?this.TextLineBreak(t,this.text,this.fontSize,1.2,this._position.min.x,this._position.min.y,o.x,this._position.max.y):!0===this.isEllipsis?t.fillText(this.TextEllipsis(t,this.text,o.x),this._position.min.x,this._position.min.y):t.fillText(this.text,this._position.min.x,this._position.min.y),t.restore()}}},{key:"TextEllipsis",value:function(t,e,i){var n=t.measureText(e).width,o=t.measureText("…").width;if(n<=i||n<=o)return e;for(var s=e.length;n>=i-o&&s-- >0;)e=e.substring(0,s),n=t.measureText(e).width;return e+"…"}},{key:"TextLineBreak",value:function(t,e,i,n,o,s,r,a){for(var h="",c=s,u=i*n,l=0;l<e.length;l++){var y=h+e[l],f=t.measureText(y).width;if(c+u>a)return void t.fillText("...",o+10,a-u);f<r&&"\n"!=e[l]?h=y:(t.fillText(h,o,c),h="\n"!=e[l]?e[l]:"",c+=u)}t.fillText(h,o,c)}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),e}(I),B=function(t){function e(t){n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._shape=new M(t),i._shape.eventStore={mousedown:function(t,e){this.setColor("#ff0000")},mouseup:function(t){this.setColor(this.originalColor)},mousemove:function(t,e){this.Translate(e.offset),t.Render()},click:function(t,e){console.log(this.parentId),t.scene.Remove(this.parentId),t.Render()}},i}return r(e,t),o(e,[{key:"Render",value:function(t){this._shape.Render(t)}}]),e}(R),H=function(t){function e(t){n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._shape=new P(t),i._shape.eventStore={mousedown:function(t,e){this.setColor("#ff0000")},mouseup:function(t,e){this.setColor(this.originalColor)},mousemove:function(t,e){this.Translate(e.offset)},click:function(t,e){t.scene.Remove(this.parentId)},_afterCallback:function(t,e){t.Render()}},i}return r(e,t),o(e,[{key:"Render",value:function(t){0==this._shape.hide&&this._shape.Render(t)}}]),e}(R),V=function(t){function e(t){n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.controlRect=new P(t),i.text=t.text,i}return r(e,t),o(e,[{key:"Update",value:function(t){}},{key:"Render",value:function(t){t.fillText(this.text,10,10)}}]),e}(R),q=function(t){function e(t){n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));i._c1=new M,i._c2=new M,i._c3=new M,i._c4=new M,i._rect=new P(t),i._c1.set(i._rect._position.min.x,i._rect._position.min.y),i._c2.set(i._rect._position.max.x,i._rect._position.min.y),i._c3.set(i._rect._position.min.x,i._rect._position.max.y),i._c4.set(i._rect._position.max.x,i._rect._position.max.y),i._rect.Attach(i.id,{min:{x:[i._c1._position,i._c3._position],y:[i._c1._position,i._c2._position]},max:{x:[i._c2._position,i._c4._position],y:[i._c3._position,i._c4._position]}}),i._c1.Attach(i.id,{min:{x:i._rect._position.min,y:i._rect._position.min},_next:[i._rect]}),i._c2.Attach(i.id,{min:{x:i._rect._position.max,y:i._rect._position.min},_next:[i._rect]}),i._c3.Attach(i.id,{min:{x:i._rect._position.min,y:i._rect._position.max},_next:[i._rect]}),i._c4.Attach(i.id,{min:{x:i._rect._position.max,y:i._rect._position.max},_next:[i._rect]}),i._rect.eventStore={mousemove:function(t,e){this.Translate(e.offset)},click:function(t,e){t.scene.Remove(this.parentId)},_after:function(t,e){t.Render()}};var o={mousemove:function(t,e){this.Translate(e.offset),t.Render()}};return i._c1.eventStore=o,i._c2.eventStore=o,i._c3.eventStore=o,i._c4.eventStore=o,i}return r(e,t),o(e,[{key:"Render",value:function(t){this._rect.Render(t),this._c1.Render(t),this._c2.Render(t),this._c3.Render(t),this._c4.Render(t)}}]),e}(R),G=function(t){function e(t){n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));i._rect=new P(t),i._c1=new M,i._c2=new M,i._c3=new M,i._c4=new M,i._c1.set(i._rect._position.min.x,i._rect._position.min.y),i._c2.set(i._rect._position.max.x,i._rect._position.min.y),i._c3.set(i._rect._position.min.x,i._rect._position.max.y),i._c4.set(i._rect._position.max.x,i._rect._position.max.y),i._line=new D({pos:[i._c1._position,i._c2._position,i._c3._position,i._c4._position],isBezier:!0,lineType:"DASH",lineWidth:5}),i._rect.Attach(i.id,{min:{x:[i._line._position[0],i._line._position[2],i._c1._position,i._c3._position],y:[i._line._position[0],i._line._position[1],i._c1._position,i._c2._position]},max:{x:[i._line._position[1],i._line._position[3],i._c2._position,i._c4._position],y:[i._line._position[2],i._line._position[3],i._c3._position,i._c4._position]}}),i._c1.Attach(i.id,{min:{x:[i._rect._position.min,i._line._position[0]],y:[i._rect._position.min,i._line._position[0]]},_next:[i._rect]}),i._c2.Attach(i.id,{min:{x:[i._rect._position.max,i._line._position[1]],y:[i._rect._position.min,i._line._position[1]]},_next:[i._rect]}),i._c3.Attach(i.id,{min:{x:[i._rect._position.min,i._line._position[2]],y:[i._rect._position.max,i._line._position[2]]},_next:[i._rect]}),i._c4.Attach(i.id,{min:{x:[i._rect._position.max,i._line._position[3]],y:[i._rect._position.max,i._line._position[3]]},_next:[i._rect]}),i._rect.eventStore={mousemove:function(t,e){this.Translate(e.offset)},click:function(t,e){t.scene.Remove(this.parentId)},_after:function(t,e){t.Render()}};var o={mousemove:function(t,e){this.Translate(e.offset),t.Render()}};return i._c1.eventStore=o,i._c2.eventStore=o,i._c3.eventStore=o,i._c4.eventStore=o,i}return r(e,t),o(e,[{key:"Render",value:function(t){this._c1.Render(t),this._c2.Render(t),this._c3.Render(t),this._c4.Render(t),this._line.Render(t)}}]),e}(R),X=function(t){function e(t){n(this,e);var i=a(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.path2d=new Path2D("M118.148,0H19.237c-3.318,0-6.438,0.851-9.155,2.342C4.087,5.525,0,11.825,0,19.086\n\t\t c0,7.935,4.88,14.722,11.799,17.547c2.286,0.969,4.8,1.506,7.438,1.506h98.911c10.532,0,19.069-8.537,19.069-19.07\n\t\t C137.218,8.539,128.681,0,118.148,0z M22.549,25.047c-0.006,0.005-0.011,0.01-0.016,0.016l-2.842,2.818\n\t\t c-2.507,2.488-6.587,2.488-9.093,0c-2.506-2.485-2.506-6.533,0-9.02l1.569-1.558c0.416-0.412,1.133-0.138,1.155,0.445\n\t\t c0.027,0.744,0.162,1.491,0.409,2.213c0.084,0.243,0.023,0.515-0.16,0.696l-0.553,0.55c-1.186,1.176-1.224,3.091-0.05,4.278\n\t\t c1.187,1.199,3.134,1.207,4.328,0.021l2.843-2.819c1.192-1.183,1.188-3.095,0-4.273c-0.157-0.154-0.314-0.275-0.438-0.358\n\t\t c-0.155-0.107-0.287-0.344-0.294-0.529c-0.017-0.444,0.142-0.9,0.495-1.251l0.89-0.885c0.234-0.231,0.601-0.259,0.871-0.072\n\t\t c0.257,0.179,0.646,0.502,0.868,0.722C25.06,18.552,25.025,22.574,22.549,25.047z M25.77,20.26\n\t\t c-0.027-0.744-0.162-1.491-0.409-2.213c-0.084-0.243-0.023-0.515,0.159-0.696l0.554-0.55c1.186-1.176,1.224-3.091,0.05-4.279\n\t\t c-1.187-1.198-3.135-1.206-4.328-0.021l-2.843,2.819c-1.192,1.183-1.188,3.095,0,4.273c0.157,0.154,0.313,0.275,0.438,0.359\n\t\t c0.155,0.105,0.287,0.343,0.294,0.528c0.017,0.443-0.142,0.9-0.495,1.251l-0.89,0.885c-0.233,0.23-0.601,0.259-0.871,0.072\n\t\t c-0.257-0.179-0.646-0.502-0.868-0.722c-2.526-2.511-2.492-6.533-0.015-9.005c0.005-0.006,0.011-0.011,0.015-0.017l2.842-2.818\n\t\t c2.507-2.488,6.587-2.488,9.093,0c2.507,2.485,2.507,6.533,0,9.02l-1.569,1.558C26.509,21.117,25.791,20.843,25.77,20.26z\n\t\t  M117.833,35.457H28.478c5.635-3.285,9.432-9.378,9.432-16.371c0-7.015-3.82-13.125-9.485-16.402h89.409\n\t\t c9.051,0,16.387,7.336,16.387,16.387S126.884,35.457,117.833,35.457z"),i}return r(e,t),o(e,[{key:"Destroy",value:function(){s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this.path2d}},{key:"Render",value:function(t){s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),t.save(),t.fillStyle=this.color,t.translate(this._rect._position.min.x,this._rect._position.min.y),t.scale(this._rect.scale[0],this._rect.scale[1]),this.path2d.Render(t),t.fill(),t.restore()}}]),e}(q),Z=function t(e){function i(t,e){var i={x:0,y:0};return i.x=t.x-e.x,i.y=t.y-e.y,i}function o(t){var i={x:t.clientX,y:t.clientY};return null!==e.scene.camera&&(i=e.scene.camera.ScreenToWorld(i.x,i.y)),i}function s(t){return function(e){if(e.touches.length>0&&t(e.touches[0]))return e.preventDefault(),!1}}function r(t){var i=o(t);if(null==(f=_.FindItemOne(i))&&(f=e.scene.camera),null!=f){l=i,y=i;var n={event:t,position:i};_.Trigger(f,"mousedown",n)}t.preventDefault()}function a(t){var e=o(t),n=_.FindItemOne(e);if(null!=n?(null==v&&_.Trigger(n,"mouseover",{event:t,position:e}),null!=v&&v.id!=n.id&&(_.Trigger(v,"mouseout",{event:t,position:e}),_.Trigger(n,"mouseover",{event:t,position:e})),v=n,_.Trigger(n,"mouseovermove",{event:t,position:e})):null!=v&&(_.Trigger(v,"mouseout",{event:t,position:e}),v=null),null!=f){var s=i(e,l),r=i(e,y);y=e;var a={offset:r,cameraOffset:s,event:t,currentObject:n};_.Trigger(f,"mousemove",a)}t.preventDefault()}function h(t){var e=o(t),i={event:t,currentObject:_.FindItemOne(e),position:e};l&&y&&l.x==y.x&&l.y==y.y?_.Trigger(f,"click",i):_.Trigger(f,"mouseup",i),v=null,f=null,t.preventDefault()}function c(t){var i=o(t),n=0;t||(t=window.event),t.wheelDelta?n=t.wheelDelta/120:t.detail&&(n=-t.detail/3),_.Trigger(e.scene.camera,"mousewheel",{event:t,delta:n,position:i}),t.preventDefault()}function u(t){var e=o(t),i=_.FindItemOne(e,"dblclick"),n={event:t,position:e};_.Trigger(i,"dblclick",n),t.preventDefault()}n(this,t);var l,y,f,d=e.canvas,_=e.EventStore,v=null;d.onmousedown=r,d.ontouchstart=s(r),d.onmousemove=a,d.ontouchmove=s(a),d.onmouseup=h,d.ontouchup=s(h),d.ondblclick=u,d.onmousewheel=c},Y=function t(e){function i(t){if(null!==e.scene.camera){var i={event:t,keyCode:t.which||t.keyCode};s.Trigger(e.scene.camera,"keydown",i)}}function o(t){if(null!==e.scene.camera){var i={event:t,keyCode:t.which||t.keyCode};s.Trigger(e.scene.camera,"keyup",i)}}n(this,t);var s=e.EventStore;document.onkeydown=i,document.onkeyup=o};e.DataSource=y,e.EventStore=d,e.ShaderProgram=v,e.Scene=k,e.Stage3D=S,e.Stage2D=w,e.Stage2DSocket=C,e.StageServerSocket=T,e.Vec2=f,e.Box2=O,e.Scene2D=A,e.Camera2D=z,e.Path2D=F,e.Item=R,e.Rect=P,e.Point=M,e.Line=D,e.BezierLine=j,e.Svg=U,e.Text=W,e.Image=L,e.Unit=I,e.Point2D=B,e.Rect2D=H,e.TextBox2D=V,e.EditRect2D=q,e.BezierLine2D=G,e.Svg2D=X,e.MouseControl=Z,e.KeyboardControl=Y});!function(t){t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")&&t.default}(i);var n=i.DataSource,o=(i.EventStore,i.ShaderProgram,i.Scene,i.Stage3D,i.Stage2D),s=(i.Stage2DSocket,i.StageServerSocket,i.Vec2),r=(i.Box2,i.Scene2D),a=i.Camera2D,h=(i.Path2D,i.Item),c=i.Rect,u=i.Point,l=(i.Line,i.BezierLine),y=i.Svg,f=i.Text,d=i.Image,_=(i.Unit,i.Point2D,i.Rect2D,i.TextBox2D,i.EditRect2D,i.BezierLine2D,i.Svg2D,i.MouseControl),v=(i.KeyboardControl,function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}),p=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),x=function t(e,i,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,i);if(void 0===o){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,i,n)}if("value"in o)return o.value;var r=o.get;if(void 0!==r)return r.call(n)},m=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},g=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},k=function(t){function e(t){v(this,e);var i=g(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));i.mode=t.mode;var o={x:t.x,y:t.y,width:t.width||150,height:t.height||50,text:t.text||"",textColor:t.textColor||"#000000",font:t.font||'normal normal 14px "serif"',lineColor:t.lineColor||"#8395a3",lineType:t.lineType||"SOLID",lineWidth:t.lineWidth||"1.5"};i.isLineSelected=!1,i.attachers={source:null,target:null};var r={x:t.x,y:t.y,width:16,height:16,lineColor:"#dddddd",order:5};r.color=o.textColor,r.text=o.text,r.font=o.font,r.showBoundBox=!0,r.isEllipsis=!1,i._center=new f(r),i.swapImage=new d({x:i._center.max.x,y:i._center.min.y,width:24,height:24,dataSource:"LayerSwapButton"}),i.swapImage.Hide(),i.swapImage.eventStore={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"pointer":"default"},mouseover:function(t,e){t.canvas.style.cursor="pointer"},mouseout:function(t,e){t.canvas.style.cursor="default"},click:function(t,e){t.canvas.style.cursor="default",t.scene.getItem(this.parentId).SwapLine()}},i.editImage=new d({x:i._center.max.x,y:i._center.min.y,width:24,height:24,dataSource:"LayerEditButton"}),i.editImage.Hide(),i.editImage.eventStore={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"pointer":"default"},mouseover:function(t,e){t.canvas.style.cursor="pointer"},mouseout:function(t,e){t.canvas.style.cursor="default"},click:function(t,e){t.canvas.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._center.min.x,i._center.max.y);var o=i._center._position.getSize();e.position.width=o.x,e.position.height=o.y;var s=n.Load("LineEditPopupLink");"function"==typeof s&&s(i,t,e)}},i.closeImage=new d({x:i._center.max.x,y:i._center.min.y,width:16,height:16,dataSource:"LayerDelButton"}),i.closeImage.Hide(),i.closeImage.eventStore={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"pointer":"default"},mouseover:function(t,e){t.canvas.style.cursor="pointer"},mouseout:function(t,e){t.canvas.style.cursor="default"},click:function(t,e){t.canvas.style.cursor="default",t.scene.Remove(this.parentId)}},i._boundbox=new c({x:o.x,y:o.y,width:o.width,height:o.height,collisionCheck:!1}),i._cs=new u({collisionCheck:!1,pointType:"RECT",opacity:.7,color:o.lineColor,radius:3}),i._ce=new u({collisionCheck:!1,pointType:"ARROW",opacity:.7,color:o.lineColor}),i._cs.set(i._boundbox._position.min.x,i._boundbox._position.min.y),i._ce.set(i._boundbox._position.max.x,i._boundbox._position.max.y),i._line=new l({pos:[[i._cs.x,i._cs.y],[i._boundbox._position.max.x,i._boundbox._position.min.y],[i._boundbox._position.min.x,i._boundbox._position.max.y],[i._ce.x,i._ce.y]],lineType:o.lineType,lineColor:o.lineColor,opacity:.7,lineWidth:o.lineWidth,collisionCheck:!1}),i._cs.Attach(i,function(t){return this._boundbox._position.min.set(this._cs._position.x,this._cs._position.y),this._line._position[0].set(this._cs._position.x,this._cs._position.y),this._boundbox}),i._ce.Attach(i,function(t){return this._boundbox._position.max.set(this._ce._position.x,this._ce._position.y),this._line._position[3].set(this._ce._position.x,this._ce._position.y),this._boundbox});var a={mousemove:function(t,e){this.Translate(e.offset)}};return i._cs.eventStore=a,i._ce.eventStore=a,i._boundbox.Attach(i,function(t){if(this._cs.set(this._boundbox._position.min.x,this._boundbox._position.min.y),this._ce.set(this._boundbox._position.max.x,this._boundbox._position.max.y),"left"==t.sourceDirection?this._cs.SetOffset(6,0):"right"==t.sourceDirection?this._cs.SetOffset(-6,0):"top"==t.sourceDirection?this._cs.SetOffset(0,6):"bottom"==t.sourceDirection&&this._cs.SetOffset(0,-6),"left"==t.targetDirection?this._ce.SetOffset(6,0):"right"==t.targetDirection?this._ce.SetOffset(-6,0):"top"==t.targetDirection?this._ce.SetOffset(0,6):"bottom"==t.targetDirection&&this._ce.SetOffset(0,-6),this._line._position[0].set(this._boundbox._position.min.x,this._boundbox._position.min.y),this._line._position[3].set(this._boundbox._position.max.x,this._boundbox._position.max.y),null==t.sourcePoint)return null;this.changeWeightPoint(t.sourceDirection,t.sourcePoint,t.targetPoint,this._line._position[1]),this.changeWeightPoint(t.targetDirection,t.sourcePoint,t.targetPoint,this._line._position[2]);var e=this._boundbox.GetCenter();if(this._line._position[1].x==this._line._position[2].x&&this._line._position[1].y==this._line._position[2].y){var i=new s(0,0),n=i.addVectors(this._line._position[1],e).multiplyScalar(.5),o=i.addVectors(this._line._position[2],n).multiplyScalar(.5);this._center._position.setCenter(o)}else this._center._position.setCenter(e);return this._center}),i._center.Attach(i,function(t){var e=this._center._position.getCenter().x-12;this.swapImage._position.min.set(e-24,this._center.min.y-24),this.swapImage._position.setSize({x:24,y:24}),this.editImage._position.min.set(e,this._center.min.y-24),this.editImage._position.setSize({x:24,y:24}),this.closeImage._position.min.set(e+24,this._center.min.y-24),this.closeImage._position.setSize({x:24,y:24})}),i._center.eventStore={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"pointer":"default"},mouseover:function(t,e){t.canvas.style.cursor="pointer"},mouseout:function(t,e){t.canvas.style.cursor="default"},click:function(t,e){t.canvas.style.cursor="default";var i=t.scene.getItem(this.parentId);if(e.event.ctrlKey)i.Toggle();else{var n=t.getSelectedAllObjects();if(1==n.length&&void 0!==n[0].isLineSelected&&n[0]._center.id==this.id)i.Toggle();else{for(var o in n){var s=n[o];!0===s.isSelected?s.Toggle():!0===s.isLineSelected&&s.Toggle()}i.Toggle()}}},dblclick:function(t,e){t.canvas.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._center.min.x,i._center.max.y);var o=i._center._position.getSize();e.position.width=o.x,e.position.height=o.y;var s=n.Load("LineEditPopupLink");"function"==typeof s&&s(i,t,e),!1===i.isLineSelected&&i.Toggle()}},i.needToUpdate=!0,i}return m(e,t),p(e,[{key:"Toggle",value:function(){!1===this.isLineSelected?("EDIT"==this.mode&&(this.swapImage.Show(),this.closeImage.Show(),this.editImage.Show(),this._line.opacity=1),this.isLineSelected=!0):(this.swapImage.Hide(),this.closeImage.Hide(),this.editImage.Hide(),this._line.opacity=.5,this.isLineSelected=!1)}},{key:"ChangeLineStyle",value:function(t){for(var e in t)"lineType"==e?this._line.setLineType(t[e]):this._line[e]=t[e]}},{key:"ChangeColor",value:function(t){this._line.lineColor=t,this._cs.color=t,this._ce.color=t}},{key:"ChangeTextColor",value:function(t){this._center.setColor(t)}},{key:"ChangeText",value:function(t){this._center.setText(t),this.needToUpdate=!0}},{key:"ChangeFont",value:function(t){this._center.setFont(t),this._center.makeFontAttr(t),this.needToUpdate=!0}},{key:"ChangeFontSize",value:function(t){this._center.setFontSize(t),this.needToUpdate=!0}},{key:"ChangeFontStyle",value:function(t){this._center.setFontStyle(t),this.needToUpdate=!0}},{key:"ChangeFontWeight",value:function(t){this._center.setFontWeight(t),this.needToUpdate=!0}},{key:"ChangeFontFace",value:function(t){this._center.setFontFace(t)}},{key:"SwapLine",value:function(){this._line._position=this._line._position.reverse();var t=this.attachers.source,e=this.attachers.target;this.Disconnect(),this.Connect(e,t)}},{key:"Connect",value:function(t,e){this.attachers.source=t,this.attachers.target=e,this.attachers.source.Attach(this,function(t){var e=this.attachers.source,i=this.attachers.target;return this._cs.set(e.x,e.y),t.sourcePoint=[e.x,e.y],t.targetPoint=[i.x,i.y],t.sourceDirection=e.direction,t.targetDirection=i.direction,this._cs}),this.attachers.target.Attach(this,function(t){var e=this.attachers.source,i=this.attachers.target;return this._ce.set(i.x,i.y),t.sourcePoint=[e.x,e.y],t.targetPoint=[i.x,i.y],t.sourceDirection=e.direction,t.targetDirection=i.direction,this._ce}),this.setArrowDirection(t.direction,this._cs),this.setArrowDirection(e.direction,this._ce)}},{key:"Disconnect",value:function(){null!=this.attachers.source&&this.attachers.source.Detach(this),null!=this.attachers.target&&this.attachers.target.Detach(this),this.attachers.source=null,this.attachers.target=null}},{key:"setArrowDirection",value:function(t,e){var i=Math.PI/2;"left"==t?e.angle=0:"top"==t?e.angle=i:"right"==t?e.angle=2*i:"bottom"==t&&(e.angle=3*i)}},{key:"changeWeightPoint",value:function(t,e,i,n){"left"==t?e[0]<i[0]?(n.x=e[0],n.y=i[1]):(n.x=i[0],n.y=e[1]):"top"==t?e[1]<i[1]?(n.x=i[0],n.y=e[1]):(n.x=e[0],n.y=i[1]):"right"==t?e[0]>i[0]?(n.x=e[0],n.y=i[1]):(n.x=i[0],n.y=e[1]):"bottom"==t&&(e[1]>i[1]?(n.x=i[0],n.y=e[1]):(n.x=e[0],n.y=i[1]))}},{key:"Destroy",value:function(){this.Disconnect(),delete this._boundbox,delete this._line,delete this._cs,delete this._ce,delete this._center,delete this.swapImage,delete this.closeImage,delete this.editImage}},{key:"Update",value:function(t){!0===this.needToUpdate&&(this._center.Update(t),this.needToUpdate=!1)}},{key:"Render",value:function(t,e){this._line.Render(t),this._cs.Render(t),this._ce.Render(t),this.swapImage.Render(t),this.editImage.Render(t),this.closeImage.Render(t),this._center.Render(t)}},{key:"getSaveData",value:function(){return{id:this.id,source:{id:this.attachers.source.parentId,direction:this.attachers.source.direction},target:{id:this.attachers.target.parentId,direction:this.attachers.target.direction},lineColor:this._line.lineColor,lineType:this._line.lineType,lineWidth:this._line.lineWidth,text:this._center.text,textColor:this._center.color,font:this._center.font}}},{key:"CollisionCheck",value:function(t){return this._center.CollisionCheck(t)}}]),e}(h),b=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};v(this,e);var i=g(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.radius=t.radius||10,i.color=null,i.lineColor="#000000",i.direction=t.direction||"left",i.opacity=0,i.attachedLines={},i.attachedTarget={},i}return m(e,t),p(e,[{key:"Destroy",value:function(t){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this,t);for(var i in this.attachs){var n=this.attachObjects[i];n instanceof k&&(n.Disconnect(),t.scene.Remove(n.id))}}}]),e}(u),S=function(t){function e(t){v(this,e);var i=g(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._cp=new u({pointType:"RECT",color:"#000000"}),i._cp.Hide(),i.closeImage=new d({x:t.x,y:t.y,width:24,height:24,dataSource:"LayerDelButton",order:6}),i.closeImage.Hide(),i.editImage=new d({x:t.x,y:t.y,width:24,height:24,dataSource:"LayerEditButton",order:6}),i.editImage.Hide(),i._boundbox.Attach(i,function(t){this._cp._position.set(this._boundbox._position.max.x,this._boundbox._position.max.y);this.closeImage._position.min.set(this._boundbox._position.max.x-24,this._boundbox._position.min.y-24),this.closeImage._position.setSize({x:24,y:24}),this.editImage._position.min.set(this._boundbox._position.max.x-48,this._boundbox._position.min.y-24),this.editImage._position.setSize({x:24,y:24})}),i._cp.Attach(i,function(){var t=this._boundbox._position.min.x+60,e=this._boundbox._position.min.y+30;return t>this._cp._position.x?(this._cp._position.x=t,this._boundbox):e>this._cp._position.y?(this._cp._position.y=e,this._boundbox):(this._boundbox._position.max.set(this._cp._position.x,this._cp._position.y),this._boundbox)}),i._cp.eventStore={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"nw-resize":"default"},mouseover:function(t,e){t.canvas.style.cursor="nw-resize"},mouseout:function(t,e){t.canvas.style.cursor="default"},mousemove:function(t,e){this.Translate(e.offset)}},i.closeImage.eventStore={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"pointer":"default"},mouseover:function(t,e){t.canvas.style.cursor="pointer"},mouseout:function(t,e){t.canvas.style.cursor="default"},click:function(t,e){t.canvas.style.cursor="default",t.scene.Remove(this.parentId);try{var i=n.Load("CanvasBlur");"function"==typeof i&&(options=i("",this,{}))}catch(t){}}},i.editImage.eventStore={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"pointer":"default"},mouseover:function(t,e){t.canvas.style.cursor="pointer"},mouseout:function(t,e){t.canvas.style.cursor="default"},click:function(t,e){t.canvas.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y),e.position.width=100,e.position.height=100;var o=n.Load("EditPopupLink");"function"==typeof o&&o(this.parentId,t,e)}},i}return m(e,t),p(e,[{key:"Destroy",value:function(){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this._cp,delete this.closeImage,delete this.editImage}},{key:"Render",value:function(t){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),this._cp.Render(t),this.closeImage.Render(t),this.editImage.Render(t)}},{key:"Toggle",value:function(){}},{key:"CollisionCheck",value:function(t){return this._boundbox.CollisionCheck(t)}}]),e}(function(t){function e(t){v(this,e);var i=g(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));i.mode=t.mode;var o={x:t.x,y:t.y,width:t.width||100,height:t.height||100,color:t.boundboxColor||"#ebebeb",lineColor:t.boundboxLineColor||"#aaaaaa",lineType:t.boundboxLineType||[3,3],lineWidth:t.boundboxLineWidth||2};i.isSelected=!1,i._boundbox=new c(o),i._boundbox.opacity=0;var s=i._boundbox.GetCenter();i._leftAttacher=new b({x:i._boundbox._position.min.x,y:s.y,direction:"left",pointType:"RECT",order:5}),i._topAttacher=new b({x:s.x,y:i._boundbox._position.min.y,direction:"top",pointType:"RECT",order:5}),i._rightAttacher=new b({x:i._boundbox._position.max.x,y:s.y,direction:"right",pointType:"RECT",order:5}),i._bottomAttacher=new b({x:s.x,y:i._boundbox._position.max.y,direction:"bottom",pointType:"RECT",order:5}),i._boundbox.Attach(i,function(t){var e=this._boundbox.GetCenter();return this._leftAttacher.set(this._boundbox._position.min.x,e.y),this._topAttacher.set(e.x,this._boundbox._position.min.y),this._rightAttacher.set(this._boundbox._position.max.x,e.y),this._bottomAttacher.set(e.x,this._boundbox._position.max.y),[this._leftAttacher,this._topAttacher,this._rightAttacher,this._bottomAttacher]}),i._boundbox.eventStore={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"move":"default"},mouseover:function(t,e){t.canvas.style.cursor="move"},mouseout:function(t,e){t.canvas.style.cursor="default"},mousemove:function(t,e){if(this.Translate(e.offset),!0===t.scene.getItem(this.parentId).isSelected){var i=t.getSelectedObjects();for(var n in i){var o=i[n];o._boundbox.id!=this.id&&o._boundbox.Translate(e.offset)}}},click:function(t,e){var i=t.scene.getItem(this.parentId);if(e.event.ctrlKey)i.Toggle();else{var n=t.getSelectedAllObjects();if(1==n.length&&void 0!==n[0].isSelected&&n[0]._boundbox.id==this.id)i.Toggle();else{for(var o in n){var s=n[o];!0===s.isSelected?s.Toggle():!0===s.isLineSelected&&s.Toggle()}i.Toggle()}}}};var r={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"pointer":"default"},mouseover:function(t,e){t.canvas.style.cursor="pointer",this.opacity=.5},mouseout:function(t,e){t.canvas.style.cursor="default",this.opacity=0},mousedown:function(t,e){var i={},o=n.Load("lineOptionsCallback");"function"==typeof o&&(i=o(this.id,t,i)),i.x=e.position.x,i.y=e.position.y,i.width=1,i.height=1,this.attachLine=new k(i),this.attachLine._center.Hide(),t.scene.Add(this.attachLine)},mousemove:function(t,e){this.attachLine._ce.setAngle(this.attachLine._boundbox._position.min,this.attachLine._boundbox._position.max),this.attachLine._ce.Translate(e.offset)},mouseup:function(t,e){if(null!=e.currentObject&&e.currentObject instanceof b){var i={},o=n.Load("lineOptionsCallback");"function"==typeof o&&(i=o(this.id,t,i)),t.scene.getItem(this.parentId)._lineConnecting(t,this,e.currentObject,i)}t.scene.Remove(this.attachLine.id),t.canvas.style.cursor="default",delete this.attachLine},click:function(t,e){null!=this.attachLine.id&&(t.scene.Remove(this.attachLine.id),t.canvas.style.cursor="default",delete this.attachLine)}};return"EDIT"==i.mode&&(i._leftAttacher.eventStore=r,i._topAttacher.eventStore=r,i._rightAttacher.eventStore=r,i._bottomAttacher.eventStore=r),i}return m(e,t),p(e,[{key:"_lineConnecting",value:function(t,e,i,n){if(e.id!=i.id&&(!e.parentId||e.parentId!==i.parentId)){var o=t.getAllLineObjects();for(var s in o)if(null!=o[s].attachers.source)if(e.id===o[s].attachers.source.id){if(i.id===o[s].attachers.target.id)return}else if(e.id===o[s].attachers.target.id&&i.id===o[s].attachers.source.id)return;n.mode=this.mode,n.x=e.x,n.y=e.y,n.width=i.x-e.x,n.height=i.y-e.y;var r=new k(n);t.scene.Add(r),r.Connect(e,i)}}},{key:"Destroy",value:function(){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this._leftAttacher,delete this._topAttacher,delete this._rightAttacher,delete this._bottomAttacher}},{key:"Render",value:function(t,i){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),this._boundbox.Render(t),this._leftAttacher.Render(t),this._topAttacher.Render(t),this._rightAttacher.Render(t),this._bottomAttacher.Render(t)}},{key:"Toggle",value:function(){}},{key:"GetSaveData",value:function(){var t=this._boundbox._position.min,e=this._boundbox._position.getSize();return{id:this.id,x:t.x,y:t.y,width:e.x,height:e.y}}}]),e}(h)),w=function(t){function e(t){v(this,e);var i=g(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));"EDIT"==i.mode&&(i.editImage.eventStore.click=function(t,e){t.canvas.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=i._boundbox._position.getSize();e.position.width=o.x,e.position.height=o.y;var s=n.Load("EditPopupLink");"function"==typeof s&&s(i,t,e)},i._boundbox.eventStore.dblclick=function(t,e){t.canvas.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=i._boundbox._position.getSize();e.position.width=o.x,e.position.height=o.y;var s=n.Load("EditPopupLink");"function"==typeof s&&s(i,t,e),!1===i.isSelected&&i.Toggle()});var o={x:t.x,y:t.y,width:t.width||150,height:t.height||50,color:t.color||"#999999",dataSource:t.dataSource||"EMPTY",bgColor:t.bgColor||"#ffffff",text:t.text||"...",font:t.font||'normal normal 14px "serif"',textColor:t.textColor||"#444444",url:t.url||""},s={x:o.x,y:o.y,width:o.width,height:o.height,collisionCheck:!1};s.color=o.bgColor,s.lineColor="#808080",s.lineWidth=2,s.round=15,i._rect=new c(s);var r={x:o.x,y:o.y,width:126,height:126,color:o.color,collisionCheck:!1};r.svg=n.Load(o.dataSource),i.icon=new y(r),i.icon.dataSource=o.dataSource;var a=n.Load("ClickPopupLink"),h={x:o.x,y:o.y,width:10,height:10,lineColor:"#aaaaaa",collisionCheck:!1,order:6};return h.color=o.textColor,h.font=o.font,h.text=o.text,h.url=o.url,null!=a&&(h.collisionCheck=!0),i.text=new f(h),null!=a&&(i.text.eventStore={_before:function(t,e){t.canvas.style.cursor=e.currentObject?"pointer":"default"},mouseover:function(t,e){t.canvas.style.cursor="pointer"},mouseout:function(t,e){t.canvas.style.cursor="default"},click:function(t,e){t.canvas.style.cursor="default";var i=n.Load("ClickPopupLink"),o=t.scene.getItem(this.parentId);"function"==typeof i&&i(o,t,e)}}),i._boundbox.Attach(i,function(t){var e=this._boundbox.GetCenter();this._rect.min.set(this._boundbox.min.x+6,this._boundbox.min.y+6),this._rect.max.set(this._boundbox.max.x-6,this._boundbox.max.y-6),this._rect.setScale();this.icon._position.min.set(this._boundbox.min.x+10,this._boundbox.min.y+10);var i=this._boundbox.max.y-this._boundbox.min.y-20;this.icon._position.setSize({x:i,y:i}),this.icon.setScale(),this.text.min.set(this._boundbox.min.x+i+10+5,e.y-.5*this.text.fontSize),this.text.max.set(this._boundbox.max.x-5,e.y+.5*this.text.fontSize)}),i}return m(e,t),p(e,[{key:"ChangeIcon",value:function(t){var e=n.Load(t);this.icon.changeSvg(e)}},{key:"ChangeColor",value:function(t){this.icon.setColor(t)}},{key:"ChangeBgColor",value:function(t){this._rect.setColor(t)}},{key:"ChangeTextColor",value:function(t){this.text.setColor(t)}},{key:"ChangeText",value:function(t){this.text.setText(t)}},{key:"ChangeFont",value:function(t){this.text.setFont(t),this.text.makeFontAttr(t)}},{key:"ChangeFontSize",value:function(t){this.text.setFontSize(t)}},{key:"ChangeFontStyle",value:function(t){this.text.setFontStyle(t)}},{key:"ChangeFontWeight",value:function(t){this.text.setFontWeight(t)}},{key:"ChangeFontFace",value:function(t){this.text.setFontFace(t)}},{key:"ChangeUrl",value:function(t){this.text.setUrl(t)}},{key:"Destroy",value:function(){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this.text,delete this.icon,delete this._rect}},{key:"Render",value:function(t,i){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),this._rect.Render(t),this.icon.Render(t),this.text.Render(t)}},{key:"Toggle",value:function(){!1===this.isSelected?(this._boundbox.opacity=1,this._cp.Show(),"EDIT"==this.mode&&(this.closeImage.Show(),this.editImage.Show()),this.isSelected=!0):(this._boundbox.opacity=0,this._cp.Hide(),this.closeImage.Hide(),this.editImage.Hide(),this.isSelected=!1)}},{key:"getSaveData",value:function(){var t=this.GetSaveData();return t.color=this.icon.color,t.dataSource=this.icon.dataSource,t.bgColor=this._rect.color,t.text=this.text.text,t.font=this.text.font,t.textColor=this.text.color,t.url=this.text.url,t}}]),e}(S),C=function(t){function e(t){v(this,e);var i=g(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),o={x:t.x,y:t.y,width:t.width||200,height:t.height||200,url:t.url||""};return n.Add(i.id,{type:"IMAGE",target:o.url}),i._image=new d({x:o.x,y:o.y,width:o.width,height:o.height,dataSource:i.id,collisionCheck:!1,isDynamic:!0}),i._boundbox.Attach(i,function(t){this._image.min.set(this._boundbox.min.x+3,this._boundbox.min.y+3),this._image.max.set(this._boundbox.max.x-3,this._boundbox.max.y-3),this._image.setScale()}),i}return m(e,t),p(e,[{key:"Destroy",value:function(){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this._image}},{key:"Render",value:function(t,i){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),this._image.Render(t)}},{key:"Toggle",value:function(){!1===this.isSelected?(this._boundbox.opacity=1,this._cp.Show(),"EDIT"==this.mode&&this.closeImage.Show(),this.isSelected=!0):(this._boundbox.opacity=0,this._cp.Hide(),this.closeImage.Hide(),this.isSelected=!1)}},{key:"getSaveData",value:function(){var t=this.GetSaveData(),e=n.EncodeImageToBase64(this._image.image);return t.url=e,t.dataSource="IMAGE",t}}]),e}(S),T=function(t){function e(t){v(this,e);var i=g(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),o={x:t.x,y:t.y,width:t.width||200,height:t.height||200,bgColor:t.bgColor||"#ffffff",text:t.text||"",font:t.font||'normal normal 14px "serif"',textColor:t.textColor||"#444444"};"EDIT"==i.mode&&(i._boundbox.eventStore.dblclick=function(t,e){t.canvas.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=i._boundbox._position.getSize();e.position.width=o.x,e.position.height=o.y;var s=n.Load("TextEditPopupLink");"function"==typeof s&&s(i,t,e),!1===i.isSelected&&i.Toggle()},i.editImage.eventStore.click=function(t,e){t.canvas.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=i._boundbox._position.getSize();e.position.width=o.x,e.position.height=o.y;var s=n.Load("TextEditPopupLink");"function"==typeof s&&s(i,t,e)});var s={x:o.x,y:o.y,width:o.width,height:o.height,collisionCheck:!1};s.color=o.bgColor,s.lineColor="#bbbbbb",s.lineWidth=1,i._rect=new c(s);var r={x:o.x,y:o.y,width:10,height:10,lineColor:"#aaaaaa",collisionCheck:!1};return r.color=o.textColor,r.font=o.font,r.text=o.text,r.isChangeLine=!0,i._text=new f(r),i._boundbox.Attach(i,function(t){this._rect.min.set(this._boundbox.min.x+3,this._boundbox.min.y+3),this._rect.max.set(this._boundbox.max.x-3,this._boundbox.max.y-3),this._rect.setScale(),this._text.min.set(this._rect.min.x+3,this._rect.min.y+3),this._text.max.set(this._rect.max.x-3,this._rect.max.y-3)}),i}return m(e,t),p(e,[{key:"ChangeBgColor",value:function(t){this._rect.setColor(t)}},{key:"ChangeTextColor",value:function(t){this._text.setColor(t)}},{key:"ChangeText",value:function(t){this._text.setText(t)}},{key:"ChangeFont",value:function(t){this._text.setFont(t),this._text.makeFontAttr(t)}},{key:"ChangeFontSize",value:function(t){this._text.setFontSize(t)}},{key:"ChangeFontStyle",value:function(t){this._text.setFontStyle(t)}},{key:"ChangeFontWeight",value:function(t){this._text.setFontWeight(t)}},{key:"ChangeFontFace",value:function(t){this._text.setFontFace(t)}},{key:"Destroy",value:function(){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this._text,delete this._rect}},{key:"Render",value:function(t,i){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),this._rect.Render(t),this._text.Render(t)}},{key:"Toggle",value:function(){!1===this.isSelected?(this._boundbox.opacity=1,this._cp.Show(),"EDIT"==this.mode&&(this.closeImage.Show(),this.editImage.Show()),this.isSelected=!0):(this._boundbox.opacity=0,this._cp.Hide(),this.closeImage.Hide(),this.editImage.Hide(),this.isSelected=!1)}},{key:"getSaveData",value:function(){var t=this.GetSaveData();return t.dataSource="TEXT",t.text=this._text.text,t.font=this._text.font,t.textColor=this._text.color,t.bgColor=this._rect.color,t}}]),e}(S),O=function(){function t(e){var i=this;v(this,t),this.left=!1,this.up=!1,this.right=!1,this.down=!1,document.onkeydown=function(t){i.keyDown(t)},document.onkeyup=function(t){i.keyUp(t)}}return p(t,[{key:"Destroy",value:function(){document.onkeydown=null,document.onkeyup=null}},{key:"keyDown",value:function(t){switch(t.keyCode){case 65:this.left=!0;break;case 87:this.up=!0;break;case 68:this.right=!0;break;case 83:this.down=!0}}},{key:"keyUp",value:function(t){switch(t.keyCode){case 65:this.left=!1;break;case 87:this.up=!1;break;case 68:this.right=!1;break;case 83:this.down=!1}}}]),t}(),z=function(t){function e(t){v(this,e);var i=g(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,{id:"StageMain",canvas:t}));i._currScene=new r(i);var n=new a(i.ctx,{x:0,y:0,scale:1});return n.eventStore={mousedown:function(t,e){if(e.event.ctrlKey){var i={x:e.position.x,y:e.position.y,width:1,height:1,collisionCheck:!1};i.lineColor="#800080",i.lineWidth=1,this.collisionBox=new c(i),t.scene.Add(this.collisionBox),this.ctrl=!0}},mousemove:function(t,e){!0===this.ctrl?this.collisionBox.max.add(e.offset):this.OffsetMoveTo(-e.cameraOffset.x,-e.cameraOffset.y)},mouseup:function(t,e){if(!0===this.ctrl){this.collisionBox._position.reconstruct();for(var i in t.scene.Items){var n=t.scene.Items[i];n.CollisionCheck(this.collisionBox._position)&&(!1===n.isSelected?n.Toggle():!1===n.isLineSelected&&n.Toggle())}this.ctrl=!1,t.scene.Remove(this.collisionBox.id)}},mousewheel:function(t,e){e.delta>0?this.OffsetZoomTo(-100):this.OffsetZoomTo(100)},click:function(t,e){!0===this.ctrl&&(this.ctrl=!1,t.scene.Remove(this.collisionBox.id)),t.blur()}},i.scene.Add(n),new _(i),i.control=new O(i),i}return m(e,t),p(e,[{key:"changeObjectValue",value:function(t,e){var i=this.scene.searchItems({isSelected:!0});for(var n in i)i[n]}},{key:"getLatestPosition",value:function(){return null==this.latestPoint?{x:this.scene.camera._viewport.min.x+10,y:this.scene.camera._viewport.min.y+10}:(this.scene.camera._viewport.containsPoint(this.latestPoint)||(this.latestPoint.x=this.scene.camera._viewport.min.x+10,this.latestPoint.y=this.latestPoint.y+50),{x:this.latestPoint.x,y:this.latestPoint.y})}},{key:"getCenterPosition",value:function(){return{x:this.scene.camera._position.x,y:this.scene.camera._position.y}}},{key:"addObject",value:function(t,e){var i=null,o={mode:this.mode,id:e.id,x:e.x,y:e.y,width:e.width,height:e.height};if("TEXT"==t){o.width=e.width||200,o.height=e.height||200,o.text=e.text||"";var s=n.Load("textOptionsCallback");"function"==typeof s&&(o=s(e.id,this,o)),null!=e.bgColor&&(o.bgColor=e.bgColor),null!=e.textColor&&(o.textColor=e.textColor),null!=e.font&&(o.font=e.font);var r=new T(o);i=this.scene.Add(r)}else if("IMAGE"==t){o.width=e.width||100,o.height=e.height||100,o.width<30&&(o.width=30),o.height<30&&(o.height=30),o.url=e.url;var a=new C(o);i=this.scene.Add(a)}else{o.width=e.width||160,o.height=e.height||55,o.dataSource=t;var h=n.Load("itemOptionsCallback");"function"==typeof h&&(o=h(e.id,this,o)),o.text=e.text||"",o.url=e.url,null!=e.color&&(o.color=e.color),null!=e.bgColor&&(o.bgColor=e.bgColor),null!=e.textColor&&(o.textColor=e.textColor);var c=new w(o);i=this.scene.Add(c)}return i}},{key:"modifyObject",value:function(t,e,i){var n=this.scene.getItem(t);null!=n&&(this.setIcon(n,e),this.setText(n,i.text),this.setUrl(n,i.url))}},{key:"removeObject",value:function(t){this.scene.Remove(t)}},{key:"getSelectedAllObjects",value:function(){return this.scene.searchItems({isSelected:!0,isLineSelected:!0})}},{key:"getSelectedLineObjects",value:function(){return this.scene.searchItems({isLineSelected:!0})}},{key:"getAllLineObjects",value:function(){return this.scene.searchInstance(k)}},{key:"getSelectedObjects",value:function(){return this.scene.searchItems({isSelected:!0})}},{key:"getAllItemObjects",value:function(){return this.scene.searchInstance(S)}},{key:"alignObjects",value:function(t,e){for(var i=null,n=null,o=null,s=null,r=0;r<t.length;r++)null==i&&(i=t[r]._boundbox.min.x),null==n&&(n=t[r]._boundbox.min.y),null==o&&(o=t[r]._boundbox.max.x),null==s&&(s=t[r]._boundbox.max.y),i>t[r]._boundbox.min.x&&(i=t[r]._boundbox.min.x),n>t[r]._boundbox.min.y&&(n=t[r]._boundbox.min.y),o<t[r]._boundbox.max.x&&(o=t[r]._boundbox.max.x),s<t[r]._boundbox.max.y&&(s=t[r]._boundbox.max.y);for(r=0;r<t.length;r++){var a=t[r]._boundbox,h={x:0,y:0};"LEFT"==e?h.x=i-a.min.x:"RIGHT"==e?h.x=o-a.max.x:"TOP"==e?h.y=n-a.min.y:"BOTTOM"==e&&(h.y=s-a.max.y),a.Translate(h)}}},{key:"setIcon",value:function(t,e){try{t.ChangeIcon(e)}catch(t){}}},{key:"setColor",value:function(t,e){try{t.ChangeColor(e)}catch(t){}}},{key:"setBgColor",value:function(t,e){try{t.ChangeBgColor(e)}catch(t){}}},{key:"setTextColor",value:function(t,e){try{t.ChangeTextColor(e)}catch(t){}}},{key:"setText",value:function(t,e){try{t.ChangeText(e)}catch(t){}}},{key:"setUrl",value:function(t,e){try{t.ChangeUrl(e)}catch(t){}}},{key:"setFont",value:function(t,e){try{t.ChangeFont(e)}catch(t){}}},{key:"setFontSize",value:function(t,e){try{t.ChangeFontSize(e)}catch(t){}}},{key:"setFontStyle",value:function(t,e){try{t.ChangeFontStyle(e)}catch(t){}}},{key:"setFontWeight",value:function(t,e){try{t.ChangeFontWeight(e)}catch(t){}}},{key:"setFontFace",value:function(t,e){try{t.ChangeFontFace(e)}catch(t){}}},{key:"blur",value:function(){var t=this.getSelectedAllObjects();for(var e in t)t[e].Toggle();try{var i=n.Load("CanvasBlur");"function"==typeof i&&(options=i("",this,{}))}catch(t){}}},{key:"changeLineStyle",value:function(t,e){t.ChangeLineStyle(e)}},{key:"removeObjects",value:function(t){for(var e in t)this.scene.Remove(t[e].id)}},{key:"removeAll",value:function(){this.RemoveAll()}},{key:"zoomIn",value:function(t){this.scene.camera.OffsetZoomTo(-t)}},{key:"zoomOut",value:function(t){this.scene.camera.OffsetZoomTo(t)}},{key:"loadJson",value:function(t,e){if(null!=t&&null!=t.objects&&t.objects.length>0){for(var i in t.objects){var n=t.objects[i];this.addObject(n.dataSource,n)}if(null!=t.links&&t.links.length>0)for(var o in t.links){var s=t.links[o],r=this.scene.getItem(s.source.id),a=this.scene.getItem(s.target.id);if(null!=r&&null!=a){var h=r["_"+s.source.direction+"Attacher"],c=a["_"+s.target.direction+"Attacher"];h.parentId=r.id,c.parentId=a.id,null!=h&&null!=c&&r._lineConnecting(this,h,c,s)}}null!=t.camera&&null!=t.camera.distance&&(this.scene.camera.MoveTo(t.camera.x,t.camera.y),this.scene.camera.ZoomTo(t.camera.distance)),e(this)}else console.log("Fail to Load : There are empty Data")}},{key:"getAllData",value:function(){var t=[],e=[],i=this.getAllItemObjects();for(var n in i)t.push(i[n].getSaveData());var o=this.getAllLineObjects();for(var s in o)e.push(o[s].getSaveData());return{objects:t,links:e,camera:{x:this.scene.camera.x,y:this.scene.camera.y,distance:this.scene.camera.distance}}}},{key:"chaptureImage",value:function(){return null}},{key:"Update",value:function(){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Update",this).call(this)}},{key:"Stop",value:function(){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Stop",this).call(this)}},{key:"Resize",value:function(t){x(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Resize",this).call(this,t),this.Render()}}]),e}(o);t.DataSource=n,t.init=e,Object.defineProperty(t,"__esModule",{value:!0})});
