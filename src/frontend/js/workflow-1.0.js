!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.webmaker={})}(this,function(t){"use strict";function e(t,e){var i=new L(t);return null!=e&&(i.HUD=new p(e),i.canvasUi=e),new R(i,e),i}var i=function(t,e){return e={exports:{}},t(e,e.exports),e.exports}(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});for(var i=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},n=(function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}()),o=(function t(e,i,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,i);if(void 0===o){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,i,n)}if("value"in o)return o.value;var r=o.get;return void 0!==r?r.call(n):void 0}),s=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},r=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},a={},h={},l=[],c=0;c<256;c++)l[c]=(c<16?"0":"")+c.toString(16);var u=function(){function t(){i(this,t)}return n(t,null,[{key:"UUID",value:function(){var t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return l[255&t]+l[t>>8&255]+l[t>>16&255]+l[t>>24&255]+"-"+l[255&e]+l[e>>8&255]+"-"+l[e>>16&15|64]+l[e>>24&255]+"-"+l[63&i|128]+l[i>>8&255]+"-"+l[i>>16&255]+l[i>>24&255]+l[255&n]+l[n>>8&255]+l[n>>16&255]+l[n>>24&255]}},{key:"Add",value:function(t,e){e.loaded=!1;var i=e.type,n=e.target;if("IMAGE"==i){var o=new Image;o.onload=function(){a[t]=o,e.loaded=!0},o.src=n}else"OBJECT"==i?(a[t]=n,e.loaded=!0):"TEXT"==i?(a[t]=n,e.loaded=!0):"MESH"==i?(a[t]=n,e.loaded=!0):"SOUND"==i?(a[t]=n,e.loaded=!0):"CALLBACK"!=i&&"LINK"!=i||("function"!=typeof n&&console.log("Warning!!! LINK target must be Function"),a[t]=n,e.loaded=!0);h[t]=e}},{key:"Remove",value:function(t){delete a[t],delete h[t]}},{key:"Load",value:function(t){return null==h[t]?null:!0===h[t].loaded?a[t]:"IMAGE"==h[t].type?"":void 0}},{key:"EncodeImageToBase64",value:function(t){var e=document.createElement("canvas");e.width=t.naturalWidth,e.height=t.naturalHeight,e.getContext("2d").drawImage(t,0,0);try{return e.toDataURL("image/png")}catch(t){return console.log(t),""}}}]),t}(),d=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,t),this.x=e,this.y=n}return n(t,[{key:"set",value:function(t,e){return this.x=t,this.y=e,this}},{key:"clone",value:function(){return new this.constructor(this.x,this.y)}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}},{key:"angle",value:function(){var t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t}},{key:"distanceTo",value:function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this}},{key:"multiplyScalar",value:function(t){return this.x*=t,this.y*=t,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"lenSq",value:function(){return this.x*this.x+this.y*this.y}},{key:"length",value:function(){return Math.sqrt(this.lenSq())}}]),t}(),y=function(){function t(e){i(this,t),this.stage=e,this._eventStoreList={},this._unitsFromEvents={},this.history={mousedown:{x:null,y:null},mouseup:{x:null,y:null},click:{x:null,y:null}}}return n(t,[{key:"_addUnitsFromEvents",value:function(t,e){for(var i in t)null==this._unitsFromEvents[i]&&(this._unitsFromEvents[i]=[]),this._unitsFromEvents[i].push(e)}},{key:"_removeUnitsFromEvents",value:function(t,e){var i=this._eventStoreList[t];for(var n in i)if((null==e||e==n)&&null!=this._unitsFromEvents[n])for(var o=0;o<this._unitsFromEvents[n].length;++o)if(this._unitsFromEvents[n][o].id==t){this._unitsFromEvents[n].splice(o,1);break}}},{key:"Add",value:function(t,e,i){null!=i&&this._addUnitsFromEvents(e,t),null!=i&&(e.parentId=i),this._eventStoreList[t.id]=e}},{key:"Remove",value:function(t){this._removeUnitsFromEvents(t),delete this._eventStoreList[t]}},{key:"FindItems",value:function(t,e,i){return void 0===i?this._getCollisionObject(this.stage.scene.getUnitArrays(),new d(t.x,t.y),e):this._getEventOrientedCollision(new d(t.x,t.y),e,i)}},{key:"FindItemOne",value:function(t,e){var i=this.FindItems(new d(t.x,t.y),1,e);return i.length>0?i[0]:null}},{key:"Trigger",value:function(t,e,i){if(this.setHistory(e,i.position),null!=t)for(var n in this._eventStoreList)if(n==t.id){var o=this._eventStoreList[t.id],s=o[e];if(void 0==s)return;if(void 0!==o.parentId&&(t.parentId=o.parentId),s instanceof Array)for(var r in s)s[r].call(t,this.stage,i);else s.call(t,this.stage,i)}}},{key:"getHistory",value:function(t){return this.history[t]}},{key:"setHistory",value:function(t,e){void 0!==this.history[t]&&(this.history[t].x=e.x,this.history[t].y=e.y)}},{key:"_getEventOrientedCollision",value:function(t,e,i){var n=[],o=this._unitsFromEvents[i];return null!=o&&(n=this._getCollisionObject(o,t,e)),n}},{key:"_getCollisionObject",value:function(t,e,i){for(var n=[],o=0,s=0;s<t.length;s++){var r=t[s];if(1!=r.hide&&(!0===r.CollisionCheck(e)&&(n.push(r),o++),null!=i&&i<=o))return n}return n}}]),t}(),v=function(){function t(){i(this,t),this.activeFPS=!1,this.activeUpdateLoop=!1,this.activeRenderLoop=!1,this.useUpdateLoop=!0,this.useRenderLoop=!0,this.fps=40}return n(t,[{key:"useUpdate",value:function(t){this.useUpdateLoop=t}},{key:"useRender",value:function(t){this.useRenderLoop=t}},{key:"Start",value:function(){var t=this;this.activeFPS=!0,this.Resume(),this.lastUpdate=Date.now(),this.d=0,!0===this.useUpdateLoop&&(this._Updateloop=setInterval(function(){t._UpdateLoop()},this.fps)),!0===this.useRenderLoop&&function e(){requestAnimationFrame(e),t.activeFPS&&t._RenderLoop()}()}},{key:"Resume",value:function(){!0===this.useUpdateLoop&&(this.activeUpdateLoop=!0),!0===this.useRenderLoop&&(this.activeRenderLoop=!0)}},{key:"Pause",value:function(){!0===this.useUpdateLoop&&(this.activeUpdateLoop=!1),!0===this.useRenderLoop&&(this.activeRenderLoop=!1)}},{key:"Stop",value:function(){this.activeFPS=!1,!0===this.useUpdateLoop&&clearInterval(this._Updateloop)}},{key:"_UpdateLoop",value:function(){if(this.activeUpdateLoop){var t=Date.now(),e=(t-this.lastUpdate)/this.fps;this.Update(this.d,e),this.lastUpdate=t,this.d+=e}}},{key:"_RenderLoop",value:function(){this.activeRenderLoop&&this.Render()}},{key:"Update",value:function(){}},{key:"Render",value:function(){}}]),t}(),f=function(){function t(e,n){var o=this;i(this,t),this.stage=e,this.socketStore={},this._socketList={},n.sockets.on("connection",function(t){t.id=Math.random().toString(36).slice(2),o._socketList[t.id]=t,o._ConnectSocket(t),t.on("disconnect",function(){o._DisConnectSocket(t)})})}return n(t,[{key:"_ConnectSocket",value:function(t){var e=this;this.socketStore._connect&&this.socketStore._connect.call(this.stage,t);for(var i in this.socketStore)!function(i){0!=i.indexOf("_")&&t.on(i,function(n){e.socketStore[i].call(e.stage,n,t)})}(i);return!0}},{key:"_DisConnectSocket",value:function(t){delete this._socketList[t.id],this.socketStore._disconnect&&this.socketStore._disconnect.call(this.stage,t)}},{key:"Add",value:function(t){this.socketStore=t}},{key:"EmitAllSockets",value:function(t,e){for(var i in this._socketList)this._socketList[i].emit(t,e)}},{key:"getSocket",value:function(t){return this._socketList[t]}},{key:"Update",value:function(t,e,i){for(var n in this._socketList){var o=this._socketList[n];t.length>0&&o.emit("_init",t),e.length>0&&o.emit("_update",e),i.length>0&&o.emit("_remove",i)}}}]),t}(),p=function(t){function e(t,n){var o=t.id;i(this,e);var s=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return s.useRender(!1),s.sceneList={},s.id=o,s.SocketStore=new f(s,n),s.initPack=[],s.updatePack=[],s.removePack=[],s.initLockedList=[],s.updateLockedList=[],s.removeLockedList=[],s.locked=!1,s}return s(e,t),n(e,[{key:"getSceneItemPacks",value:function(t){var e=this.sceneList[t],i=[];if(e){var n=e.getItemArrays(),o=!0,s=!1,r=void 0;try{for(var a,h=n[Symbol.iterator]();!(o=(a=h.next()).done);o=!0){var l=a.value;i.push(l.getPack())}}catch(t){s=!0,r=t}finally{try{!o&&h.return&&h.return()}finally{if(s)throw r}}}return i}},{key:"setInitPack",value:function(t){null!=t&&(!0===this.locked?this.initLockedList.push(t):this.initPack.push(t))}},{key:"setUpdatePack",value:function(t){null!=t&&(!0===this.locked?this.updateLockedList.push(t):this.updatePack.push(t))}},{key:"setRemovePack",value:function(t){null!=t&&(!0===this.locked?this.removeLockedList.push(t):this.removePack.push(t))}},{key:"lockPack",value:function(){this.initLockedList=[],this.updateLockedList=[],this.removeLockedList=[],this.locked=!0}},{key:"unLockPack",value:function(){this.initPack=[],this.updatePack=[],this.removePack=[];for(var t in this.initLockedList)this.initPack.push(this.initLockedList[t]);for(var e in this.updateLockedList)this.updatePack.push(this.updateLockedList[e]);for(var i in this.removeLockedList)this.removePack.push(this.removeLockedList[i]);this.locked=!1}},{key:"Update",value:function(t,e){this.lockPack(),this.SocketStore&&this.SocketStore.Update(this.initPack,this.updatePack,this.removePack),this.unLockPack()}}]),e}(v),_={basic:{uniform:[],vs:"attribute vec2 a_position;\r\nattribute vec2 a_texCoord;\r\n\r\nvarying vec2 v_texCoord;\r\nvoid main(){\r\n\tgl_Position = vec4(a_position, 1.0, 1.0);\r\n\tv_texCoord = a_texCoord;\r\n}\r\n",fs:"precision mediump float;\r\nuniform sampler2D u_image;\r\nvarying vec2 v_texCoord;\r\n\r\nvoid main(){\r\n\tgl_FragColor = texture2D(u_image, v_texCoord);\r\n}\r\n"}},x=function(){function t(e){i(this,t),this.gl=e,this.getProgram()}return n(t,[{key:"getProgram",value:function(){var t=this.gl,e=this._getShader(_.basic.vs,"VERTEX"),i=this._getShader(_.basic.fs,"FRAGMENT");if(e&&i){if(this.program=t.createProgram(),t.attachShader(this.program,e),t.attachShader(this.program,i),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))return console.log("Error Linking PROGRAM :"+t.getProgramInfoLog(this.program)),null;if(t.validateProgram(this.program),!t.getProgramParameter(this.program,t.VALIDATE_STATUS))return console.log("Error Validating PROGRAM :"+t.getProgramInfoLog(this.program)),null;t.detachShader(this.program,e),t.detachShader(this.program,i),t.deleteShader(e),t.deleteShader(i),t.useProgram(null)}}},{key:"_getShader",value:function(t,e){var i=this.gl,n=i.VERTEX_SHADER;"FRAGMENT"===e&&(n=i.FRAGMENT_SHADER);var o=i.createShader(n);return i.shaderSource(o,t),i.compileShader(o),i.getShaderParameter(o,i.COMPILE_STATUS)?o:(console.log("Error "+e+" Shader :"+i.getShaderInfoLog(o)),null)}}]),t}(),m=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;i(this,t),this.isVec3=!0,this.x=e,this.y=n,this.z=o}return n(t,[{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"clamp",value:function(t,e){return this.x=Math.min(e.x,Math.max(t.x,this.x)),this.y=Math.min(e.y,Math.max(t.y,this.y)),this.z=Math.min(e.z,Math.max(t.z,this.z)),this}},{key:"angleTo",value:function(t){var e=this.x*this.x+this.y*this.y+this.z*this.z,i=t.x*t.x+t.y*t.y+t.z*t.z,n=this.dot(t)/Math.sqrt(e*i);return Math.acos(Math.min(1,Math.max(-1,n)))}},{key:"distanceTo",value:function(t){var e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return Math.sqrt(e*e+i*i+n*n)}},{key:"dot",value:function(t){return t.x*this.x+t.y*this.y+t.z*this.z}},{key:"cross",value:function(t){var e=this.x,i=this.y,n=this.z;return this.x=i*t.z-n*t.y,this.y=n*t.x-e*t.z,this.z=e*t.y-i*t.x,this}},{key:"crossVec",value:function(t,e){var i=t.x,n=t.y,o=t.z;return this.x=n*e.z-o*e.y,this.y=o*e.x-i*e.z,this.z=i*e.y-n*e.x,this}},{key:"set",value:function(t,e,i){return this.x=t,this.y=e,this.z=i,this}},{key:"setScalar",value:function(t){return this.x=t,this.y=t,this.z=t,this}},{key:"setX",value:function(t){return this.x=t,this}},{key:"setY",value:function(t){return this.y=t,this}},{key:"setZ",value:function(t){return this.z=t,this}},{key:"setComponent",value:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}},{key:"getComponent",value:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}},{key:"add",value:function(t,e){return void 0!==e?this.addVectors(t,e):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}},{key:"sub",value:function(t,e){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}},{key:"multiply",value:function(t,e){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return this.x*=t,this.y*=t,this.z*=t,this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}},{key:"applyMatrix3",value:function(t){var e=this.x,i=this.y,n=this.z,o=t.ele;return this.x=o[0]*e+o[3]*i+o[6]*n,this.y=o[1]*e+o[4]*i+o[7]*n,this.z=o[2]*e+o[5]*i+o[8]*n,this}},{key:"applyMatrix4",value:function(t){var e=this.x,i=this.y,n=this.z,o=t.ele,s=1/(o[3]*e+o[7]*i+o[11]*n+o[15]);return this.x=(o[0]*e+o[4]*i+o[8]*n+o[12])*s,this.y=(o[1]*e+o[5]*i+o[9]*n+o[13])*s,this.z=(o[2]*e+o[6]*i+o[10]*n+o[14])*s,this}},{key:"applyQuaternion",value:function(t){var e=this.x,i=this.y,n=this.z,o=t.x,s=t.y,r=t.z,a=t.w,h=a*e+s*n-r*i,l=a*i+r*e-o*n,c=a*n+o*i-s*e,u=-o*e-s*i-r*n;return this.x=h*a+u*-o+l*-r-c*-s,this.y=l*a+u*-s+c*-o-h*-r,this.z=c*a+u*-r+h*-s-l*-o,this}},{key:"transformDirection",value:function(t){var e=this.x,i=this.y,n=this.z,o=t.ele;return this.x=o[0]*e+o[4]*i+o[8]*n,this.y=o[1]*e+o[5]*i+o[9]*n,this.z=o[2]*e+o[6]*i+o[10]*n,this.normalize()}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clampScalar",value:function(e,i){return this.clamp(new t(e,e,e),new t(i,i,i))}},{key:"clampLength",value:function(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}},{key:"floor",value:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}},{key:"ceil",value:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}},{key:"round",value:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}},{key:"roundToZero",value:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"manhattanLength",value:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}},{key:"normalize",value:function(){return this.divideScalar(this.length()||1)}},{key:"setLength",value:function(t){return this.normalize().multiplyScalar(t)}},{key:"lerp",value:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}},{key:"lerpVectors",value:function(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t)}},{key:"projectOnVector",value:function(t){var e=t.dot(this)/t.lengthSq();return this.copy(t).multiplyScalar(e)}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}},{key:"manhattanDistanceTo",value:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}},{key:"setFromSpherical",value:function(t){var e=Math.sin(t.phi)*t.radius;return this.x=e*Math.sin(t.theta),this.y=Math.cos(t.phi)*t.radius,this.z=e*Math.cos(t.theta),this}},{key:"setFromCylindrical",value:function(t){return this.x=t.radius*Math.sin(t.theta),this.y=t.y,this.z=t.radius*Math.cos(t.theta),this}},{key:"setFromMatrixPosition",value:function(t){var e=t.ele;return this.x=e[12],this.y=e[13],this.z=e[14],this}},{key:"setFromMatrixScale",value:function(t){var e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}},{key:"setFromMatrixColumn",value:function(t,e){return this.fromArray(t.ele,4*e)}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}},{key:"fromBufferAttribute",value:function(t,e,i){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}}]),t}(),g=function(){function t(){i(this,t),this.isMat4=!0,this.ele=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.lookVecX=new m,this.lookVecY=new m,this.lookVecZ=new m,this.vecApplyBuff=new m,this.extractRotVec=new m}return n(t,[{key:"set",value:function(t,e,i,n,o,s,r,a,h,l,c,u,d,y,v,f){var p=this.ele;return p[0]=t,p[4]=e,p[8]=i,p[12]=n,p[1]=o,p[5]=s,p[9]=r,p[13]=a,p[2]=h,p[6]=l,p[10]=c,p[14]=u,p[3]=d,p[7]=y,p[11]=v,p[15]=f,this}},{key:"identity",value:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}},{key:"clone",value:function(){return(new t).fromArray(this.ele)}},{key:"copy",value:function(t){var e=this.ele,i=t.ele;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}},{key:"copyPosition",value:function(t){var e=this.ele,i=t.ele;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}},{key:"extractBasis",value:function(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}},{key:"makeBasis",value:function(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}},{key:"extractRotation",value:function(t){var e=this.extractRotVec,i=this.ele,n=t.ele,o=1/e.setFromMatrixColumn(t,0).length(),s=1/e.setFromMatrixColumn(t,1).length(),r=1/e.setFromMatrixColumn(t,2).length();return i[0]=n[0]*o,i[1]=n[1]*o,i[2]=n[2]*o,i[4]=n[4]*s,i[5]=n[5]*s,i[6]=n[6]*s,i[8]=n[8]*r,i[9]=n[9]*r,i[10]=n[10]*r,this}},{key:"makeRotationFromEuler",value:function(t){var e=this.ele,i=t.x,n=t.y,o=t.z,s=Math.cos(i),r=Math.sin(i),a=Math.cos(n),h=Math.sin(n),l=Math.cos(o),c=Math.sin(o);if("XYZ"===t.order){var u=s*l,d=s*c,y=r*l,v=r*c;e[0]=a*l,e[4]=-a*c,e[8]=h,e[1]=d+y*h,e[5]=u-v*h,e[9]=-r*a,e[2]=v-u*h,e[6]=y+d*h,e[10]=s*a}else if("YXZ"===t.order){var f=a*l,p=a*c,_=h*l,x=h*c;e[0]=f+x*r,e[4]=_*r-p,e[8]=s*h,e[1]=s*c,e[5]=s*l,e[9]=-r,e[2]=p*r-_,e[6]=x+f*r,e[10]=s*a}else if("ZXY"===t.order){var f=a*l,p=a*c,_=h*l,x=h*c;e[0]=f-x*r,e[4]=-s*c,e[8]=_+p*r,e[1]=p+_*r,e[5]=s*l,e[9]=x-f*r,e[2]=-s*h,e[6]=r,e[10]=s*a}else if("ZYX"===t.order){var u=s*l,d=s*c,y=r*l,v=r*c;e[0]=a*l,e[4]=y*h-d,e[8]=u*h+v,e[1]=a*c,e[5]=v*h+u,e[9]=d*h-y,e[2]=-h,e[6]=r*a,e[10]=s*a}else if("YZX"===t.order){var m=s*a,g=s*h,k=r*a,b=r*h;e[0]=a*l,e[4]=b-m*c,e[8]=k*c+g,e[1]=c,e[5]=s*l,e[9]=-r*l,e[2]=-h*l,e[6]=g*c+k,e[10]=m-b*c}else if("XZY"===t.order){var m=s*a,g=s*h,k=r*a,b=r*h;e[0]=a*l,e[4]=-c,e[8]=h*l,e[1]=m*c+b,e[5]=s*l,e[9]=g*c-k,e[2]=k*c-g,e[6]=r*l,e[10]=b*c+m}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}},{key:"makeRotationFromQuaternion",value:function(t){var e=this.ele,i=t._x,n=t._y,o=t._z,s=t._w,r=i+i,a=n+n,h=o+o,l=i*r,c=i*a,u=i*h,d=n*a,y=n*h,v=o*h,f=s*r,p=s*a,_=s*h;return e[0]=1-(d+v),e[4]=c-_,e[8]=u+p,e[1]=c+_,e[5]=1-(l+v),e[9]=y-f,e[2]=u-p,e[6]=y+f,e[10]=1-(l+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}},{key:"lookAt",value:function(t,e,i){var n=this.ele,o=this.lookVecX,s=this.lookVecY,r=this.lookVecZ;return r.subVectors(t,e),0===r.lengthSq()&&(r.z=1),r.normalize(),o.crossVectors(i,r),0===o.lengthSq()&&(1===Math.abs(i.z)?r.x+=1e-4:r.z+=1e-4,r.normalize(),o.crossVectors(i,r)),o.normalize(),s.crossVectors(r,o),n[0]=o.x,n[4]=s.x,n[8]=r.x,n[1]=o.y,n[5]=s.y,n[9]=r.y,n[2]=o.z,n[6]=s.z,n[10]=r.z,this}},{key:"multiply",value:function(t,e){return null!=e?this.multiplyMatrices(t,e):this.multiplyMatrices(this,t)}},{key:"premultiply",value:function(t){return this.multiplyMatrices(t,this)}},{key:"multiplyMatrices",value:function(t,e){var i=t.ele,n=e.ele,o=this.ele,s=i[0],r=i[4],a=i[8],h=i[12],l=i[1],c=i[5],u=i[9],d=i[13],y=i[2],v=i[6],f=i[10],p=i[14],_=i[3],x=i[7],m=i[11],g=i[15],k=n[0],b=n[4],S=n[8],T=n[12],w=n[1],C=n[5],I=n[9],O=n[13],A=n[2],P=n[6],z=n[10],L=n[14],R=n[3],M=n[7],E=n[11],D=n[15];return o[0]=s*k+r*w+a*A+h*R,o[4]=s*b+r*C+a*P+h*M,o[8]=s*S+r*I+a*z+h*E,o[12]=s*T+r*O+a*L+h*D,o[1]=l*k+c*w+u*A+d*R,o[5]=l*b+c*C+u*P+d*M,o[9]=l*S+c*I+u*z+d*E,o[13]=l*T+c*O+u*L+d*D,o[2]=y*k+v*w+f*A+p*R,o[6]=y*b+v*C+f*P+p*M,o[10]=y*S+v*I+f*z+p*E,o[14]=y*T+v*O+f*L+p*D,o[3]=_*k+x*w+m*A+g*R,o[7]=_*b+x*C+m*P+g*M,o[11]=_*S+x*I+m*z+g*E,o[15]=_*T+x*O+m*L+g*D,this}},{key:"multiplyScalar",value:function(t){var e=this.ele;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}},{key:"applyToBufferAttribute",value:function(t){for(var e=this.vecApplyBuff,i=0,n=t.count;i<n;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix4(this),t.setXYZ(i,e.x,e.y,e.z);return t}},{key:"determinant",value:function(){var t=this.ele,e=t[0],i=t[4],n=t[8],o=t[12],s=t[1],r=t[5],a=t[9],h=t[13],l=t[2],c=t[6],u=t[10],d=t[14];return t[3]*(+o*a*c-n*h*c-o*r*u+i*h*u+n*r*d-i*a*d)+t[7]*(+e*a*d-e*h*u+o*s*u-n*s*d+n*h*l-o*a*l)+t[11]*(+e*h*c-e*r*d-o*s*c+i*s*d+o*r*l-i*h*l)+t[15]*(-n*r*l-e*a*c+e*r*u+n*s*c-i*s*u+i*a*l)}},{key:"transpose",value:function(){var t,e=this.ele;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}},{key:"setPosition",value:function(t){var e=this.ele;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this}},{key:"getInverse",value:function(t,e){var i=this.ele,n=t.ele,o=n[0],s=n[1],r=n[2],a=n[3],h=n[4],l=n[5],c=n[6],u=n[7],d=n[8],y=n[9],v=n[10],f=n[11],p=n[12],_=n[13],x=n[14],m=n[15],g=y*x*u-_*v*u+_*c*f-l*x*f-y*c*m+l*v*m,k=p*v*u-d*x*u-p*c*f+h*x*f+d*c*m-h*v*m,b=d*_*u-p*y*u+p*l*f-h*_*f-d*l*m+h*y*m,S=p*y*c-d*_*c-p*l*v+h*_*v+d*l*x-h*y*x,T=o*g+s*k+r*b+a*S;if(0===T){var w="Matrix4 .getInverse() can't invert matrix, determinant is 0";if(!0===e)throw new Error(w);return console.warn(w),this.identity()}var C=1/T;return i[0]=g*C,i[1]=(_*v*a-y*x*a-_*r*f+s*x*f+y*r*m-s*v*m)*C,i[2]=(l*x*a-_*c*a+_*r*u-s*x*u-l*r*m+s*c*m)*C,i[3]=(y*c*a-l*v*a-y*r*u+s*v*u+l*r*f-s*c*f)*C,i[4]=k*C,i[5]=(d*x*a-p*v*a+p*r*f-o*x*f-d*r*m+o*v*m)*C,i[6]=(p*c*a-h*x*a-p*r*u+o*x*u+h*r*m-o*c*m)*C,i[7]=(h*v*a-d*c*a+d*r*u-o*v*u-h*r*f+o*c*f)*C,i[8]=b*C,i[9]=(p*y*a-d*_*a-p*s*f+o*_*f+d*s*m-o*y*m)*C,i[10]=(h*_*a-p*l*a+p*s*u-o*_*u-h*s*m+o*l*m)*C,i[11]=(d*l*a-h*y*a-d*s*u+o*y*u+h*s*f-o*l*f)*C,i[12]=S*C,i[13]=(d*_*r-p*y*r+p*s*v-o*_*v-d*s*x+o*y*x)*C,i[14]=(p*l*r-h*_*r-p*s*c+o*_*c+h*s*x-o*l*x)*C,i[15]=(h*y*r-d*l*r+d*s*c-o*y*c-h*s*v+o*l*v)*C,this}},{key:"scale",value:function(t){var e=this.ele,i=t.x,n=t.y,o=t.z;return e[0]*=i,e[4]*=n,e[8]*=o,e[1]*=i,e[5]*=n,e[9]*=o,e[2]*=i,e[6]*=n,e[10]*=o,e[3]*=i,e[7]*=n,e[11]*=o,this}},{key:"getMaxScaleOnAxis",value:function(){var t=this.ele,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,n))}},{key:"makeTranslation",value:function(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}},{key:"makeRotationX",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}},{key:"makeRotationY",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}},{key:"makeRotationZ",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}},{key:"makeRotationAxis",value:function(t,e){var i=Math.cos(e),n=Math.sin(e),o=1-i,s=t.x,r=t.y,a=t.z,h=o*s,l=o*r;return this.set(h*s+i,h*r-n*a,h*a+n*r,0,h*r+n*a,l*r+i,l*a-n*s,0,h*a-n*r,l*a+n*s,o*a*a+i,0,0,0,0,1),this}},{key:"makeScale",value:function(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}},{key:"makeShear",value:function(t,e,i){return this.set(1,e,i,0,t,1,i,0,t,e,1,0,0,0,0,1),this}},{key:"compose",value:function(t,e,i){return this.makeRotationFromQuaternion(e),this.scale(i),this.setPosition(t),this}},{key:"makePerspective",value:function(t,e,i,n,o,s){var r=this.ele,a=2*o/(e-t),h=2*o/(i-n),l=(e+t)/(e-t),c=(i+n)/(i-n),u=-(s+o)/(s-o),d=-2*s*o/(s-o);return r[0]=a,r[4]=0,r[8]=l,r[12]=0,r[1]=0,r[5]=h,r[9]=c,r[13]=0,r[2]=0,r[6]=0,r[10]=u,r[14]=d,r[3]=0,r[7]=0,r[11]=-1,r[15]=0,this}},{key:"makeOrthographic",value:function(t,e,i,n,o,s){var r=this.ele,a=1/(e-t),h=1/(i-n),l=1/(s-o),c=(e+t)*a,u=(i+n)*h,d=(s+o)*l;return r[0]=2*a,r[4]=0,r[8]=0,r[12]=-c,r[1]=0,r[5]=2*h,r[9]=0,r[13]=-u,r[2]=0,r[6]=0,r[10]=-2*l,r[14]=-d,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this}},{key:"equals",value:function(t){for(var e=this.ele,i=t.ele,n=0;n<16;n++)if(e[n]!==i[n])return!1;return!0}},{key:"fromArray",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<16;i++)this.ele[i]=t[i+e];return this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this.ele;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}]),t}(),k=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;i(this,t),this._x=e,this._y=n,this._z=o,this._w=s,this.UnitVec3=new m,this.EPS=1e-6}return n(t,[{key:"clone",value:function(){return new this.constructor(this._x,this._y,this._z,this._w)}},{key:"set",value:function(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this.onChangeCallback(),this}},{key:"copy",value:function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this.onChangeCallback(),this}},{key:"inverse",value:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this}},{key:"dot",value:function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}},{key:"slerp",value:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this._x,n=this._y,o=this._z,s=this._w,r=s*t._w+i*t._x+n*t._y+o*t._z;if(r<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,r=-r):this.copy(t),r>=1)return this._w=s,this._x=i,this._y=n,this._z=o,this;var a=Math.sqrt(1-r*r);if(Math.abs(a)<.001)return this._w=.5*(s+this._w),this._x=.5*(i+this._x),this._y=.5*(n+this._y),this._z=.5*(o+this._z),this;var h=Math.atan2(a,r),l=Math.sin((1-e)*h)/a,c=Math.sin(e*h)/a;return this._w=s*l+this._w*c,this._x=i*l+this._x*c,this._y=n*l+this._y*c,this._z=o*l+this._z*c,this.onChangeCallback(),this}},{key:"setFromEuler",value:function(t,e){var i=t._x,n=t._y,o=t._z,s=t.order,r=Math.cos,a=Math.sin,h=r(i/2),l=r(n/2),c=r(o/2),u=a(i/2),d=a(n/2),y=a(o/2);return"XYZ"===s?(this._x=u*l*c+h*d*y,this._y=h*d*c-u*l*y,this._z=h*l*y+u*d*c,this._w=h*l*c-u*d*y):"YXZ"===s?(this._x=u*l*c+h*d*y,this._y=h*d*c-u*l*y,this._z=h*l*y-u*d*c,this._w=h*l*c+u*d*y):"ZXY"===s?(this._x=u*l*c-h*d*y,this._y=h*d*c+u*l*y,this._z=h*l*y+u*d*c,this._w=h*l*c-u*d*y):"ZYX"===s?(this._x=u*l*c-h*d*y,this._y=h*d*c+u*l*y,this._z=h*l*y-u*d*c,this._w=h*l*c+u*d*y):"YZX"===s?(this._x=u*l*c+h*d*y,this._y=h*d*c+u*l*y,this._z=h*l*y-u*d*c,this._w=h*l*c-u*d*y):"XZY"===s&&(this._x=u*l*c-h*d*y,this._y=h*d*c-u*l*y,this._z=h*l*y+u*d*c,this._w=h*l*c+u*d*y),!1!==e&&this.onChangeCallback(),this}},{key:"setFromAxisAngle",value:function(t,e){var i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this.onChangeCallback(),this}},{key:"setFromRotationMatrix",value:function(t){var e,i=t.elements,n=i[0],o=i[4],s=i[8],r=i[1],a=i[5],h=i[9],l=i[2],c=i[6],u=i[10],d=n+a+u;return d>0?(e=.5/Math.sqrt(d+1),this._w=.25/e,this._x=(c-h)*e,this._y=(s-l)*e,this._z=(r-o)*e):n>a&&n>u?(e=2*Math.sqrt(1+n-a-u),this._w=(c-h)/e,this._x=.25*e,this._y=(o+r)/e,this._z=(s+l)/e):a>u?(e=2*Math.sqrt(1+a-n-u),this._w=(s-l)/e,this._x=(o+r)/e,this._y=.25*e,this._z=(h+c)/e):(e=2*Math.sqrt(1+u-n-a),this._w=(r-o)/e,this._x=(s+l)/e,this._y=(h+c)/e,this._z=.25*e),this.onChangeCallback(),this}},{key:"setFromUnitVectors",value:function(t,e){var i=this.UnitVec3;return this.r=t.dot(e)+1,this.r<this.EPS?(this.r=0,Math.abs(t.x)>Math.abs(t.z)?i.set(-t.y,t.x,0):i.set(0,-t.z,t.y)):i.crossVectors(t,e),this._x=i.x,this._y=i.y,this._z=i.z,this._w=this.r,this.normalize()}},{key:"lengthSq",value:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}},{key:"length",value:function(){return Math.sqrt(this.lengthSq())}},{key:"normalize",value:function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this.onChangeCallback(),this}},{key:"multiply",value:function(t,e){return void 0!==e?this.multiplyQuaternions(t,e):this.multiplyQuaternions(this,t)}},{key:"premultiply",value:function(t){return this.multiplyQuaternions(t,this)}},{key:"multiplyQuaternions",value:function(t,e){var i=t._x,n=t._y,o=t._z,s=t._w,r=e._x,a=e._y,h=e._z,l=e._w;return this._x=i*l+s*r+n*h-o*a,this._y=n*l+s*a+o*r-i*h,this._z=o*l+s*h+i*a-n*r,this._w=s*l-i*r-n*a-o*h,this.onChangeCallback(),this}},{key:"equals",value:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this.onChangeCallback(),this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}},{key:"onChange",value:function(t){return this.onChangeCallback=t,this}},{key:"onChangeCallback",value:function(){}}]),t}(),b=function(){function t(){i(this,t),this.type="Camera",this.isCamera=!0,this.matrixWorldInverse=new g,this.projectionMatrix=new g,this.quat=new k}return n(t,[{key:"copy",value:function(e,i){return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"copy",this).call(this,this,e,i),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"getWorldDirection",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new m,e=this.quat;return this.getWorldQuaternion(e),t.set(0,0,-1).applyQuaternion(e)}},{key:"updateMatrixWorld",value:function(e){o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateMatrixWorld",this).call(this,e),this.matrixWorldInverse.getInverse(this.matrixWorld)}}]),t}(),S=function(){function t(e){i(this,t),this.gl=e}return n(t,[{key:"Remove",value:function(t){}},{key:"Add",value:function(t){t instanceof b&&console.log("camera")}},{key:"Start",value:function(){}},{key:"Update",value:function(){}},{key:"Render",value:function(){}},{key:"Stop",value:function(){}},{key:"Resize",value:function(t){}}]),t}(),T=function(t){function e(t){var n=t.id,o=t.canvas,s=void 0===o?null:o;i(this,e);var a=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a._currScene=null,a.id=n,a.ctx=a._WebGLContext(s),a}return s(e,t),n(e,[{key:"_WebGLContext",value:function(t){this.canvas=t;var e=null;if(null==this.canvas)return console.log("No canvas"),null;for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],n=0;n<i.length;++n){try{e=this.canvas.getContext(i[n])}catch(t){}if(e)break}return null==e?(console.log("WebGL Initializing Fail"),null):e}},{key:"Start",value:function(){if(null==this._currScene)return void console.log("Scene is Empty!");o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Start",this).call(this),this._currScene.Start()}},{key:"Update",value:function(){this._currScene.Update()}},{key:"Render",value:function(){this._currScene.Render()}},{key:"Stop",value:function(){this._currScene.Stop(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Stop",this).call(this)}},{key:"Resize",value:function(t){this._currScene.Resize(t)}},{key:"scene",get:function(){return this._currScene},set:function(t){this.Pause(),null==t?null!=this._currScene&&this._currScene.Stop():this._currScene=new t(this.ctx),this.Resume()}}]),e}(v),w=function(){function t(e,n){i(this,t),this.stage=e,this.socket=n}return n(t,[{key:"Add",value:function(t){var e=this;for(var i in t)!function(i){e.socket.on(i,function(n){t[i].call(e.stage,n,e.socket)})}(i)}},{key:"Trigger",value:function(t,e){this.socket.emit(t,e)}},{key:"Destroy",value:function(){this.socket.close()}}]),t}(),C=function(){function t(e,n){i(this,t),this.stage=e,this.socketStore={},this.id=Math.random().toString(36).slice(2),this.Add(n),this.stage.initPack=[],this.stage.updatePack=[],this.stage.removePack=[]}return n(t,[{key:"Add",value:function(t){for(var e in t)this.socketStore[e]=t[e]}},{key:"Trigger",value:function(t,e){var i=this,n={id:this.id,emit:function(t,e){i.socketStore[t].call(i.stage,e,null)}};this.socketStore[t].call(this.stage,e,n)}},{key:"Destroy",value:function(){}},{key:"ConnectSocket",value:function(){var t=this,e={id:this.id,emit:function(e,i){t.socketStore[e].call(t.stage,i,null)}};this.socketStore._connect&&this.socketStore._connect.call(this.stage,e)}},{key:"EmitAllSockets",value:function(t,e){var i=this,n={id:this.id,emit:function(t,e){i.socketStore[t].call(i.stage,e,null)}};this.socketStore[t].call(this.stage,e,n)}},{key:"Update",value:function(t,e){var i=this,n={id:this.id,emit:function(t,e){i.socketStore[t].call(i.stage,e,null)}},o=this.stage.scene,s=o.getItems();for(var r in s){var a=s[r].Update(t,e,o);null!=a&&this.stage.updatePack.push(a)}this.stage.initPack.length>0&&this.socketStore._init.call(this.stage,this.stage.initPack,n),this.stage.updatePack.length>0&&this.socketStore._update.call(this.stage,this.stage.updatePack,n),this.stage.removePack.length>0&&this.socketStore._remove.call(this.stage,this.stage.removePack,n),this.stage.initPack=[],this.stage.updatePack=[],this.stage.removePack=[]}}]),t}(),I=function(t){function e(t,n){var o=t.id,s=t.canvas,a=void 0===s?null:s;i(this,e);var h=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return h.id=o||"S"+Math.random().toString(36).slice(2),h._currScene=null,h.ctx=h._GetContext(a),h.Resize(),h.EventStore=new y(h),void 0!==n&&void 0!==n.io?(h.SocketStore=new w(h,n),h.useUpdate(!1)):h.SocketStore=new C(h,n),h}return s(e,t),n(e,[{key:"_GetContext",value:function(t){this.canvas=t;var e=null;if(null==this.canvas)return console.log("No canvas"),null;try{e=this.canvas.getContext("2d")}catch(t){}return null==e?(console.log("Canvas Initializing Fail"),null):e}},{key:"Start",value:function(){if(null==this._currScene)return void console.log("Scene is Empty!");o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Start",this).call(this),this._currScene.Start()}},{key:"Update",value:function(t,e){null!=this.SocketStore&&this.SocketStore.Update(t,e),this._currScene.Update(t,e)}},{key:"Render",value:function(t,e){this._currScene.Render(t,e)}},{key:"Stop",value:function(){this._currScene.Stop(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Stop",this).call(this)}},{key:"Resize",value:function(t){this.width=this.ctx.canvas.offsetWidth,this.height=this.ctx.canvas.offsetHeight,null!=this._currScene&&this._currScene.Resize(t,{width:this.width,height:this.height})}},{key:"RemoveAll",value:function(){this.scene.RemoveAll()}},{key:"Destroy",value:function(){this.SocketStore&&this.SocketStore.Destroy()}},{key:"scene",get:function(){return this._currScene},set:function(t){null==t?null!=this._currScene&&this._currScene.Stop():(null!=this._currScene&&(this._currScene.Stop(),this._currScene.RemoveAll()),this._currScene=new t(this,{width:this.width,height:this.height}))}}]),e}(v),O=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new d(0,0),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new d(0,0);i(this,t),this.min=e,this.max=n}return n(t,[{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"set",value:function(t,e){return this.min.copy(t),this.max.copy(e),this}},{key:"setFromXYWH",value:function(t){this.min.x=t.x,this.min.y=t.y,this.max.x=t.width+t.x,this.max.y=t.height+t.y}},{key:"setFromPoints",value:function(t){for(var e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}},{key:"isEmpty",value:function(){return this.max.x<this.min.x||this.max.y<this.min.y}},{key:"setCenter",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new d(0,0),e=this.getCenter(),i=e.subVectors(t,e);this.translate(i)}},{key:"getCenter",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new d(0,0)).addVectors(this.min,this.max).multiplyScalar(.5)}},{key:"getSize",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new d(0,0)).subVectors(this.max,this.min)}},{key:"setSize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new d(0,0);return this.max.x=this.min.x+t.x,this.max.y=this.min.y+t.y,this}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"expandByVector",value:function(t){return this.min.sub(t),this.max.add(t),this}},{key:"expandByScalar",value:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this}},{key:"containsPoint",value:function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)}},{key:"containsBox",value:function(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}},{key:"clampPoint",value:function(t){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:new d).copy(t).clamp(this.min,this.max)}},{key:"intersect",value:function(t){return this.min.max(t.min),this.max.min(t.max),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"translate",value:function(t){return this.min.add(t),this.max.add(t),this}},{key:"reconstruct",value:function(){var t=this.min.x,e=this.min.y,i=this.max.x,n=this.max.y;this.min.x=Math.min(t,i),this.min.y=Math.min(e,n),this.max.x=Math.max(t,i),this.max.y=Math.max(e,n)}},{key:"equals",value:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}]),t}(),A=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t),this.id=e.id||"I"+Math.random().toString(36).slice(2),this._eventStore=void 0,this.hide=!1,this.order=e.order||0}return n(t,[{key:"Hide",value:function(){this.hide=!0}},{key:"Show",value:function(){this.hide=!1}},{key:"CollisionCheck",value:function(t){}},{key:"Picker",value:function(t){}},{key:"Update",value:function(t,e,i,n){}},{key:"UpdateServer",value:function(t,e){}},{key:"Render",value:function(t,e){}},{key:"RenderBefore",value:function(t,e){}},{key:"RenderAfter",value:function(t,e){}},{key:"Destroy",value:function(t){}}]),t}(),P=function(){function t(e,n){i(this,t),n=n||{},this.id=n.id||Math.random().toString(36).slice(2),this.ctx=e,this.Resize(),this._position=new d(n.x,n.y),this.distance=n.distance||1e3,this._viewport=new O,this._viewport.setFromXYWH({x:0,y:0,width:0,height:0}),this._viewport.scale={x:1,y:1},this.flustrum=[100,5e3],this.fieldOfView=Math.tan(Math.PI/4).toFixed(6),this.followId=null,this._eventStore={mousemove:function(t,e){this.OffsetMoveTo(-e.cameraOffset.x,-e.cameraOffset.y)},mousewheel:function(t,e){e.delta>0?this.OffsetZoomTo(-100,e.position):this.OffsetZoomTo(100,e.position)}},this.UpdateCamera()}return n(t,[{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"GetCenter",value:function(){return this._position}},{key:"RenderStart",value:function(){this.ctx.save(),this.ctx.scale(this._viewport.scale.x,this._viewport.scale.y),this.ctx.translate(-this._viewport.min.x,-this._viewport.min.y)}},{key:"RenderEnd",value:function(){this.ctx.restore()}},{key:"UpdateCamera",value:function(){this.setViewportFromSize(this.cvsWidth,this.cvsHeight)}},{key:"setViewportFromSize",value:function(t,e){var i=t/e,n=this.distance*this.fieldOfView,o=n/i;this._viewport.scale.x=t/n,this._viewport.scale.y=e/o,this._viewport.min.x=this._position.x-n/2,this._viewport.min.y=this._position.y-o/2,this._viewport.max.x=this._viewport.min.x+n,this._viewport.max.y=this._viewport.min.y+o}},{key:"GetScale",value:function(){return{x:this._viewport.scale.x,y:this._viewport.scale.y}}},{key:"SetDistanceFromScale",value:function(t){this.distance=this.cvsWidth/(t*this.fieldOfView),this.UpdateCamera()}},{key:"SetDistanceFromWidth",value:function(t){this.distance=t/this.fieldOfView,this.UpdateCamera()}},{key:"ZoomToFit",value:function(t,e){var i=this.cvsWidth/t,n=this.cvsHeight/e,o=i<n?i:n;this.SetDistanceFromScale(o)}},{key:"ZoomTo",value:function(t,e){var i=this.distance;this.distance=t,this.flustrum[0]>this.distance&&(this.distance=this.flustrum[0]),this.flustrum[1]<this.distance&&(this.distance=this.flustrum[1]),this._fixWorldPointZoom(i,e),this.UpdateCamera()}},{key:"OffsetZoomTo",value:function(t,e){var i=this.distance;this.distance+=t,this.flustrum[0]>this.distance&&(this.distance=this.flustrum[0]),this.flustrum[1]<this.distance&&(this.distance=this.flustrum[1]),this._fixWorldPointZoom(i,e),this.UpdateCamera()}},{key:"_fixWorldPointZoom",value:function(t,e){if(null!=e&&null!=e.x){var i=this.distance/t,n=this._position.x-e.x,o=this._position.y-e.y;this._position.x=e.x+n*i,this._position.y=e.y+o*i}}},{key:"MoveTo",value:function(t,e){this._position.x=t,this._position.y=e,this.UpdateCamera()}},{key:"OffsetMoveTo",value:function(t,e){this._position.x+=t,this._position.y+=e,this.UpdateCamera()}},{key:"ScreenToWorld",value:function(t,e){var i={};return i.x=t/this._viewport.scale.x+this._viewport.min.x,i.y=e/this._viewport.scale.y+this._viewport.min.y,i}},{key:"WorldToScreen",value:function(t,e){var i={};return i.x=(t-this._viewport.min.x)*this._viewport.scale.x,i.y=(e-this._viewport.min.y)*this._viewport.scale.y,i}},{key:"follow",value:function(t){this.followId=t}},{key:"Update",value:function(t){if(t){if(null!=this.followId){var e=t.getItem(this.followId);this.MoveTo(e.x,e.y)}if(null!=t.map){var i=this.x,n=this.y,o=this._viewport.min.x,s=this._viewport.min.y,r=this._viewport.max.x,a=this._viewport.max.y,h=0,l=0,c=this._viewport.getSize();c.x<t.map.w*t.map.scale&&(t.map.x*t.map.scale>o&&(h=t.map.x*t.map.scale-o),(t.map.x+t.map.w)*t.map.scale<r&&(h=(t.map.x+t.map.w)*t.map.scale-r)),c.y<t.map.h*t.map.scale&&(t.map.y*t.map.scale>s&&(l=t.map.y*t.map.scale-s),(t.map.y+t.map.h)*t.map.scale<a&&(l=(t.map.y+t.map.h)*t.map.scale-a)),this.MoveTo(i+h,n+l)}}}},{key:"Resize",value:function(){this.cvsWidth=this.ctx.canvas.offsetWidth,this.cvsHeight=this.ctx.canvas.offsetHeight}},{key:"x",set:function(t){this._position.x=t},get:function(){return this._position.x}},{key:"y",set:function(t){this._position.y=t},get:function(){return this._position.y}}]),t}(),z=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,t),this.id=e.id||"U"+Math.random().toString(36).slice(2),this._position=null,this.originalPosition=null,this.attachs={},this.attachObjects={},this._eventStore={},this.hide=null!=e.hide&&e.hide,this.opacity=e.opacity||1,this._collisionCheck=void 0===e.collisionCheck||e.collisionCheck,this.order=e.order||0,this.scale=e.scale||[1,1],this.originalScale=e.scale||[1,1],this.offset=[0,0]}return n(t,[{key:"Hide",value:function(){this.hide=!0}},{key:"Show",value:function(){this.hide=!1}},{key:"setCollisionCheck",value:function(t){this._collisionCheck=void 0===t||t}},{key:"changeScale",value:function(t){this.scale=t}},{key:"setScale",value:function(){var t=this.originalPosition.getSize(),e=this._position.getSize();this.scale[0]=e.x/t.x,this.scale[1]=e.y/t.y}},{key:"Translate",value:function(t){this._position instanceof d?this._position.add(t):this._position instanceof O&&this._position.translate(t),this.executeAttach()}},{key:"Rotate",value:function(){this.executeAttach()}},{key:"Scale",value:function(){this.executeAttach()}},{key:"GetCenter",value:function(){return this._position instanceof d?this._position:this._position instanceof O?this._position.getCenter():new d(0,0)}},{key:"CollisionCheck",value:function(e){if(!0!==this._collisionCheck)return!1;var i=e;if(e instanceof t&&(i=e._position),this._position instanceof d){var n=this._position.clone();if(i instanceof d){var o=n.sub(i).lenSq();if(o<1/0&&o<this.radius*this.radius)return!0}else if(i instanceof O)return i.containsPoint(this._position)}else if(this._position instanceof O){if(i instanceof d)return this._position.containsPoint(i);if(i instanceof O)return this._position.intersectsBox(i)}return!1}},{key:"Destroy",value:function(){delete this._position,delete this.originalPosition}},{key:"Update",value:function(t,e,i,n){}},{key:"Render",value:function(t){this.opacity<1&&(t.globalAlpha=this.opacity)}},{key:"SetOffset",value:function(t,e){this.offset=[t,e]}},{key:"EventStore",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];for(var i in t)!0===e||void 0===this._eventStore[i]?this._eventStore[i]=[t[i]]:this._eventStore[i].push(t[i])}},{key:"Attach",value:function(t,e){void 0===this.attachs[t.id]?this.attachs[t.id]=[e]:this.attachs[t.id].push(e),this.attachObjects[t.id]=t,this.executeAttach()}},{key:"Detach",value:function(t){delete this.attachs[t.id],delete this.attachObjects[t.id]}},{key:"executeAttach",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(var i in this.attachs)if(t!=i){for(var n=this.attachs[i],o=this.attachObjects[i],s=[],r=0;r<n.length;r++){var a=n[r].call(o,e);null!=a&&(s=a instanceof Array?s.concat(a):s.concat([a]))}null==t&&(t=this.id);for(var h in s)s[h].executeAttach(t,e)}}}]),t}(),L=function(t){function e(t){i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.shadow=t.shadow,n.originalColor=t.color,n.color=t.color,n.lineColor=t.lineColor||"#000000",n.setLineType(t.lineType),n.lineWidth=null==t.lineWidth?0:t.lineWidth,n}return s(e,t),n(e,[{key:"setColor",value:function(t){this.color=t}},{key:"setLineColor",value:function(t){this.lineColor=t}},{key:"setLineType",value:function(t){this.lineType="DASH"==t?[15,5]:"DOT"==t?[5,5]:"SOLID"==t?null:t}},{key:"Render",value:function(t){o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),null!=this.shadow&&(t.shadowColor=this.shadow.color,t.shadowBlur=this.shadow.blur,t.shadowOffsetX=this.shadow.offsetX,t.shadowOffsetY=this.shadow.offsetY),this.lineWidth>0&&(t.strokeStyle=this.lineColor,t.lineWidth=this.lineWidth,null!=this.lineType&&t.setLineDash(this.lineType))}},{key:"checkLinePointDist",value:function(t,e,i,n){return!!(this._pointNearByLine(t,e,i,n)&&this._linePointDist(t,e,i)<n)}},{key:"_pointNearByLine",value:function(t,e,i,n){var o=t.x<e.x?t.x:e.x,s=t.y<e.y?t.y:e.y,r=t.x>e.x?t.x:e.x,a=t.y>e.y?t.y:e.y;return i.x>=o-n&&i.x<=r+n&&i.y>=s-n&&i.y<=a+n}},{key:"_linePointDist",value:function(t,e,i){var n=t.y-e.y,o=e.x-t.x,s=t.x*e.y-e.x*t.y;return Math.abs(n*i.x+o*i.y+s)/Math.sqrt(n*n+o*o)}}]),e}(z),R=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._position=new O,n._position.setFromXYWH(t),n.originalPosition=new O,n.originalPosition.setFromXYWH(t),n}return s(e,t),n(e,[{key:"Render",value:function(t){if(!0===this.hide)return!1;t.save(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t);var i=this._position.min,n=this._position.getSize();null!=this.color&&(t.fillStyle=this.color,t.fillRect(i.x,i.y,n.x,n.y)),t.strokeRect(i.x,i.y,n.x,n.y),t.scale(this.scale[0],this.scale[1]),t.restore()}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),e}(L),M=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._position=new d(t.x,t.y),n.originalPosition=new d(t.x,t.y),n.radius=t.radius||5,n.pointType=t.pointType||"POINT",n.angle=t.angle||0,n}return s(e,t),n(e,[{key:"set",value:function(t,e){this._position=new d(t,e)}},{key:"setAngle",value:function(t,e){this.angle=Math.atan2(e.y-t.y,e.x-t.x)}},{key:"setPointType",value:function(t){"POINT"!=t&&"ARROW"!=t&&"RECT"!=t||(this.pointType=t)}},{key:"Update",value:function(){}},{key:"Render",value:function(t){if(!0!==this.hide){t.save(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),t.beginPath();var i=this._position.x+this.offset[0],n=this._position.y+this.offset[1];if("POINT"==this.pointType)t.arc(i,n,this.radius,0,2*Math.PI,!1);else if("ARROW"==this.pointType){var s=2*this.radius,r=this.angle;t.beginPath(),t.moveTo(i,n),t.lineTo(i-s*Math.cos(r-Math.PI/6),n-s*Math.sin(r-Math.PI/6)),t.lineTo(i-s*Math.cos(r+Math.PI/6),n-s*Math.sin(r+Math.PI/6)),t.closePath()}else if("RECT"==this.pointType){var a=this.radius;null!=this.color&&(t.fillStyle=this.color,t.fillRect(i-a,n-a,2*a,2*a)),t.strokeRect(i-a,n-a,2*a,2*a)}t.stroke(),t.closePath(),null!=this.color&&(t.fillStyle=this.color,t.fill()),t.restore()}}},{key:"x",set:function(t){this._position.x=t},get:function(){return this._position.x}},{key:"y",set:function(t){this._position.y=t},get:function(){return this._position.y}}]),e}(L),E=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.dataSource=t.dataSource,n.image=u.Load(n.dataSource),""!==n.image&&(null==t.width&&(t.width=n.image.width),null==t.height&&(t.height=n.image.height)),n._position=new O,n._position.setFromXYWH(t),n.originalPosition=new O,n.originalPosition.setFromXYWH(t),n.isDynamic=null!=t.isDynamic&&t.isDynamic,n}return s(e,t),n(e,[{key:"resetImage",value:function(t){null!=t&&(this.dataSource=t),this.image=u.Load(this.dataSource),this.originalPosition.setSize({x:this.image.width,y:this.image.height}),this.setScale()}},{key:"Destroy",value:function(){o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),!0===this.isDynamic&&u.Remove(this.dataSource)}},{key:"Render",value:function(t){if(!0===this.hide)return!1;if(null===this.image)return!1;t.save(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t);var i=this._position.min,n=this._position.getSize();""===this.image&&this.resetImage(),""!==this.image&&t.drawImage(this.image,i.x,i.y,n.x,n.y),t.scale(this.scale[0],this.scale[1]),t.restore()}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),e}(L),D=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,t),this.id=Math.random().toString(36).slice(2),this.stage=e,this.ctx=e.ctx,this.width=n.width||100,this.height=n.height||100,this.camera=null,this.EventStore=e.EventStore,this.Items={},this.Units={},this._orderedItems=[],this._orderedUnits=[],this._unitsWithParent={},this.gravity=!1}return n(t,[{key:"_World",value:function(t){}},{key:"RemoveAll",value:function(){for(var t in this.Items)this.Remove(t)}},{key:"Remove",value:function(t){var e=this.getItem(t);if(null!=e){if(this.stage.setRemovePack&&this.stage.setRemovePack(t),e instanceof A)for(var i in e){var n=e[i];n instanceof z&&(this.getUnit(n.id).Destroy(this.stage),this.removeUnit(n.id,e.id),void 0!==this.EventStore&&this.EventStore.Remove(n.id))}else e instanceof z&&(this.getUnit(t).Destroy(this.stage),this.removeUnit(t,t),this.EventStore.Remove(t));e.Destroy(),this.removeItem(t)}this.resetOrder()}},{key:"resetOrder",value:function(){this._orderedItems=this._makeOrderedArray(this._orderedItems,!0),this.makeOrderdUnits()}},{key:"setUnitOrder",value:function(t){var e=this._unitsWithParent[t];this._unitsWithParent[t]=this._makeOrderedArray(e)}},{key:"makeOrderdUnits",value:function(){this._orderedUnits=[];for(var t in this._orderedItems){var e=this._orderedItems[t],i=this._unitsWithParent[e.id];null!=i&&(this._orderedUnits=i.concat(this._orderedUnits))}for(var n in this._orderedUnits)if(this._orderedUnits[n].order==1/0){var o=this._orderedUnits.splice(n,1);for(var s in o)this._orderedUnits.unshift(o[s])}}},{key:"bringToFront",value:function(t){for(var e in this._orderedItems)if(this._orderedItems[e].id==t.id){var i=this._orderedItems.splice(e,1);for(var n in i)this._orderedItems.push(i[n]);break}}},{key:"sendToBack",value:function(t){for(var e in this._orderedItems)if(this._orderedItems[e].id==t.id){var i=this._orderedItems.splice(e,1);for(var n in i)this._orderedItems.unshift(i[n]);break}}},{key:"Add",value:function(t){if(t instanceof P)this.camera=t,void 0!==this.EventStore&&this.EventStore.Add(t,t._eventStore);else if(t instanceof z)this.setItem(t.id,t),this.setUnit(t.id,t,t.id),void 0!==this.EventStore&&this.EventStore.Add(t,t._eventStore);else if(t instanceof A){!0===this.gravity?t.gravity=t.weight:t.gravity=0,this.setItem(t.id,t);for(var e in t){var i=t[e];i instanceof z&&(this.setUnit(i.id,i,t.id),void 0!==this.EventStore&&this.EventStore.Add(i,i._eventStore,t.id))}this.setUnitOrder(t.id),this.stage.setInitPack&&this.stage.setInitPack(t.getPack())}return this.resetOrder(),t.id}},{key:"searchItems",value:function(t){var e=[];for(var i in this._orderedItems){var n=this._orderedItems[i];for(var o in t)if(n[o]===t[o]){e.push(n);break}}return e}},{key:"searchInstance",value:function(t){var e=[];for(var i in this._orderedItems){var n=this._orderedItems[i];n instanceof t&&e.push(n)}return e}},{key:"_findIndex",value:function(t,e){for(var i in e)if(e[i].id==t)return i}},{key:"setItem",value:function(t,e){this.Items[t]=e;var i=this._findIndex(t,this._orderedItems);void 0!=i?this._orderedItems[i]=e:this._orderedItems.push(e)}},{key:"getItem",value:function(t){return this.Items[t]}},{key:"getItemArray",value:function(t){return this._orderedItems[t]}},{key:"getItems",value:function(){return this.Items}},{key:"getItemArrays",value:function(){return this._orderedItems}},{key:"removeItem",value:function(t){delete this.Items[t];var e=this._findIndex(t,this._orderedItems);this._orderedItems.splice(e,1)}},{key:"getUnit",value:function(t){return this.Units[t]}},{key:"getUnitArray",value:function(t){return this._orderedUnits[t]}},{key:"setUnit",value:function(t,e,i){this.Units[t]=e,null==this._unitsWithParent[i]&&(this._unitsWithParent[i]=[]),this._unitsWithParent[i].push(e)}},{key:"getUnits",value:function(t){return this.Units}},{key:"getUnitArrays",value:function(){return this._orderedUnits}},{key:"removeUnit",value:function(t,e){delete this.Units[t];var i=this._unitsWithParent[e],n=this._findIndex(t,i);i.splice(n,1)}},{key:"_makeOrderedArray",value:function(t,e){var i=new Array,n=new Array;for(var o in t){var s=t[o];null==n[Number(s.order)]?n[Number(s.order)]=[s]:n[Number(s.order)].push(s)}for(var r in n){var a=n[r];if(a instanceof Array)for(var h in a){var l=a[h];!0===e?i.push(l):i.unshift(l)}}return i}},{key:"Start",value:function(){}},{key:"Update",value:function(t,e){for(var i in this._orderedItems)this._orderedItems[i].Update(t,e,this,i)}},{key:"RenderBefore",value:function(){if(!0===this.renderBefore)for(var t in this._orderedItems){var e=this._orderedItems[t];1!=e.hide&&e.RenderBefore&&e.RenderBefore(this.ctx,this.camera,t)}}},{key:"RenderAfter",value:function(){if(!0===this.renderAfter)for(var t in this._orderedItems){var e=this._orderedItems[t];1!=e.hide&&e.RenderAfter&&e.RenderAfter(this.ctx,this.camera,t)}}},{key:"Render",value:function(){this.ctx.clearRect(0,0,this.width,this.height),null!=this.camera&&(this.camera.Update(this),this.camera.RenderStart()),this.RenderBefore(this.ctx,this.camera);for(var t in this._orderedItems){var e=this._orderedItems[t];1!=e.hide&&e.Render(this.ctx,this.camera,t)}this.RenderAfter(this.ctx,this.camera),null!=this.camera&&this.camera.RenderEnd()}},{key:"Stop",value:function(){}},{key:"Resize",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};null!=e.width&&(this.width=e.width),null!=e.height&&(this.height=e.height),null!=this.camera&&(this.camera.Resize(),this.camera.UpdateCamera())}}]),t}(),U=function(){function t(){i(this,t),this.ARG_LENGTH={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0}}return n(t,[{key:"_parseValues",value:function(t){var e=t.match(/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/gi);return e?e.map(Number):[]}},{key:"Parse",value:function(t){var e=this,i=[],n=String(t).trim();return"M"!==n[0]&&"m"!==n[0]?i:(n.replace(/([astvzqmhlc])([^astvzqmhlc]*)/gi,function(t,n,o){var s=n.toLowerCase(),r=e._parseValues(o),a=n;if("m"===s&&r.length>2&&(i.push([a].concat(r.splice(0,2))),s="l",a="m"===a?"l":"L"),r.length<e.ARG_LENGTH[s])return"";for(i.push([a].concat(r.splice(0,e.ARG_LENGTH[s])));r.length>=e.ARG_LENGTH[s]&&r.length&&e.ARG_LENGTH[s];)i.push([a].concat(r.splice(0,e.ARG_LENGTH[s])));return""}),i)}}]),t}(),W=function(){function t(e){i(this,t),this.segments=[];var n=new U;this.segments=n.Parse(e)}return n(t,[{key:"Render",value:function(t){this.buildPath(t,this.segments)}},{key:"_rotatePoint",value:function(t,e){var i=t.x*Math.cos(e)-t.y*Math.sin(e),n=t.y*Math.cos(e)+t.x*Math.sin(e);t.x=i,t.y=n}},{key:"_translatePoint",value:function(t,e,i){t.x+=e,t.y+=i}},{key:"_scalePoint",value:function(t,e){t.x*=e,t.y*=e}},{key:"moveTo",value:function(t,e){this.segments.push(["M",t,e])}},{key:"lineTo",value:function(t,e){this.segments.push(["L",t,e])}},{key:"arc",value:function(t,e,i,n,o,s){this.segments.push(["AC",t,e,i,n,o,!!s])}},{key:"arcTo",value:function(t,e,i,n,o){this.segments.push(["AT",t,e,i,n,o])}},{key:"ellipse",value:function(t,e,i,n,o,s,r,a){this.segments.push(["E",t,e,i,n,o,s,r,!!a])}},{key:"closePath",value:function(){this.segments.push(["Z"])}},{key:"bezierCurveTo",value:function(t,e,i,n,o,s){this.segments.push(["C",t,e,i,n,o,s])}},{key:"quadraticCurveTo",value:function(t,e,i,n){this.segments.push(["Q",t,e,i,n])}},{key:"rect",value:function(t,e,i,n){this.segments.push(["R",t,e,i,n])}},{key:"buildPath",value:function(t,e){var i=void 0,n=void 0,o=void 0,s=void 0,r=void 0,a=void 0,h=void 0,l=void 0,c=void 0,u=void 0,d=void 0,y=void 0,v=void 0,f=void 0,p=void 0,_=void 0,x=void 0,m=void 0,g=void 0,k=void 0,b=void 0,S=void 0,T=void 0,w=void 0,C=void 0,I=void 0,O={x:0,y:0},A={x:0,y:0};t.beginPath();for(var P=0;P<e.length;++P){var z=e[P];"S"!==(k=z[0])&&"s"!==k&&"C"!==k&&"c"!==k&&(S=null,T=null),"T"!==k&&"t"!==k&&"Q"!==k&&"q"!==k&&(w=null,C=null),"M"==k||"m"==k?("m"===k?(d+=z[1],v+=z[2]):(d=z[1],v=z[2]),"M"!==k&&O||(O={x:d,y:v}),t.moveTo(d,v)):"l"==k?(d+=z[1],v+=z[2],t.lineTo(d,v)):"L"==k?(d=z[1],v=z[2],t.lineTo(d,v)):"h"==k?(d+=z[1],t.lineTo(d,v)):"H"==k?(d=z[1],t.lineTo(d,v)):"v"==k?(v+=z[1],t.lineTo(d,v)):"V"==k?(v=z[1],t.lineTo(d,v)):"A"==k||"a"==k?("a"===k?(d+=z[6],v+=z[7]):(d=z[6],v=z[7]),_=z[1],x=z[2],h=z[3]*Math.PI/180,o=!!z[4],s=!!z[5],r={x:d,y:v},a={x:(A.x-r.x)/2,y:(A.y-r.y)/2},this._rotatePoint(a,-h),(l=a.x*a.x/(_*_)+a.y*a.y/(x*x))>1&&(_*=l=Math.sqrt(l),x*=l),b={x:_*a.y/x,y:-x*a.x/_},c=_*_*x*x,u=_*_*a.y*a.y+x*x*a.x*a.x,s!==o?this._scalePoint(b,Math.sqrt((c-u)/u)||0):this._scalePoint(b,-Math.sqrt((c-u)/u)||0),n=Math.atan2((a.y-b.y)/x,(a.x-b.x)/_),i=Math.atan2(-(a.y+b.y)/x,-(a.x+b.x)/_),this._rotatePoint(b,h),this._translatePoint(b,(r.x+A.x)/2,(r.y+A.y)/2),t.save(),t.translate(b.x,b.y),t.rotate(h),t.scale(_,x),t.arc(0,0,1,n,i,!s),t.restore()):"c"==k?(t.bezierCurveTo(z[1]+d,z[2]+v,z[3]+d,z[4]+v,z[5]+d,z[6]+v),S=z[3]+d,T=z[4]+v,d+=z[5],v+=z[6]):"C"==k?(S=z[3],T=z[4],d=z[5],v=z[6],t.bezierCurveTo(z[1],z[2],S,T,d,v)):"s"==k?(null!==S&&null!==S||(S=d,T=v),t.bezierCurveTo(2*d-S,2*v-T,z[1]+d,z[2]+v,z[3]+d,z[4]+v),S=z[1]+d,T=z[2]+v,d+=z[3],v+=z[4]):"S"==k?(null!==S&&null!==S||(S=d,T=v),t.bezierCurveTo(2*d-S,2*v-T,z[1],z[2],z[3],z[4]),S=z[1],T=z[2],d=z[3],v=z[4]):"q"==k?(w=z[1]+d,C=z[2]+v,d+=z[3],v+=z[4],t.quadraticCurveTo(w,C,d,v)):"Q"==k?(w=z[1],C=z[2],d=z[3],v=z[4],t.quadraticCurveTo(w,C,d,v)):"t"==k?(null!==w&&null!==w||(w=d,C=v),w=2*d-w,C=2*v-C,d+=z[1],v+=z[2],t.quadraticCurveTo(w,C,d,v)):"T"==k?(null!==w&&null!==w||(w=d,C=v),w=2*d-w,C=2*v-C,d=z[1],v=z[2],t.quadraticCurveTo(w,C,d,v)):"z"==k||"Z"==k?(d=O.x,v=O.y,O=void 0,t.closePath()):"AC"==k?(d=z[1],v=z[2],p=z[3],n=z[4],i=z[5],I=z[6],t.arc(d,v,p,n,i,I)):"AT"==k?(y=z[1],f=z[2],d=z[3],v=z[4],p=z[5],t.arcTo(y,f,d,v,p)):"E"==k?(d=z[1],v=z[2],_=z[3],x=z[4],h=z[5],n=z[6],i=z[7],I=z[8],t.save(),t.translate(d,v),t.rotate(h),t.scale(_,x),t.arc(0,0,1,n,i,I),t.restore()):"R"==k?(d=z[1],v=z[2],m=z[3],g=z[4],O={x:d,y:v},t.rect(d,v,m,g)):console.log(k+"is not implemented"),A.x=d,A.y=v}}}]),t}(),F=function(){function t(e){var n=e.x,o=void 0===n?0:n,s=e.y,r=void 0===s?0:s,a=e.width,h=void 0===a?0:a,l=e.height,c=void 0===l?0:l,u=e.tileW,d=void 0===u?0:u,y=e.tileH,v=void 0===y?0:y,f=e.scale,p=void 0===f?1:f,_=e.collision,x=void 0===_?[]:_;i(this,t),this.x=o,this.y=r,this.scale=p,this.width=h,this.height=c,this.tileW=d,this.tileH=v,this.w=h*d,this.h=c*v,this.collision=x}return n(t,[{key:"collisionCheck",value:function(t){var e=t.x,i=t.y,n=t.dir,o=this.tileW*this.scale,s=this.tileH*this.scale,r=Math.floor(e/o),a=Math.floor(i/s);if(r<this.x||r>=this.width)return 0;if(a<this.y||a>=this.height)return 0;var h=this.collision[r+a*this.width];return h>0?"L"===n||"U"===n?{status:h,x:o-e%o,y:s-i%s}:{status:h,x:e%o,y:i%s}:0}},{key:"Destroy",value:function(){}}]),t}(),j=function(){function t(e,n){i(this,t),this.hide=!1,this.pos={x:e.x||0,y:e.y||0},this.size={x:e.w||64,y:e.h||64},this.scale=e.scale,this.dataSource=n.dataSource,this.image=u.Load(this.dataSource)}return n(t,[{key:"resetImage",value:function(t){null!=t&&(this.dataSource=t),this.image=u.Load(this.dataSource)}},{key:"Render",value:function(t,e){if(!0===this.hide)return!1;if(null===this.image)return!1;t.save();var i=this.pos,n=this.size;""===this.image&&this.resetImage(),""!==this.image&&t.drawImage(this.image,i.x,i.y,n.x,n.y,i.x*this.scale,i.y*this.scale,n.x*this.scale,n.y*this.scale),t.restore()}},{key:"Destroy",value:function(){!0===this.isDynamic&&u.Remove(this.dataSource)}}]),t}(),B=function(t){function e(t){i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));if(null==t.pos||t.pos.length<2)return console.error("[pos] is not valid"),r(n);n._position=[];for(var o=0;o<t.pos.length;o++)t.pos[o]instanceof d?n._position[o]=t.pos[o]:t.pos[o]instanceof Array&&(n._position[o]=new d(t.pos[o][0],t.pos[o][1]));return n}return s(e,t),n(e,[{key:"Render",value:function(t){if(!0!==this.hide){t.save(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),t.beginPath();for(var i=0;i<this._position.length;i++)0==i?t.moveTo(this._position[0].x,this._position[0].y):t.lineTo(this._position[i].x,this._position[i].y);t.stroke(),t.closePath(),t.restore()}}},{key:"CollisionCheck",value:function(t){if(!0!==this._collisionCheck)return!1;var e=t;if(t instanceof z&&(e=t._position),e instanceof d)for(o=0;o<this._position.length-1;o++){var i=this._position[o],n=this._position[o+1];if(this.checkLinePointDist(i,n,e,5))return!0}else if(e instanceof O)for(var o=0;o<this._position.length;o++){var s=this._position[o];if(e.containsPoint(s))return!0}return!1}}]),e}(L),V=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._position=new O,n._position.setFromXYWH(t),n.originalPosition=new O,n.originalPosition.setFromXYWH(t),n.round=t.round||0,n.polygonType=t.polygonType||"RECT",n}return s(e,t),n(e,[{key:"setPolygonType",value:function(t){this.polygonType=t}},{key:"Render",value:function(t){if(!0===this.hide)return!1;t.save(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t);var i=this._position.min,n=this._position.getSize();"RECT"===this.polygonType?this.drawRect(t,i.x,i.y,n.x,n.y):"ROUND"===this.polygonType?this.drawRoundRect(t,i.x,i.y,n.x,n.y):"CIRCLE"===this.polygonType?this.drawEllipse(t,i.x,i.y,n.x,n.y):"DIAMOND"===this.polygonType?this.drawDiamond(t,i.x,i.y,n.x,n.y):"ARROW"===this.polygonType&&this.drawArrow(t,i.x,i.y,n.x,n.y),null!=this.color&&(t.fillStyle=this.color,t.fill()),t.scale(this.scale[0],this.scale[1]),t.restore()}},{key:"drawRect",value:function(t,e,i,n,o){t.beginPath(),t.moveTo(e,i),t.lineTo(e+n,i),t.lineTo(e+n,i+o),t.lineTo(e,i+o),t.closePath(),t.stroke()}},{key:"drawArrow",value:function(t,e,i,n,o){var s=i+o/2,r=.2*n;t.beginPath(),t.moveTo(e,i),t.lineTo(e+n-r,i),t.lineTo(e+n,s),t.lineTo(e+n-r,i+o),t.lineTo(e,i+o),t.lineTo(e+r,s),t.closePath(),t.stroke()}},{key:"drawDiamond",value:function(t,e,i,n,o){var s=e+n/2,r=i+o/2;t.beginPath(),t.moveTo(s,i),t.lineTo(e+n,r),t.lineTo(s,i+o),t.lineTo(e,r),t.closePath(),t.stroke()}},{key:"drawEllipse",value:function(t,e,i,n,o){var s=n/2*.5522848,r=o/2*.5522848,a=e+n,h=i+o,l=e+n/2,c=i+o/2;t.beginPath(),t.moveTo(e,c),t.bezierCurveTo(e,c-r,l-s,i,l,i),t.bezierCurveTo(l+s,i,a,c-r,a,c),t.bezierCurveTo(a,c+r,l+s,h,l,h),t.bezierCurveTo(l-s,h,e,c+r,e,c),t.closePath(),t.stroke()}},{key:"drawRoundRect",value:function(t,e,i,n,o){var s=n/2*.5,r=o/2*.5;s<r&&(r=s),s>r&&(s=r);var a=e+n,h=i+o;t.beginPath(),t.moveTo(e,i+r),t.quadraticCurveTo(e,i,e+s,i),t.lineTo(a-s,i),t.quadraticCurveTo(a,i,a,i+r),t.lineTo(a,h-r),t.quadraticCurveTo(a,h,a-s,h),t.lineTo(e+s,h),t.quadraticCurveTo(e,h,e,h-r),t.lineTo(e,i+r),t.closePath(),t.stroke()}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),e}(L),H=function(t){function e(t){i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));if(null==t.pos||t.pos.length<2)return console.error("[pos] is not valid"),r(n);n._position=[];for(var o=0;o<t.pos.length;o++)t.pos[o]instanceof d?n._position[o]=t.pos[o]:t.pos[o]instanceof Array&&(n._position[o]=new d(t.pos[o][0],t.pos[o][1]));return n.isBezier=t.isBezier||!1,n}return s(e,t),n(e,[{key:"Render",value:function(t){if(!0!==this.hide){t.save(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),t.beginPath();for(var i=[],n=0;n<this._position.length;n++)0==n?t.moveTo(this._position[0].x,this._position[0].y):(i.push(this._position[n].x),i.push(this._position[n].y));t.bezierCurveTo.apply(t,i),t.stroke(),t.closePath(),t.restore()}}}]),e}(L),G=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._position=new O,n._position.setFromXYWH(t),n.originalPosition=new O,n.originalPosition.setFromXYWH(t),null!=t.svg?n.svg=new W(t.svg):console.log("Error : Empty SVG String!!"),n}return s(e,t),n(e,[{key:"changeSvg",value:function(t){null!=t?this.svg=new W(t):console.log("Error : Empty SVG String!!")}},{key:"Render",value:function(t){!0!==this.hide&&(t.save(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),t.fillStyle=this.color,t.translate(this._position.min.x,this._position.min.y),t.scale(this.scale[0],this.scale[1]),null!=this.svg&&this.svg.Render(t),t.fill(),t.restore())}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),e}(L),X=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.text=t.text||"",n.url=t.url||"",n._position=new O,n._position.setFromXYWH(t),n.font=t.font||'normal normal 12px "serif"',null!=t.font&&n.makeFontAttr(t.font),null!=t.fontStyle?n.fontStyle=t.fontStyle:null==n.fontStyle&&(n.fontStyle="normal"),null!=t.fontWeight?n.fontWeight=t.fontWeight:null==n.fontWeight&&(n.fontWeight="normal"),null!=t.fontSize?n.fontSize=t.fontSize:null==n.fontSize&&(n.fontSize=12),null!=t.fontFace?n.fontFace=t.fontFace:null==n.fontFace&&(n.fontFace="serif"),n.align=t.align||"left",n.makeFont(),n.isChangeLine=null!=t.isChangeLine&&t.isChangeLine,n.isEllipsis=null==t.isEllipsis||t.isEllipsis,n.showBoundBox=null!=t.showBoundBox&&t.showBoundBox,n.setOpacity(t.boundboxOpacity),n.bgColor=t.bgColor,n.maxTextWidth=0,n.maxTextHeight=1,n}return s(e,t),n(e,[{key:"makeFontAttr",value:function(t){if(t.indexOf(" ")>-1){var e=t.substring(0,t.indexOf('"')-1),i=t.substring(t.indexOf('"'),t.length-1).replace('"',""),n=e.split(" ");n.length>2?(this.fontStyle=n[0],this.fontWeight=n[1],this.fontSize=Number(n[2].replace("px","")),this.fontFace=i):console.log('Error : please check Mask of Font.(style weight size "face")')}else this.fontFace=opts.font}},{key:"makeFont",value:function(){this.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+'px "'+this.fontFace+'"'}},{key:"setFontStyle",value:function(t){this.fontStyle=t||"normal",this.makeFont()}},{key:"setFontWeight",value:function(t){this.fontWeight=t||"normal",this.makeFont()}},{key:"setFontSize",value:function(t){this.fontSize=t||12,this.makeFont()}},{key:"setFontFace",value:function(t){this.fontFace=t||"serif",this.makeFont()}},{key:"setText",value:function(t){this.text=t||""}},{key:"setUrl",value:function(t){this.url=t||""}},{key:"setAlign",value:function(t){this.align=t||"left"}},{key:"setOpacity",value:function(t){var e=this.boundboxOpacity;this.boundboxOpacity=null!=t?t:1,0==t&&""!=this.text&&(this.boundboxOpacity=e)}},{key:"getMaxWidth",value:function(){return this.maxTextWidth}},{key:"getMaxHeight",value:function(){return this.maxTextHeight}},{key:"setMaxWidth",value:function(t){t.save(),t.font=this.font,t.textBaseline="top";var e=this.text.split("\n");this.maxTextHeight=e.length;for(var i in e){var n=t.measureText(e[i]).width;this.maxTextWidth<n&&(this.maxTextWidth=n)}t.restore()}},{key:"setBoxSizeCenter",value:function(t){var e=this._position.getCenter();if(null!=t&&!1===this.isEllipsis){t.save(),t.font=this.font,t.textBaseline="top";var i=t.measureText(this.text).width;i<20&&(i=20),this._position.max.x=this._position.min.x+i,this._position.setCenter(e),t.restore()}}},{key:"Update",value:function(t){}},{key:"Render",value:function(t){if(!0!==this.hide){if(t.save(),o(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),!0===this.showBoundBox){this.boundboxOpacity<1&&(t.globalAlpha=this.boundboxOpacity);var i=this._position.min,n=this._position.getSize();null!=this.bgColor?(t.fillStyle=this.bgColor,t.fillRect(i.x,i.y,n.x,n.y)):(t.fillStyle=this.lineColor,t.strokeRect(i.x,i.y,n.x,n.y))}t.font=this.font,t.textBaseline="top",t.fillStyle=this.color;var s=this._position.min.x,r=this._position.getCenter();t.textAlign=this.align,"center"==this.align?s=r.x:"right"==this.align&&(s=this._position.max.x);var a=this._position.getSize();!0===this.isChangeLine?this.TextLineBreak(t,this.text,this.fontSize,1.2,s,this._position.min.y,a.x,this._position.max.y):!0===this.isEllipsis?t.fillText(this.TextEllipsis(t,this.text,a.x),s,this._position.min.y):t.fillText(this.text,s,this._position.min.y),t.restore()}}},{key:"TextEllipsis",value:function(t,e,i){var n=t.measureText(e).width,o=t.measureText("…").width;if(n<=i||n<=o)return e;for(var s=e.length;n>=i-o&&s-- >0;)e=e.substring(0,s),n=t.measureText(e).width;return e+"…"}},{key:"TextLineBreak",value:function(t,e,i,n,o,s,r,a){for(var h="",l=s,c=i*n,u=0;u<e.length;u++){var d=h+e[u],y=t.measureText(d).width;if(l+c>a)return void t.fillText("...",o+10,a-c);y<r&&"\n"!=e[u]?h=d:(t.fillText(h,o,l),h="\n"!=e[u]?e[u]:"",l+=c)}t.fillText(h,o,l)}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),e}(L),q=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.dataSource=t.dataSource,n.image=u.Load(n.dataSource),n.x=t.x||0,n.y=t.y||0,n.scale=t.scale||1,n.currAnim=t.currAnim,n.currFrame=0,n.anims=t.anim,n.action=n.anims[n.currAnim],n.isDynamic=null!=t.isDynamic&&t.isDynamic,n}return s(e,t),n(e,[{key:"resetImage",value:function(t){null!=t&&(this.dataSource=t),this.image=u.Load(this.dataSource)}},{key:"ChangeDatasource",value:function(t){this.resetImage(t)}},{key:"_ableToChangeAnim",value:function(){return this.action.next!==this.currAnim}},{key:"ChangeScale",value:function(t){this.scale=t}},{key:"ChangeAnim",value:function(t,e){this.currAnim!==t&&(e||!1===this._ableToChangeAnim())&&null!=this.anims[t]&&(this.currAnim=t,this.action=this.anims[t],this.currFrame=0,this.currTimmer=0,this.action.dir.length<this.currDir+1&&(this.currDir=0))}},{key:"ChangeDir",value:function(t){null!=this.action&&(this.currDir=this.action.dir[t])}},{key:"ChangeDirFromAngle",value:function(t){var e=this.action;if(null!=e){var i=Math.round(t/(360/e.dir.length))%e.dir.length;this.currDir=e.dir[i]}}},{key:"getAnim",value:function(t){return this.anims[t]}},{key:"Update",value:function(t,e){}},{key:"Render",value:function(t){if(!0===this.hide)return!1;if(null===this.image)return!1;if(t.save(),""===this.image&&this.resetImage(),""!==this.image){var e=this.action;if(null!=e){this.currTimmer+=e.animSpd,this.currTimmer||(this.currTimmer=0),this.currFrame=Math.floor(this.currTimmer),this.currFrame>=e.frame-1&&(this.currFrame=0,this.currTimmer=0,this.ChangeAnim(e.next,!0));var i=e.startX+this.currFrame*e.sizeX,n=e.startY+this.currDir*e.sizeY,o=.5*e.sizeX,s=.5*e.sizeY;t.drawImage(this.image,i,n,e.sizeX,e.sizeY,this.x-o*this.scale,this.y-s*this.scale,e.sizeX*this.scale,e.sizeY*this.scale)}}t.restore()}},{key:"Destroy",value:function(){!0===this.isDynamic&&u.Remove(this.dataSource)}}]),e}(z),Y=function(t){function e(t){i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._shape=new M(t),n._shape.EventStore({mousedown:function(t,e){this.setColor("#ff0000")},mouseup:function(t){this.setColor(this.originalColor)},mousemove:function(t,e){this.Translate(e.offset),t.Render()},click:function(t,e){console.log(this.parentId),t.scene.Remove(this.parentId),t.Render()}}),n}return s(e,t),n(e,[{key:"Render",value:function(t){this._shape.Render(t)}}]),e}(A),N=function(t){function e(t){i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._shape=new R(t),n._shape.EventStore({mousedown:function(t,e){this.setColor("#ff0000")},mouseup:function(t,e){this.setColor(this.originalColor)},mousemove:function(t,e){this.Translate(e.offset)},click:function(t,e){t.scene.Remove(this.parentId)},_afterCallback:function(t,e){t.Render()}}),n}return s(e,t),n(e,[{key:"Render",value:function(t){0==this._shape.hide&&this._shape.Render(t)}}]),e}(A),Z=function(t){function e(t){i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.controlRect=new R(t),n.text=t.text,n}return s(e,t),n(e,[{key:"Update",value:function(t){}},{key:"Render",value:function(t){t.fillText(this.text,10,10)}}]),e}(A),K=function(t){function e(t){i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));n._c1=new M,n._c2=new M,n._c3=new M,n._c4=new M,n._rect=new R(t),n._c1.set(n._rect._position.min.x,n._rect._position.min.y),n._c2.set(n._rect._position.max.x,n._rect._position.min.y),n._c3.set(n._rect._position.min.x,n._rect._position.max.y),n._c4.set(n._rect._position.max.x,n._rect._position.max.y),n._rect.Attach(n.id,{min:{x:[n._c1._position,n._c3._position],y:[n._c1._position,n._c2._position]},max:{x:[n._c2._position,n._c4._position],y:[n._c3._position,n._c4._position]}}),n._c1.Attach(n.id,{min:{x:n._rect._position.min,y:n._rect._position.min},_next:[n._rect]}),n._c2.Attach(n.id,{min:{x:n._rect._position.max,y:n._rect._position.min},_next:[n._rect]}),n._c3.Attach(n.id,{min:{x:n._rect._position.min,y:n._rect._position.max},_next:[n._rect]}),n._c4.Attach(n.id,{min:{x:n._rect._position.max,y:n._rect._position.max},_next:[n._rect]}),n._rect.eventStore={mousemove:function(t,e){this.Translate(e.offset)},click:function(t,e){t.scene.Remove(this.parentId)},_after:function(t,e){t.Render()}};var o={mousemove:function(t,e){this.Translate(e.offset),t.Render()}};return n._c1.eventStore=o,n._c2.eventStore=o,n._c3.eventStore=o,n._c4.eventStore=o,n}return s(e,t),n(e,[{key:"Render",value:function(t){this._rect.Render(t),this._c1.Render(t),this._c2.Render(t),this._c3.Render(t),this._c4.Render(t)}}]),e}(A),Q=function(t){function e(t){i(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));n._rect=new R(t),n._c1=new M,n._c2=new M,n._c3=new M,n._c4=new M,n._c1.set(n._rect._position.min.x,n._rect._position.min.y),n._c2.set(n._rect._position.max.x,n._rect._position.min.y),n._c3.set(n._rect._position.min.x,n._rect._position.max.y),n._c4.set(n._rect._position.max.x,n._rect._position.max.y),n._line=new B({pos:[n._c1._position,n._c2._position,n._c3._position,n._c4._position],isBezier:!0,lineType:"DASH",lineWidth:5}),n._rect.Attach(n.id,{min:{x:[n._line._position[0],n._line._position[2],n._c1._position,n._c3._position],y:[n._line._position[0],n._line._position[1],n._c1._position,n._c2._position]},max:{x:[n._line._position[1],n._line._position[3],n._c2._position,n._c4._position],y:[n._line._position[2],n._line._position[3],n._c3._position,n._c4._position]}}),n._c1.Attach(n.id,{min:{x:[n._rect._position.min,n._line._position[0]],y:[n._rect._position.min,n._line._position[0]]},_next:[n._rect]}),n._c2.Attach(n.id,{min:{x:[n._rect._position.max,n._line._position[1]],y:[n._rect._position.min,n._line._position[1]]},_next:[n._rect]}),n._c3.Attach(n.id,{min:{x:[n._rect._position.min,n._line._position[2]],y:[n._rect._position.max,n._line._position[2]]},_next:[n._rect]}),n._c4.Attach(n.id,{min:{x:[n._rect._position.max,n._line._position[3]],y:[n._rect._position.max,n._line._position[3]]},_next:[n._rect]}),n._rect.eventStore={mousemove:function(t,e){this.Translate(e.offset)},click:function(t,e){t.scene.Remove(this.parentId)},_after:function(t,e){t.Render()}};var o={mousemove:function(t,e){this.Translate(e.offset),t.Render()}};return n._c1.eventStore=o,n._c2.eventStore=o,n._c3.eventStore=o,n._c4.eventStore=o,n}return s(e,t),n(e,[{key:"Render",value:function(t){this._c1.Render(t),this._c2.Render(t),this._c3.Render(t),this._c4.Render(t),this._line.Render(t)}}]),e}(A),J=function(){function t(e){i(this,t),this.ctx=e.getContext("2d"),this.hudList={},this.Resize()}return n(t,[{key:"Add",value:function(t,e){this.hudList[t]=e,this.Render(t)}},{key:"Update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.width=this.width,t.height=this.height;for(var e in t){var i=this.hudList[e];i&&(i.Update(t[e]),this.Render(e))}}},{key:"Render",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.ctx=this.ctx,e.width=this.width,e.height=this.height,null!=t)this.hudList[t].Render(e);else for(var i in this.hudList)this.hudList[i].Render(e)}},{key:"Resize",value:function(){this.width=this.ctx.canvas.offsetWidth,this.height=this.ctx.canvas.offsetHeight,this.Render()}}]),t}(),$=function(){function t(){i(this,t)}return n(t,[{key:"Update",value:function(t){}},{key:"Render",value:function(t){}}]),t}(),tt=function t(e,n){function o(t,e){var i={x:0,y:0};return i.x=t.x-e.x,i.y=t.y-e.y,i}function s(t){var i={x:t.clientX,y:t.clientY};if(null!==e.scene.camera){var n=e.canvas.getBoundingClientRect();i.x-=n.left,i.y-=n.top,i=e.scene.camera.ScreenToWorld(i.x,i.y)}return i}function r(t){return function(e){if(e.touches.length>0&&t(e.touches[0]))return e.preventDefault(),!1}}function a(t){var i=s(t);if(null==(p=x.FindItemOne(i))&&(p=e.scene.camera),null!=p){v=i,f=i;var n={event:t,position:i};x.Trigger(p,"mousedown",n)}t.preventDefault()}function h(t){var e=s(t),i=x.FindItemOne(e);if(null!=i?(null==m&&x.Trigger(i,"mouseover",{event:t,position:e}),null!=m&&m.id!=i.id&&(x.Trigger(m,"mouseout",{event:t,position:e}),x.Trigger(i,"mouseover",{event:t,position:e})),m=i,x.Trigger(i,"mouseovermove",{event:t,position:e})):null!=m&&(x.Trigger(m,"mouseout",{event:t,position:e}),m=null),null!=p){var n=o(e,v),r=o(e,f);f=e;var a={offset:r,cameraOffset:n,event:t,currentObject:i};x.Trigger(p,"mousemove",a)}t.preventDefault()}function l(t){var e=s(t),i={event:t,currentObject:x.FindItemOne(e),position:e};v&&f&&v.x==f.x&&v.y==f.y?x.Trigger(p,"click",i):x.Trigger(p,"mouseup",i),m=null,p=null,t.preventDefault()}function c(t){x.Trigger(e.scene.camera,"mouseover",{event:t}),t.preventDefault()}function u(t){x.Trigger(e.scene.camera,"mouseout",{event:t}),t.preventDefault()}function d(t){var i=s(t),n=0;t||(t=window.event),t.wheelDelta?n=t.wheelDelta/120:t.detail&&(n=-t.detail/3),x.Trigger(e.scene.camera,"mousewheel",{event:t,delta:n,position:i}),t.preventDefault()}function y(t){var e=s(t),i=x.FindItemOne(e,"dblclick"),n={event:t,position:e};x.Trigger(i,"dblclick",n),t.preventDefault()}i(this,t);var v,f,p,_=n||e.canvas,x=e.EventStore,m=null;_.onmousedown=a,_.ontouchstart=r(a),_.onmousemove=h,_.ontouchmove=r(h),_.onmouseup=l,_.ontouchup=r(l),_.ondblclick=y,_.onmousewheel=d,_.onmouseover=c,_.onmouseout=u},et=function t(e){function n(t){if(null!==e.scene.camera){var i={event:t,keyCode:t.which||t.keyCode};s.Trigger(e.scene.camera,"keydown",i)}}function o(t){if(null!==e.scene.camera){var i={event:t,keyCode:t.which||t.keyCode};s.Trigger(e.scene.camera,"keyup",i)}}i(this,t);var s=e.EventStore;document.onkeydown=n,document.onkeyup=o};e.DataSource=u,e.EventStore=y,e.StageServer=p,e.ShaderProgram=x,e.Scene3D=S,e.Stage3D=T,e.Stage2D=I,e.Vec2=d,e.Box2=O,e.Scene2D=D,e.Camera2D=P,e.Path2D=W,e.Item=A,e.Map=F,e.MapImage=j,e.Shape=L,e.Rect=R,e.Point=M,e.Line=B,e.Polygon=V,e.BezierLine=H,e.Svg=G,e.Text=X,e.Image=E,e.Sprite=q,e.Unit=z,e.Point2D=Y,e.Rect2D=N,e.TextBox2D=Z,e.EditRect2D=K,e.BezierLine2D=Q,e.HUDContainer=J,e.HUD=$,e.MouseControl=tt,e.KeyboardControl=et});!function(t){t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")&&t.default}(i);var n=i.DataSource,o=(i.EventStore,i.StageServer,i.ShaderProgram,i.Scene3D,i.Stage3D,i.Stage2D),s=i.Vec2,r=(i.Box2,i.Scene2D),a=i.Camera2D,h=(i.Path2D,i.Item),l=(i.Map,i.MapImage,i.Shape,i.Rect),c=i.Point,u=i.Line,d=i.Polygon,y=(i.BezierLine,i.Svg),v=i.Text,f=i.Image,p=(i.Sprite,i.Unit,i.Point2D,i.Rect2D,i.TextBox2D,i.EditRect2D,i.BezierLine2D,i.HUDContainer),_=(i.HUD,i.MouseControl,i.KeyboardControl,function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}),x=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),m=function t(e,i,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,i);if(void 0===o){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,i,n)}if("value"in o)return o.value;var r=o.get;if(void 0!==r)return r.call(n)},g=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},k=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},b=function(t){function e(t){_(this,e);var i=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));if(null==t.pos||t.pos.length<2)return console.error("[pos] is not valid"),k(i);i._position=[];for(var n=0;n<t.pos.length;n++)t.pos[n]instanceof s?i._position[n]=t.pos[n]:t.pos[n]instanceof Array&&(i._position[n]=new s(t.pos[n][0],t.pos[n][1]));return i.isBezier=t.isBezier||!1,i}return g(e,t),x(e,[{key:"Render",value:function(t,e,i,n,o){if(!0!==this.hide){if(t.save(),t.strokeStyle=this.lineColor,t.lineWidth=this.lineWidth,null!=this.lineType&&t.setLineDash(this.lineType),this.opacity<1&&(t.globalAlpha=this.opacity),null!=this.shadow&&(t.shadowColor=this.shadow.color,t.shadowBlur=this.shadow.blur,t.shadowOffsetX=this.shadow.offsetX,t.shadowOffsetY=this.shadow.offsetY),t.beginPath(),null!=e&&null!=i){t.moveTo(e.x,e.y);for(var s=0;s<this._position.length;s++)t.lineTo(this._position[s].x,this._position[s].y);t.lineTo(i.x,i.y)}else for(var r=0;r<this._position.length;r++)0==r?t.moveTo(this._position[0].x,this._position[0].y):t.lineTo(this._position[r].x,this._position[r].y);t.stroke(),t.closePath(),t.restore()}}}]),e}(u),S=function(t){function e(t,i){_(this,e);var o=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));o.stage=i,o.mode=t.mode,o.order=t.order||2;o.collisionCheck=void 0===t.collisionCheck||t.collisionCheck;var s={x:t.x,y:t.y,width:t.width||150,height:t.height||50,text:t.text||"",textColor:t.textColor||"#000000",font:t.font||'normal normal 14px "serif"',lineColor:t.lineColor||"#8395a3",lineType:t.lineType||"SOLID",lineWidth:t.lineWidth||"1.5"};o.lineGap=15,o.isLineSelected=!1,o.itemType="LINE",o.attachers={source:null,target:null},o.defaultTextOpacity=.5;var r={x:t.x,y:t.y,width:16,height:16,order:5};r.color=s.textColor,r.text=s.text,r.font=s.font,r.showBoundBox=!1,r.isEllipsis=!1,o._center=new v(r),o.swapImage=new f({x:o._center.max.x,y:o._center.min.y,width:16,height:16,dataSource:"LayerSwapButton",order:1/0}),o.swapImage.Hide(),o.swapImage.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="pointer"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},click:function(t,e){t.canvasUi.style.cursor="default",t.scene.getItem(this.parentId).SwapLine()}}),o.editImage=new f({x:o._center.max.x,y:o._center.min.y,width:16,height:16,dataSource:"LayerEditButton",order:1/0}),o.editImage.Hide(),o.editImage.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="pointer"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},click:function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._center.min.x,i._center.max.y);var o=i._center._position.getSize();e.position.width=o.x,e.position.height=o.y;var s=n.Load("LineEditPopupLink");"function"==typeof s&&s(i,t,e)}}),o.closeImage=new f({x:o._center.max.x,y:o._center.min.y,width:16,height:16,dataSource:"LayerDelButton",order:1/0}),o.closeImage.Hide(),o.closeImage.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="pointer"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},click:function(t,e){t.canvasUi.style.cursor="default";try{var i=n.Load("CanvasBlur");"function"==typeof i&&(s=i("",this,{}))}catch(t){}t.scene.Remove(this.parentId)}}),o._boundbox=new l({x:s.x,y:s.y,width:s.width,height:s.height,collisionCheck:!1}),o._cs=new c({collisionCheck:!1,opacity:.7,color:s.lineColor,radius:3}),o._ce=new c({collisionCheck:!1,pointType:"ARROW",color:s.lineColor,radius:4}),o._cs.set(o._boundbox._position.min.x,o._boundbox._position.min.y),o._ce.set(o._boundbox._position.max.x,o._boundbox._position.max.y);var a=o._boundbox.GetCenter();o._line=new b({pos:[[o._cs.x,o._cs.y],[o._boundbox._position.max.x,o._boundbox._position.min.y],[a.x,a.y],[o._boundbox._position.min.x,o._boundbox._position.max.y],[o._ce.x,o._ce.y]],lineType:s.lineType,lineColor:s.lineColor,opacity:.7,lineWidth:s.lineWidth,collisionCheck:o.collisionCheck,order:2}),o._line.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="pointer",this.opacity=1},mouseout:function(t,e){t.canvasUi.style.cursor="default",!1===t.scene.getItem(this.parentId).isLineSelected&&(this.opacity=.5)},click:function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);if(e.event.ctrlKey)i.Toggle();else{var n=t.getSelectedAllObjects();if(1==n.length&&void 0!==n[0].isLineSelected&&n[0]._center.id==this.id)i.Toggle();else{for(var o in n){var s=n[o];!0===s.isSelected?s.Toggle():!0===s.isLineSelected&&s.Toggle()}i.Toggle()}}}}),o._cs.Attach(o,function(t){var e=this._cs._position;return null!=this.attachers.source&&(e=this.extendLinePoint(e,this.attachers.source.direction,this.lineGap)),this._boundbox._position.min.set(e.x,e.y),this._line._position[0].set(e.x,e.y),this._boundbox}),o._ce.Attach(o,function(t){var e=this._ce._position;return null!=this.attachers.target&&(e=this.extendLinePoint(e,this.attachers.target.direction,this.lineGap)),this._boundbox._position.max.set(e.x,e.y),this._line._position[4].set(e.x,e.y),this._boundbox});var h={mousemove:function(t,e){this.Translate(e.offset)}};return o._cs.EventStore(h),o._ce.EventStore(h),o._boundbox.Attach(o,function(t){this._cs.set(this._boundbox._position.min.x,this._boundbox._position.min.y),this._ce.set(this._boundbox._position.max.x,this._boundbox._position.max.y);var e=this.lineGap;"left"==t.sourceDirection?this._cs.SetOffset(e,0):"right"==t.sourceDirection?this._cs.SetOffset(-e,0):"top"==t.sourceDirection?this._cs.SetOffset(0,e):"bottom"==t.sourceDirection&&this._cs.SetOffset(0,-e),"left"==t.targetDirection?this._ce.SetOffset(e,0):"right"==t.targetDirection?this._ce.SetOffset(-e,0):"top"==t.targetDirection?this._ce.SetOffset(0,e):"bottom"==t.targetDirection&&this._ce.SetOffset(0,-e);var i=this._boundbox.GetCenter();if(this._line._position[0].set(this._boundbox._position.min.x,this._boundbox._position.min.y),this._line._position[2].set(i.x,i.y),this._line._position[4].set(this._boundbox._position.max.x,this._boundbox._position.max.y),null==t.sourcePoint)return null;var n=[0,0],o=[0,0],s=this.changeWeightPoint(t.sourceDirection,t.targetDirection,t.sourcePoint,t.targetPoint,this._line._position[1],n),r=this.changeWeightPoint(t.targetDirection,t.sourceDirection,t.targetPoint,t.sourcePoint,this._line._position[3],o);return s!==r&&this._line._position[2].set(n[0]+o[0],n[1]+o[1]),s===r?this._center._position.setCenter(i):this._center._position.setCenter(this._line._position[2]),this._center}),o._center.Attach(o,function(t){var e=this._center._position.getCenter().x-8;this.swapImage._position.min.set(e-16,this._center.min.y-16),this.swapImage._position.setSize({x:16,y:16}),this.editImage._position.min.set(e,this._center.min.y-16),this.editImage._position.setSize({x:16,y:16}),this.closeImage._position.min.set(e+16,this._center.min.y-16),this.closeImage._position.setSize({x:16,y:16})}),o._center.EventStore({click:function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);if(e.event.ctrlKey)i.Toggle();else{var n=t.getSelectedAllObjects();if(1==n.length&&void 0!==n[0].isLineSelected&&n[0]._center.id==this.id)i.Toggle();else{for(var o in n){var s=n[o];!0===s.isSelected?s.Toggle():!0===s.isLineSelected&&s.Toggle()}i.Toggle()}}},dblclick:function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._center.min.x,i._center.max.y);var o=t.canvas.getBoundingClientRect();e.position.x+=o.left,e.position.y+=o.top;var s=i._center._position.getSize();e.position.width=s.x,e.position.height=s.y;var r=n.Load("LineEditPopupLink");"function"==typeof r&&r(i,t,e),!1===i.isLineSelected&&i.Toggle()}}),o.needToUpdate=!0,o}return g(e,t),x(e,[{key:"extendLinePoint",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5;if(t instanceof Array){var n=[t[0],t[1]];return"left"==e?n[0]=t[0]-i:"top"==e?n[1]=t[1]-i:"right"==e?n[0]=t[0]+i:"bottom"==e&&(n[1]=t[1]+i),n}var o={x:t.x,y:t.y};return"left"==e?o.x=t.x-i:"top"==e?o.y=t.y-i:"right"==e?o.x=t.x+i:"bottom"==e&&(o.y=t.y+i),o}},{key:"Toggle",value:function(){if(!1===this.isLineSelected){"EDIT"==this.mode&&(this.swapImage.Show(),this.closeImage.Show(),this.editImage.Show(),this._line.opacity=1,this._line.shadow={color:"blue",blur:10,offsetX:0,offsetY:0}),this.isLineSelected=!0;var t=n.Load("WebEditorMgmt");null!=t&&t({type:"active",data:{id:this.id,stage:this.stage,type:"LINE"}})}else{this.swapImage.Hide(),this.closeImage.Hide(),this.editImage.Hide(),this._line.shadow=null,this._line.opacity=.5,this.isLineSelected=!1;var e=n.Load("WebEditorMgmt");null!=e&&e({type:"deactive",data:{id:this.id,stage:this.stage,type:"LINE"}})}}},{key:"ChangeLineStyle",value:function(t){for(var e in t)"lineType"==e?this._line.setLineType(t[e]):this._line[e]=t[e]}},{key:"ChangeColor",value:function(t){this._line.lineColor=t,this._cs.color=t,this._ce.color=t}},{key:"ChangeTextColor",value:function(t){this._center.setColor(t)}},{key:"ChangeText",value:function(t){this._center.setText(t),""!=this._center.text?this._center.setOpacity(this.defaultTextOpacity):this._center.setOpacity(0),this.needToUpdate=!0}},{key:"ChangeFont",value:function(t){this._center.setFont(t),this._center.makeFontAttr(t),this.needToUpdate=!0}},{key:"ChangeFontSize",value:function(t){this._center.setFontSize(t),this.needToUpdate=!0}},{key:"ChangeFontStyle",value:function(t){this._center.setFontStyle(t),this.needToUpdate=!0}},{key:"ChangeFontWeight",value:function(t){this._center.setFontWeight(t),this.needToUpdate=!0}},{key:"ChangeFontFace",value:function(t){this._center.setFontFace(t)}},{key:"SwapLine",value:function(){this._line._position=this._line._position.reverse();var t=this.attachers.source,e=this.attachers.target;this.Disconnect(),this.Connect(e,t)}},{key:"Connect",value:function(t,e){this.attachers.source=t,this.attachers.target=e,this.attachers.source.Attach(this,function(t){var e=this.attachers.source,i=this.attachers.target;this._cs.set(e.x,e.y);var n=this.extendLinePoint(e,e.direction,this.lineGap),o=this.extendLinePoint(i,i.direction,this.lineGap);return t.sourcePoint=[n.x,n.y],t.targetPoint=[o.x,o.y],t.sourceDirection=e.direction,t.targetDirection=i.direction,this._cs}),this.attachers.target.Attach(this,function(t){var e=this.attachers.source,i=this.attachers.target;this._ce.set(i.x,i.y);var n=this.extendLinePoint(e,e.direction,this.lineGap),o=this.extendLinePoint(i,i.direction,this.lineGap);return t.sourcePoint=[n.x,n.y],t.targetPoint=[o.x,o.y],t.sourceDirection=e.direction,t.targetDirection=i.direction,this._ce}),this.setArrowDirection(t.direction,this._cs),this.setArrowDirection(e.direction,this._ce)}},{key:"Disconnect",value:function(){null!=this.attachers.source&&this.attachers.source.Detach(this),null!=this.attachers.target&&this.attachers.target.Detach(this),this.attachers.source=null,this.attachers.target=null}},{key:"setArrowDirection",value:function(t,e){var i=Math.PI/2;"left"==t?e.angle=0:"top"==t?e.angle=i:"right"==t?e.angle=2*i:"bottom"==t&&(e.angle=3*i)}},{key:"changeWeightPoint",value:function(t,e,i,n,o,s){var r=.5*(n[0]-i[0]),a=.5*(n[1]-i[1]),h=!1;return"left"==t?i[0]<n[0]?(o.x=i[0],o.y=n[1]-a,s[1]=n[1]):(o.x=n[0]-r,o.y=i[1],h=!0,s[0]=n[0]):"right"==t?i[0]>n[0]?(o.x=i[0],o.y=n[1]-a,s[1]=n[1]):(o.x=n[0]-r,o.y=i[1],h=!0,s[0]=n[0]):"top"==t?i[1]<n[1]?(o.x=n[0]-r,o.y=i[1],h=!0,s[0]=n[0]):(o.x=i[0],o.y=n[1]-a,s[1]=n[1]):"bottom"==t&&(i[1]>n[1]?(o.x=n[0]-r,o.y=i[1],h=!0,s[0]=n[0]):(o.x=i[0],o.y=n[1]-a,s[1]=n[1])),h}},{key:"smoothWeight",value:function(t,e,i,n){var o=this._boundbox._position.getSize(),s=Math.abs(.5*o.x),r=Math.abs(.5*o.y);s<20&&(s=20),r<20&&(r=20),"left"==t?e[0]<i[0]&&(n.x-=s,e[1]<i[1]?n.y-=r:n.y+=r):"right"==t?e[0]>i[0]&&(n.x+=s,e[1]<i[1]?n.y-=r:n.y+=r):"top"==t?e[1]<i[1]&&(n.y-=r,e[0]<i[0]?n.x-=s:n.x+=s):"bottom"==t&&e[1]>i[1]&&(n.y+=r,e[0]<i[0]?n.x-=s:n.x+=s)}},{key:"smoothWeight2",value:function(t,e,i,n,o,s){"left"==t?e[0]<i[0]?(n.x-=10,e[1]<i[1]?n.y+=10:n.y-=10):n.x-=10:"right"==t?e[0]>i[0]?(n.x+=10,e[1]<i[1]?n.y+=10:n.y-=10):n.x+=10:"top"==t?e[1]<i[1]?(n.y-=10,e[0]<i[0]?n.x+=10:n.x-=10):n.y-=10:"bottom"==t&&(e[1]>i[1]?(n.y+=10,e[0]<i[0]?n.x+=10:n.x-=10):n.y+=10)}},{key:"Destroy",value:function(){this.Disconnect(),delete this._boundbox,delete this._line,delete this._cs,delete this._ce,delete this._center,delete this.swapImage,delete this.closeImage,delete this.editImage}},{key:"Update",value:function(t){}},{key:"Render",value:function(t,e){!0===this.needToUpdate&&(this._center.setBoxSizeCenter(t),this.needToUpdate=!1),null!=this.attachers.source&&null!=this.attachers.target?this._line.Render(t,this.attachers.source.GetCenter(),this.attachers.target.GetCenter()):this._line.Render(t),this._ce.Render(t)}},{key:"RenderAfter",value:function(t,e){this.swapImage.Render(t),this.editImage.Render(t),this.closeImage.Render(t),this._center.Render(t)}},{key:"showAllAttachers",value:function(){}},{key:"hideAllAttachers",value:function(){}},{key:"getSaveData",value:function(){return{id:this.id,source:{id:this.attachers.source.parentId,direction:this.attachers.source.direction},target:{id:this.attachers.target.parentId,direction:this.attachers.target.direction},lineColor:this._line.lineColor,lineType:this._line.lineType,lineWidth:this._line.lineWidth,text:this._center.text,textColor:this._center.color,font:this._center.font}}},{key:"CollisionCheck",value:function(t){return this._line.CollisionCheck(t)}}]),e}(h),T=function(t){function e(t){_(this,e);var i=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),o={x:t.x,y:t.y,width:t.width||100,height:t.height||100,lineColor:t.boundboxLineColor||"#aaaaaa",lineType:t.boundboxLineType||[3,3],lineWidth:t.boundboxLineWidth||1};i.isSelected=!1,i.itemType="OBJECT",i._boundbox=new l(o),i._boundbox.opacity=0,i._boundbox.order=1,i.order=5;return i._cp=new f({x:t.x,y:t.y,width:16,height:16,dataSource:"LayerExpandButton",order:8}),i._cp.visible=!1,i.closeImage=new f({x:t.x,y:t.y,width:16,height:16,dataSource:"LayerDelButton",order:1/0}),i.closeImage.Hide(),i.editImage=new f({x:t.x,y:t.y,width:16,height:16,dataSource:"LayerEditButton",order:1/0}),i.editImage.Hide(),i._boundbox.Attach(i,function(t){this._cp._position.min.set(this._boundbox._position.max.x-16,this._boundbox._position.max.y-16),this._cp._position.setSize({x:16,y:16}),this.closeImage._position.min.set(this._boundbox._position.max.x-16,this._boundbox._position.min.y-16),this.closeImage._position.setSize({x:16,y:16}),this.editImage._position.min.set(this._boundbox._position.max.x-32,this._boundbox._position.min.y-16),this.editImage._position.setSize({x:16,y:16})}),i._boundbox.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="move"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},mousemove:function(t,e){if(t.canvasUi.style.cursor=e.currentObject?"move":"default",this.Translate(e.offset),!0===t.scene.getItem(this.parentId).isSelected){var i=t.getSelectedObjects();for(var n in i){var o=i[n];o._boundbox.id!=this.id&&o._boundbox.Translate(e.offset)}}},mouseup:function(t,e){t.canvasUi.style.cursor=e.currentObject?"move":"default";var i=this._position.min,n=this._position.getSize();t.latestPoint={x:i.x+n.x+15,y:i.y}},mouseovermove:function(t,e){t.canvasUi.style.cursor="move"},click:function(t,e){t.canvasUi.style.cursor=e.currentObject?"move":"default";var i=t.scene.getItem(this.parentId);if(e.event.ctrlKey)i.Toggle();else{var n=t.getSelectedAllObjects();if(1==n.length&&void 0!==n[0].isSelected&&n[0]._boundbox.id==this.id)i.Toggle();else{for(var o in n){var s=n[o];!0===s.isSelected?s.Toggle():!0===s.isLineSelected&&s.Toggle()}i.Toggle()}}}}),i._cp.Attach(i,function(){var t=this._boundbox._position.min.x+20,e=this._boundbox._position.min.y+8;return t>this._cp._position.min.x&&(this._cp._position.min.x=t,this._cp._position.max.x=t+16),e>this._cp._position.min.y&&(this._cp._position.min.y=e,this._cp._position.max.y=e+16),this._boundbox._position.max.set(this._cp._position.max.x,this._cp._position.max.y),this._boundbox}),i._cp.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="nw-resize"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},mousemove:function(t,e){t.canvasUi.style.cursor=e.currentObject?"nw-resize":"default",this.Translate(e.offset)}}),i.closeImage.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="pointer"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},click:function(t,e){t.canvasUi.style.cursor="default";try{var i=n.Load("CanvasBlur");"function"==typeof i&&(o=i("",this,{}))}catch(t){}try{var s=n.Load("RemoveItemCallback"),r=t.scene.getItem(this.parentId);"function"==typeof s&&s(r,t,e)}catch(t){}t.scene.Remove(this.parentId)}}),i.editImage.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="pointer"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},click:function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=t.scene.camera.WorldToScreen(i._boundbox.max.x,i._boundbox.max.y);i._boundbox._position.getSize();e.position.width=o.x-e.position.x,e.position.height=o.y-e.position.y;var s=t.canvas.getBoundingClientRect();e.position.x+=s.left,e.position.y+=s.top;var r=n.Load("TextEditPopupLink");"function"==typeof r&&r(this.parentId,t,e)}}),i}return g(e,t),x(e,[{key:"Destroy",value:function(){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this._boundbox,delete this._cp,delete this.closeImage,delete this.editImage}},{key:"Render",value:function(t){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),this._boundbox.Render(t),1==this._cp.visible&&this._cp.Render(t)}},{key:"RenderAfter",value:function(t,e){this.closeImage.Render(t),this.editImage.Render(t)}},{key:"Toggle",value:function(){}},{key:"showAllAttachers",value:function(){}},{key:"hideAllAttachers",value:function(){}},{key:"CollisionCheck",value:function(t){return this._boundbox.CollisionCheck(t)}},{key:"GetSaveData",value:function(){var t=this._boundbox._position.min,e=this._boundbox._position.getSize();return{id:this.id,x:t.x,y:t.y,width:e.x,height:e.y}}}]),e}(h),w=function(t){function e(t){_(this,e);var i=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));i.mode=t.mode,null!=t.order&&(i.order=t.order),"EDIT"==i.mode&&(i.editImage.eventStore.click=function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=t.canvas.getBoundingClientRect();e.position.x+=o.left,e.position.y+=o.top;var s=i._boundbox._position.getSize();e.position.width=s.x,e.position.height=s.y;var r=n.Load("EditPopupLink");"function"==typeof r&&r(i,t,e)},i._boundbox.eventStore.dblclick=function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=t.canvas.getBoundingClientRect();e.position.x+=o.left,e.position.y+=o.top;var s=i._boundbox._position.getSize();e.position.width=s.x,e.position.height=s.y;var r=n.Load("EditPopupLink");"function"==typeof r&&r(i,t,e),!1===i.isSelected&&i.Toggle()});var o={x:t.x,y:t.y,width:t.width||150,height:t.height||50,color:t.color||"#999999",dataSource:t.dataSource||"SVG_DIRECT",bgColor:t.bgColor||"#ffffff",text:t.text||"...",font:t.font||'normal normal 14px "Noto Sans KR"',textColor:t.textColor||"#444444",textAlign:t.textAlign||"left",url:t.url||""},s={x:o.x,y:o.y,width:o.width,height:o.height,collisionCheck:!1};s.color=o.bgColor,s.lineColor="#808080",s.lineWidth=2,s.round=15,s.order=5,i._rect=new l(s);var r={x:o.x,y:o.y,width:126,height:126,color:o.color,collisionCheck:!1};r.svg=n.Load(o.dataSource),i.icon=new y(r),i.icon.dataSource=o.dataSource,i.dataSource=o.dataSource;var a=n.Load("ClickPopupLink"),h={x:o.x,y:o.y,width:10,height:10,lineColor:"#aaaaaa",collisionCheck:!1,order:6};h.color=o.textColor,h.align=o.textAlign,h.font=o.font,h.text=o.text,h.url=o.url,"EDIT"==i.mode?h.collisionCheck=!1:null!=a&&(h.collisionCheck=!0),i.text=new v(h),null!=a&&(i.text.eventStore={mouseover:function(t,e){t.canvasUi.style.cursor="pointer"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},click:function(t,e){t.canvasUi.style.cursor="default";var i=n.Load("ClickPopupLink"),o=t.scene.getItem(this.parentId);"function"==typeof i&&i(o,t,e)}});var c={x:t.x,y:t.y,width:16,height:16};return c.color="#ffffff",c.text="",c.font=o.font||'normal normal 12px "Noto Sans KR"',c.showBoundBox=!0,c.isEllipsis=!1,c.boundboxOpacity=.7,c.lineColor="#aaaaaa",c.bgColor="#888888",c.isChangeLine=!0,i.textToolTip=new v(c),i.textToolTip.eventStore={dblclick:function(t,e){var i=n.Load("DoubleClickMenuPath");"function"==typeof i&&i(this.text,t,e)}},i.textToolTip.Hide(),i._boundbox.Attach(i,function(t){var e=this._boundbox.GetCenter();this._rect.min.set(this._boundbox.min.x,this._boundbox.min.y),this._rect.max.set(this._boundbox.max.x,this._boundbox.max.y),this._rect.setScale();this.icon._position.min.set(this._boundbox.min.x+12,this._boundbox.min.y+12);var i=this._boundbox.max.y-this._boundbox.min.y-24;this.icon._position.setSize({x:i,y:i}),this.icon.setScale();var n=.5;"Noto Sans KR"!=this.text.fontFace&&"맑은 고딕"!=this.text.fontFace||(n=.8),this.text.min.set(this._boundbox.min.x+i+12+5,e.y-this.text.fontSize*n),this.text.max.set(this._boundbox.max.x-12,e.y+this.text.fontSize*n),this.textToolTip.min.set(this._boundbox.min.x+10,this._boundbox.max.y);var o=1.3*this.textToolTip.fontSize*this.textToolTip.getMaxHeight();this.textToolTip.max.set(this._boundbox.min.x+this.textToolTip.getMaxWidth()+10+10,this._boundbox.max.y+o)}),i}return g(e,t),x(e,[{key:"ChangeTooltip",value:function(t){this.textToolTip.text=t,""==this.textToolTip.text?this.textToolTip.Hide():this.textToolTip.Show(),this.needToUpdate=!0}},{key:"ChangeIcon",value:function(t){var e=n.Load(t);this.icon.changeSvg(e),this.dataSource=t}},{key:"ChangeTextAlign",value:function(t){this.text.setAlign(t)}},{key:"ChangeColor",value:function(t){this.icon.setColor(t)}},{key:"ChangeBgColor",value:function(t){this._rect.setColor(t)}},{key:"ChangeTextColor",value:function(t){this.text.setColor(t)}},{key:"ChangeText",value:function(t){this.text.setText(t)}},{key:"ChangeFont",value:function(t){this.text.setFont(t),this.text.makeFontAttr(t),this.needToUpdate=!0}},{key:"ChangeFontSize",value:function(t,e){this.text.setFontSize(t),this.needToUpdate=!0}},{key:"ChangeFontStyle",value:function(t){this.text.setFontStyle(t),this.needToUpdate=!0}},{key:"ChangeFontWeight",value:function(t){this.text.setFontWeight(t),this.needToUpdate=!0}},{key:"ChangeFontFace",value:function(t){this.text.setFontFace(t),this.needToUpdate=!0}},{key:"ChangeUrl",value:function(t){this.text.setUrl(t)}},{key:"ChangeTextCollision",value:function(t){this.text.setCollisionCheck(t)}},{key:"Destroy",value:function(){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this.icon,delete this._rect,delete this.text}},{key:"Update",value:function(t,e,i,n){}},{key:"Render",value:function(t,i){!0===this.needToUpdate&&(null!=this.textToolTip&&this.textToolTip.setMaxWidth(t),this._boundbox.executeAttach(),this.needToUpdate=!1),this._rect.Render(t),m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),this.icon.Render(t),this.text.Render(t)}},{key:"RenderAfter",value:function(t,i){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"RenderAfter",this).call(this,t,i),null!=this.textToolTip&&""!=this.textToolTip.text&&this.textToolTip.Render(t)}},{key:"Toggle",value:function(){!1===this.isSelected?(this._rect.shadow={color:"blue",blur:20,offsetX:0,offsetY:0},this._cp.Show(),"EDIT"==this.mode&&(this.closeImage.Show(),this.editImage.Show()),this.isSelected=!0):(this._rect.shadow=null,this._cp.Hide(),this.closeImage.Hide(),this.editImage.Hide(),this.isSelected=!1)}},{key:"getSaveData",value:function(){var t=this.GetSaveData();return t.color=this.icon.color,t.dataSource=this.icon.dataSource,t.bgColor=this._rect.color,t.text=this.text.text,t.font=this.text.font,t.textColor=this.text.color,t.textAlign=this.text.align,t.url=this.text.url,t.order=this.order,t}}]),e}(T),C=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_(this,e);var i=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.radius=t.radius||5,i.color="#0000aa",i.lineColor="#0000aa",i.direction=t.direction||"left",i.opacity=0,i.attachedLines={},i.attachedTarget={},i}return g(e,t),x(e,[{key:"Destroy",value:function(t){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this,t);for(var i in this.attachs){var n=this.attachObjects[i];n instanceof S&&(n.Disconnect(),t.scene.Remove(n.id))}}}]),e}(c),I=function(t){function e(t){_(this,e);var i=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),o=i._boundbox.GetCenter();i._leftAttacher=new C({x:i._boundbox._position.min.x,y:o.y,radius:10,direction:"left",lineWidth:1,pointType:"",order:7}),i._topAttacher=new C({x:o.x,y:i._boundbox._position.min.y,radius:10,direction:"top",lineWidth:1,pointType:"",order:7}),i._rightAttacher=new C({x:i._boundbox._position.max.x,y:o.y,radius:10,direction:"right",lineWidth:1,pointType:"",order:7}),i._bottomAttacher=new C({x:o.x,y:i._boundbox._position.max.y,radius:10,direction:"bottom",lineWidth:1,pointType:"",order:7}),"VIEW"==i.mode&&(i._leftAttacher.setCollisionCheck(!1),i._topAttacher.setCollisionCheck(!1),i._rightAttacher.setCollisionCheck(!1),i._bottomAttacher.setCollisionCheck(!1)),i._boundbox.Attach(i,function(t){var e=this._boundbox.GetCenter();return this._leftAttacher.set(this._boundbox._position.min.x,e.y),this._topAttacher.set(e.x,this._boundbox._position.min.y),this._rightAttacher.set(this._boundbox._position.max.x,e.y),this._bottomAttacher.set(e.x,this._boundbox._position.max.y),[this._leftAttacher,this._topAttacher,this._rightAttacher,this._bottomAttacher]}),i._boundbox.EventStore({mouseover:function(t,e){"EDIT"==t.mode&&t.scene.getItem(this.parentId).showAllAttachers()},mouseout:function(t,e){"EDIT"==t.mode&&t.scene.getItem(this.parentId).hideAllAttachers()}});var s={mouseover:function(t,e){t.canvasUi.style.cursor="pointer",this.opacity=.5},mouseout:function(t,e){t.canvasUi.style.cursor="default",this.opacity=0},mousedown:function(t,e){t.canvasUi.style.cursor=e.currentObject?"pointer":"default";var i={},o=n.Load("lineOptionsCallback");"function"==typeof o&&(i=o(this.id,t,i)),i.x=e.position.x,i.y=e.position.y,i.width=1,i.height=1,i.order=7,i.collisionCheck=!1,this.attachLine=new S(i,t),this.attachLine._center.Hide(),t.scene.Add(this.attachLine)},mousemove:function(t,e){t.canvasUi.style.cursor=e.currentObject?"pointer":"default",1==e.event.buttons?("EDIT"==t.mode&&t.showAllAttachers(),this.attachLine._ce.setAngle(this.attachLine._boundbox._position.min,this.attachLine._boundbox._position.max),this.attachLine._ce.Translate(e.offset)):null!=this.attachLine&&null!=this.attachLine.id&&(t.scene.Remove(this.attachLine.id),t.canvasUi.style.cursor="default",delete this.attachLine)},mouseup:function(t,e){if(t.canvasUi.style.cursor=e.currentObject?"pointer":"default",null!=e.currentObject)if(e.currentObject instanceof C){var i={},o=n.Load("lineOptionsCallback");"function"==typeof o&&(i=o(this.id,t,i)),t.scene.getItem(this.parentId)._lineConnecting(t,this,e.currentObject,i)}else console.log("currentObject is not a Attacher");else console.log("currentObject is null");"EDIT"==t.mode&&t.hideAllAttachers(),t.scene.Remove(this.attachLine.id),t.canvasUi.style.cursor="default",delete this.attachLine},click:function(t,e){t.canvasUi.style.cursor=e.currentObject?"pointer":"default",null!=this.attachLine.id&&(t.scene.Remove(this.attachLine.id),t.canvasUi.style.cursor="default",delete this.attachLine)}};return"EDIT"==t.mode&&(i._leftAttacher.EventStore(s),i._topAttacher.EventStore(s),i._rightAttacher.EventStore(s),i._bottomAttacher.EventStore(s)),i}return g(e,t),x(e,[{key:"showAllAttachers",value:function(){this._leftAttacher.opacity=.5,this._topAttacher.opacity=.5,this._rightAttacher.opacity=.5,this._bottomAttacher.opacity=.5}},{key:"hideAllAttachers",value:function(){this._leftAttacher.opacity=0,this._topAttacher.opacity=0,this._rightAttacher.opacity=0,this._bottomAttacher.opacity=0}},{key:"_lineConnecting",value:function(t,e,i,n){if(e.id!=i.id&&(!e.parentId||e.parentId!==i.parentId)){var o=t.getAllLineObjects();for(var s in o)if(null!=o[s].attachers.source)if(e.id===o[s].attachers.source.id){if(i.id===o[s].attachers.target.id)return}else if(e.id===o[s].attachers.target.id&&i.id===o[s].attachers.source.id)return;var r=e.x,a=e.y,h=i.x,l=i.y;n.mode=this.mode,n.x=r,n.y=a,n.width=h-r,n.height=l-a;var c=new S(n,t);t.scene.Add(c),c.Connect(e,i)}}},{key:"Destroy",value:function(){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this._leftAttacher,delete this._topAttacher,delete this._rightAttacher,delete this._bottomAttacher}},{key:"Render",value:function(t,i){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),this._leftAttacher.Render(t),this._topAttacher.Render(t),this._rightAttacher.Render(t),this._bottomAttacher.Render(t)}},{key:"Toggle",value:function(){}}]),e}(T),O=function(t){function e(t){_(this,e);var i=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));i.mode=t.mode,null!=t.order&&(i.order=t.order);var o={x:t.x,y:t.y,width:t.width||200,height:t.height||200,lineColor:t.lineColor||"#000000",lineWidth:t.lineWidth||0,lineType:t.lineType,url:t.url||""},s={x:o.x,y:o.y,width:o.width,height:o.height,collisionCheck:!1};return s.lineColor=o.lineColor,s.lineWidth=o.lineWidth,s.lineType=o.lineType,i._rect=new l(s),n.Add(i.id,{type:"IMAGE",target:o.url}),i._image=new f({x:o.x,y:o.y,width:o.width,height:o.height,dataSource:i.id,collisionCheck:!1,isDynamic:!0}),i._boundbox.Attach(i,function(t){this._rect.min.set(this._boundbox.min.x,this._boundbox.min.y),this._rect.max.set(this._boundbox.max.x,this._boundbox.max.y),this._rect.setScale(),this._image.min.set(this._boundbox.min.x+3,this._boundbox.min.y+3),this._image.max.set(this._boundbox.max.x-3,this._boundbox.max.y-3),this._image.setScale()}),i}return g(e,t),x(e,[{key:"ChangeLineStyle",value:function(t){for(var e in t)"lineType"==e?this._rect.setLineType(t[e]):this._rect[e]=t[e]}},{key:"ChangeColor",value:function(t){this._rect.setLineColor(t)}},{key:"Destroy",value:function(){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this._image,delete this._rect}},{key:"Render",value:function(t,i){0!==this._rect.lineWidth&&this._rect.Render(t),this._image.Render(t),m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t)}},{key:"Toggle",value:function(){!1===this.isSelected?(this._image.shadow={color:"blue",blur:20,offsetX:0,offsetY:0},this._cp.Show(),"EDIT"==this.mode&&this.closeImage.Show(),this.isSelected=!0):(this._image.shadow=null,this._cp.Hide(),this.closeImage.Hide(),this.isSelected=!1)}},{key:"getSaveData",value:function(){var t=this.GetSaveData();if(0==this._image.image.src.indexOf("http"))t.url=this._image.image.src;else{var e=n.EncodeImageToBase64(this._image.image);t.url=e}return t.dataSource="IMAGE",t.order=this.order,t.lineColor=this._rect.lineColor,t.lineWidth=this._rect.lineWidth,t.lineType=this._rect.lineType,t}}]),e}(I),A=function(t){function e(t){_(this,e);var i=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));i.mode=t.mode,i.stage=t.stage,null!=t.order&&(i.order=t.order);var o={x:t.x,y:t.y,width:t.width||200,height:t.height||100,text:t.text||"",textVAlign:t.textVAlign||"middle",polygonType:t.polygonType||"RECT"};i.text=o.text,i._boundbox.EventStore({mousedown:function(t,e){var i=n.Load("WebEditorMgmt");null!=i&&i({type:"deactive",data:{id:t.scene.getItem(this.parentId).id,stage:t}})},mouseup:function(t,e){var i=this._position.min,o=this._position.getSize();t.latestPoint={x:i.x+o.x+15,y:i.y};var s=t.scene.getItem(this.parentId);if(1==s._cp.visible){var r=n.Load("WebEditorMgmt");null!=r&&r({type:"active",data:{id:s.id,stage:t}})}}}),"VIEW"==i.mode&&i._boundbox.setCollisionCheck(!1),"EDIT"==i.mode&&i._boundbox.EventStore({click:function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=t.scene.camera.WorldToScreen(i._boundbox.max.x,i._boundbox.max.y);i._boundbox._position.getSize();e.position.width=o.x-e.position.x,e.position.height=o.y-e.position.y;var s=n.Load("TextEditPopupLink");if("function"==typeof s&&s(i,t,e),e.event.ctrlKey)i.Toggle();else{var r=t.getSelectedAllObjects();if(1==r.length&&void 0!==r[0].isSelected&&r[0]._boundbox.id==this.id)i.Toggle();else{for(var a in r){var h=r[a];!0===h.isSelected?h.Toggle():!0===h.isLineSelected&&h.Toggle()}i.Toggle()}}}},!0),"EDIT"==i.mode&&i.editImage.EventStore({click:function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=t.scene.camera.WorldToScreen(i._boundbox.max.x,i._boundbox.max.y);i._boundbox._position.getSize();e.position.width=o.x-e.position.x,e.position.height=o.y-e.position.y;var s=t.canvas.getBoundingClientRect();e.position.x+=s.left,e.position.y+=s.top;var r=n.Load("TextEditPopupLink");"function"==typeof r&&r(i,t,e)}},!0),i._cp.EventStore({mousedown:function(t,e){var i=n.Load("WebEditorMgmt");null!=i&&i({type:"deactive",data:{id:t.scene.getItem(this.parentId).id,stage:t}})},mouseup:function(t,e){if(1==this.visible){var i=n.Load("WebEditorMgmt");null!=i&&i({type:"active",data:{id:t.scene.getItem(this.parentId).id,stage:t}})}}},!0);var s={x:o.x,y:o.y,width:o.width,height:o.height,collisionCheck:!1};s.lineColor="#cccccc",s.lineWidth=1,s.lineType="DOT",s.polygonType="RECT",i._rect=new d(s);var r=n.Load("WebEditorMgmt");return null!=r&&r({type:"init",data:{id:i.id,stage:i.stage,text:o.text,valign:o.textVAlign}}),i._boundbox.Attach(i,function(t){this._rect.min.set(this._boundbox.min.x,this._boundbox.min.y),this._rect.max.set(this._boundbox.max.x,this._boundbox.max.y),this._rect.setScale()}),i}return g(e,t),x(e,[{key:"ChangeIcon",value:function(t){}},{key:"ChangeUrl",value:function(t){}},{key:"ChangeTextAlign",value:function(t){}},{key:"ChangeTextVAlign",value:function(t){var e=n.Load("WebEditorMgmt");null!=e&&e({type:"setVAlign",data:{id:this.id,stage:this.stage,valign:t}})}},{key:"ChangeBgColor",value:function(t){}},{key:"ChangeTextColor",value:function(t){}},{key:"ChangeText",value:function(t){var e=n.Load("WebEditorMgmt");if(null!=e){var i=e({type:"getText",data:{id:this.id,stage:this.stage}});""!=i&&"<br>"!=i||e({type:"setText",data:{id:this.id,stage:this.stage,text:t}})}}},{key:"ChangeFont",value:function(t){}},{key:"ChangeFontSize",value:function(t){}},{key:"ChangeFontStyle",value:function(t){}},{key:"ChangeFontWeight",value:function(t){}},{key:"ChangeFontFace",value:function(t){}},{key:"ChangeLineStyle",value:function(t){}},{key:"ChangeIconColor",value:function(t){}},{key:"ChangeColor",value:function(t){}},{key:"ChangePolygonType",value:function(t){}},{key:"Destroy",value:function(){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this._rect;var t=n.Load("WebEditorMgmt");null!=t&&t({type:"destroy",data:{id:this.id,stage:this.stage}})}},{key:"Update",value:function(t,e,i,n){}},{key:"Render",value:function(t,i,o){if("EDIT"==this.mode&&this._rect.Render(t),m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),null!=o){var s=n.Load("WebEditorMgmt"),r=i.WorldToScreen(this._rect.min.x+5,this._rect.min.y+5),a=this._rect._position.getSize();r.id=this.id,r.w=a.x-10,r.h=a.y-10,r.text=this.text,r.zoom=i._viewport.scale.x,r.index=o,r.stage=this.stage,null!=s&&s({type:"update",data:r})}}},{key:"Toggle",value:function(){if(!1===this.isSelected){this._boundbox.opacity=1,"TEXT"!=this._rect.polygonType&&(this._rect.shadow={color:"blue",blur:20,offsetX:0,offsetY:0}),this._cp.visible=!0,"EDIT"==this.mode&&(this.closeImage.Show(),this.editImage.Show()),this.isSelected=!0;var t=n.Load("WebEditorMgmt");null!=t&&t({type:"active",data:{id:this.id,stage:this.stage}})}else{this._boundbox.opacity=0,this._rect.shadow=null,this._cp.visible=!1,this.closeImage.Hide(),this.editImage.Hide(),this.isSelected=!1;var e=n.Load("WebEditorMgmt");null!=e&&e({type:"deactive",data:{id:this.id,stage:this.stage}})}}},{key:"getText",value:function(){var t=n.Load("WebEditorMgmt");return null!=t?t({type:"getText",data:{id:this.id,stage:this.stage}}):""}},{key:"getTitle",value:function(){var t=n.Load("WebEditorMgmt");return null!=t?t({type:"getTitle",data:{id:this.id,stage:this.stage}}):""}},{key:"getVAlign",value:function(){var t=n.Load("WebEditorMgmt");return null!=t?t({type:"getVAlign",data:{id:this.id,stage:this.stage}}):""}},{key:"getSaveData",value:function(){var t=this.GetSaveData();return t.iconType=this.dataSource,t.color="",t.url="",t.dataSource=this.dataSource,t.text=this.getText(),t.title=this.getTitle(),t.font='normal normal 14px "serif"',t.textVAlign=this.getVAlign(),t.polygonType="TEXT",t.order=this.order,t}}]),e}(T),P=function(t){function e(t){_(this,e);var i=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));i.mode=t.mode,i.stage=t.stage,null!=t.order&&(i.order=t.order);var o={x:t.x,y:t.y,width:t.width||200,height:t.height||100,bgColor:t.bgColor||"#ffffff",text:t.text||"",font:t.font||'normal normal 14px "serif"',textAlign:t.textAlign||"center",textVAlign:t.textVAlign||"middle",textColor:t.textColor||"#444444",lineColor:t.lineColor||"#000000",lineWidth:null!=t.lineWidth?t.lineWidth:1,lineType:t.lineType,polygonType:t.polygonType||"RECT",color:t.color||"#999999",dataSource:t.dataSource,url:t.url||""};i._boundbox.EventStore({mousedown:function(t,e){var i=n.Load("WebEditorMgmt");null!=i&&i({type:"deactive",data:{id:t.scene.getItem(this.parentId).id,stage:t}})},mouseup:function(t,e){var i=this._position.min,o=this._position.getSize();t.latestPoint={x:i.x+o.x+15,y:i.y};var s=t.scene.getItem(this.parentId);if(1==s._cp.visible){var r=n.Load("WebEditorMgmt");null!=r&&r({type:"active",data:{id:s.id,stage:t}})}}}),"VIEW"==i.mode&&i._boundbox.EventStore({dblclick:function(t,e){var i=n.Load("DoubleClickMenuPath");"function"==typeof i&&i(t.scene.getItem(this.parentId),t,e)}}),"EDIT"==i.mode&&i._boundbox.EventStore({click:function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);if(2==e.event.button||3==e.event.which){var o=n.Load("TextEditPopupLinkRight");"function"==typeof o&&o(i,t,e)}else{e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var s=t.scene.camera.WorldToScreen(i._boundbox.max.x,i._boundbox.max.y);i._boundbox._position.getSize();e.position.width=s.x-e.position.x,e.position.height=s.y-e.position.y;var r=n.Load("TextEditPopupLink");if("function"==typeof r&&r(i,t,e),e.event.ctrlKey)i.Toggle();else{var a=t.getSelectedAllObjects();if(1==a.length&&void 0!==a[0].isSelected&&a[0]._boundbox.id==this.id)i.Toggle();else{for(var h in a){var l=a[h];!0===l.isSelected?l.Toggle():!0===l.isLineSelected&&l.Toggle()}i.Toggle()}}}}},!0),"EDIT"==i.mode&&i.editImage.EventStore({click:function(t,e){t.canvasUi.style.cursor="default";var i=t.scene.getItem(this.parentId);e.position=t.scene.camera.WorldToScreen(i._boundbox.min.x,i._boundbox.min.y);var o=t.scene.camera.WorldToScreen(i._boundbox.max.x,i._boundbox.max.y);i._boundbox._position.getSize();e.position.width=o.x-e.position.x,e.position.height=o.y-e.position.y;var s=t.canvas.getBoundingClientRect();e.position.x+=s.left,e.position.y+=s.top;var r=n.Load("TextEditPopupLink");"function"==typeof r&&r(i,t,e)}},!0),i._cp.EventStore({mousedown:function(t,e){var i=n.Load("WebEditorMgmt");null!=i&&i({type:"deactive",data:{id:t.scene.getItem(this.parentId).id,stage:t}})},mouseup:function(t,e){if(1==this.visible){var i=n.Load("WebEditorMgmt");null!=i&&i({type:"active",data:{id:t.scene.getItem(this.parentId).id,stage:t}})}}},!0);var s={x:o.x,y:o.y,width:o.width,height:o.height,collisionCheck:!1};s.color=o.bgColor,s.lineColor=o.lineColor,s.lineWidth=o.lineWidth,s.lineType=o.lineType,s.polygonType=o.polygonType,i._rect=new d(s);var r={x:o.x,y:o.y,width:10,height:10,lineColor:"#aaaaaa",collisionCheck:!1};r.color=o.textColor,r.align=o.textAlign,r.valign=o.textVAlign,r.font=o.font,r.text=o.text,r.url=o.url,r.isChangeLine=!0,i._text=new v(r);var a=n.Load("WebEditorMgmt");null!=a&&a({type:"init",data:{id:i.id,stage:i.stage,text:o.text,valign:o.textVAlign}});var h={x:o.x,y:o.y,width:126,height:126,color:o.color,collisionCheck:!0,order:8};if(h.svg=n.Load(o.dataSource),i.icon=new y(h),i.icon.dataSource=o.dataSource,i.dataSource=o.dataSource,i.icon.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="pointer"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},click:function(t,e){t.canvasUi.style.cursor="default";var i=n.Load("ChangeLinkPop"),o=t.scene.getItem(this.parentId);"function"==typeof i&&i(o,t,e)}}),null!=i.dataSource?i.icon.Show():i.icon.Hide(),"VIEW"==i.mode&&null!=i.dataSource&&null!=n.Load("ClickPopupLink")){var c={x:o.x,y:o.y,width:10,height:10,lineWidth:0,collisionCheck:!0,order:9,url:o.url};i._link=new l(c),i._link.EventStore({mouseover:function(t,e){t.canvasUi.style.cursor="pointer"},mouseout:function(t,e){t.canvasUi.style.cursor="default"},click:function(t,e){t.canvasUi.style.cursor="default";var i=n.Load("ClickPopupLink"),o=t.scene.getItem(this.parentId);"function"==typeof i&&i(o,t,e)}})}return i._boundbox.Attach(i,function(t){if(this._rect.min.set(this._boundbox.min.x,this._boundbox.min.y),this._rect.max.set(this._boundbox.max.x,this._boundbox.max.y),this._rect.setScale(),null!=this._link){this._link.min.set(this._boundbox.min.x+5,this._boundbox.min.y+5),this._link.max.set(this._boundbox.max.x-5,this._boundbox.max.y-5),this._link.setScale()}var e=this._boundbox.max.y-this._boundbox.min.y,i={x:this._boundbox.min.x+.1*e,y:this._boundbox.min.y+.1*e},n=.8*e;32<n&&(e=40,i={x:this._boundbox.min.x+.1*e,y:this._boundbox.min.y+.1*e},n=32),this.icon._position.min.set(i.x,i.y),this.icon._position.setSize({x:n,y:n}),this.icon.setScale(),this._text.min.set(this._rect.min.x+3,this._rect.min.y+3),this._text.max.set(this._rect.max.x-3,this._rect.max.y-3)}),i}return g(e,t),x(e,[{key:"ChangeIcon",value:function(t){var e=n.Load(t);this.icon.changeSvg(e),this.dataSource=t,null!=this.dataSource?this.icon.Show():this.icon.Hide()}},{key:"ChangeUrl",value:function(t){this._text.setUrl(t)}},{key:"ChangeTextAlign",value:function(t){this._text.setAlign(t)}},{key:"ChangeTextVAlign",value:function(t){this._text.valign=t;var e=n.Load("WebEditorMgmt");null!=e&&e({type:"setVAlign",data:{id:this.id,stage:this.stage,valign:t}})}},{key:"ChangeBgColor",value:function(t){this._rect.setColor(t)}},{key:"ChangeTextColor",value:function(t){this._text.setColor(t)}},{key:"ChangeText",value:function(t){this._text.setText(t);var e=n.Load("WebEditorMgmt");if(null!=e){var i=e({type:"getText",data:{id:this.id,stage:this.stage}});""!=i&&"<br>"!=i||e({type:"setText",data:{id:this.id,stage:this.stage,text:t}})}}},{key:"ChangeFont",value:function(t){this._text.setFont(t),this._text.makeFontAttr(t)}},{key:"ChangeFontSize",value:function(t){this._text.setFontSize(t)}},{key:"ChangeFontStyle",value:function(t){this._text.setFontStyle(t)}},{key:"ChangeFontWeight",value:function(t){this._text.setFontWeight(t)}},{key:"ChangeFontFace",value:function(t){this._text.setFontFace(t)}},{key:"ChangeLineStyle",value:function(t){for(var e in t)"lineType"==e?this._rect.setLineType(t[e]):this._rect[e]=t[e]}},{key:"ChangeIconColor",value:function(t){this.icon.setColor(t)}},{key:"ChangeColor",value:function(t){this._rect.setLineColor(t)}},{key:"ChangePolygonType",value:function(t){this._rect.setPolygonType(t||"RECT")}},{key:"Destroy",value:function(){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Destroy",this).call(this),delete this.icon,delete this._text,delete this._rect,null!=this._link&&delete this._link;var t=n.Load("WebEditorMgmt");null!=t&&t({type:"destroy",data:{id:this.id,stage:this.stage}})}},{key:"Update",value:function(t,e,i,n){}},{key:"Render",value:function(t,i,o){if(this._rect.Render(t),m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Render",this).call(this,t),this.icon.Render(t),null!=o){var s=n.Load("WebEditorMgmt"),r=i.WorldToScreen(this._rect.min.x+5,this._rect.min.y+5),a=this._rect._position.getSize();r.id=this.id,r.w=a.x-10,r.h=a.y-10,r.text=this._text.text,r.zoom=i._viewport.scale.x,r.index=o,r.stage=this.stage,null!=s&&s({type:"update",data:r})}}},{key:"Toggle",value:function(){if(!1===this.isSelected){this._boundbox.opacity=1,"TEXT"!=this._rect.polygonType&&(this._rect.shadow={color:"blue",blur:20,offsetX:0,offsetY:0}),this._cp.visible=!0,"EDIT"==this.mode&&(this.closeImage.Show(),this.editImage.Show()),this.isSelected=!0;var t=n.Load("WebEditorMgmt");null!=t&&t({type:"active",data:{id:this.id,stage:this.stage}})}else{this._boundbox.opacity=0,this._rect.shadow=null,this._cp.visible=!1,this.closeImage.Hide(),this.editImage.Hide(),this.isSelected=!1;var e=n.Load("WebEditorMgmt");null!=e&&e({type:"deactive",data:{id:this.id,stage:this.stage}})}}},{key:"getText",value:function(){var t=n.Load("WebEditorMgmt");return null!=t?t({type:"getText",data:{id:this.id,stage:this.stage}}):""}},{key:"getTitle",value:function(){var t=n.Load("WebEditorMgmt");return null!=t?t({type:"getTitle",data:{id:this.id,stage:this.stage}}):""}},{key:"getVAlign",value:function(){var t=n.Load("WebEditorMgmt");return null!=t?t({type:"getVAlign",data:{id:this.id,stage:this.stage}}):""}},{key:"getSaveData",value:function(){var t=this.GetSaveData();return t.iconType=this.dataSource,t.color=this.icon.color,t.url=this._text.url,t.dataSource=this.dataSource,t.text=this.getText(),t.title=this.getTitle(),t.font=this._text.font,t.textColor=this._text.color,t.textAlign=this._text.align,t.textVAlign=this.getVAlign(),t.bgColor=this._rect.color,t.polygonType=this._rect.polygonType,t.lineColor=this._rect.lineColor,t.lineWidth=this._rect.lineWidth,t.lineType=this._rect.lineType,t.order=this.order,t}}]),e}(I),z=function t(e){function i(t,e){var i={x:0,y:0};return i.x=t.x-e.x,i.y=t.y-e.y,i}function n(t){var i={x:t.clientX,y:t.clientY};if(null!==e.scene.camera){var n=e.canvas.getBoundingClientRect();i.x-=n.left,i.y-=n.top,i=e.scene.camera.ScreenToWorld(i.x,i.y)}return i}function o(t){return function(e){if(e.touches.length>0&&t(e.touches[0]))return e.preventDefault(),!1}}function s(t){var i=n(t);if(null==(d=v.FindItemOne(i))&&(d=e.scene.camera),null!=d){c=i,u=i;var o={event:t,position:i};v.Trigger(d,"mousedown",o)}t.preventDefault()}function r(t){var e=n(t),o=v.FindItemOne(e);if(null!=o?(null==f&&v.Trigger(o,"mouseover",{event:t,position:e}),null!=f&&f.id!=o.id&&(v.Trigger(f,"mouseout",{event:t,position:e}),v.Trigger(o,"mouseover",{event:t,position:e})),f=o,v.Trigger(o,"mouseovermove",{event:t,position:e})):null!=f&&(v.Trigger(f,"mouseout",{event:t,position:e}),f=null),null!=d){var s=i(e,c),r=i(e,u);u=e;var a={offset:r,cameraOffset:s,event:t,currentObject:o};v.Trigger(d,"mousemove",a)}t.preventDefault()}function a(t){var e=n(t),i={event:t,currentObject:v.FindItemOne(e),position:e};c&&u&&c.x==u.x&&c.y==u.y?v.Trigger(d,"click",i):v.Trigger(d,"mouseup",i),f=null,d=null,t.preventDefault()}function h(t){var i=n(t),o=0;t||(t=window.event),t.wheelDelta?o=t.wheelDelta/120:t.detail&&(o=-t.detail/3),v.Trigger(e.scene.camera,"mousewheel",{event:t,delta:o,position:i}),t.preventDefault()}function l(t){var e=n(t),i=v.FindItemOne(e,"dblclick"),o={event:t,position:e};v.Trigger(i,"dblclick",o),t.preventDefault()}_(this,t);var c,u,d,y=e.canvas,v=e.EventStore,f=null;y.onmousedown=s,y.ontouchstart=o(s),y.onmousemove=r,y.ontouchmove=o(r),y.onmouseup=a,y.ontouchup=o(a),y.ondblclick=l,y.onmousewheel=h},L=function(t){function e(t){_(this,e);var i=k(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,{id:null,canvas:t}));i.scene=r,i._currScene.renderAfter=!0,i.scrollable=!0;var n=new a(i.ctx,{x:0,y:0,distance:1e3});return n._eventStore={mousedown:function(t,e){var i=!1;if("MOUSE"==t.controlMode?i=!e.event.ctrlKey:"DRAG"==t.controlMode&&(i=!!e.event.ctrlKey),i){null!=this.collisionBox&&t.scene.Remove(this.collisionBox.id);var n={x:e.position.x,y:e.position.y,width:1,height:1,collisionCheck:!1,order:1/0};n.lineColor="#800080",n.lineWidth=1,n.order=9,this.collisionBox=new l(n),t.scene.Add(this.collisionBox),this.ctrl=!0}},mouseover:function(t,e){t.focusOnCanvas=!0},mouseout:function(t,e){t.focusOnCanvas=!1},mousemove:function(t,e){!0===this.ctrl?this.collisionBox.max.add(e.offset):this.OffsetMoveTo(-e.cameraOffset.x,-e.cameraOffset.y)},mouseup:function(t,e){if(!0===this.ctrl){this.collisionBox._position.reconstruct();var i=t.scene.getItems();for(var n in i){var o=i[n];o.CollisionCheck(this.collisionBox._position)&&(!1===o.isSelected?o.Toggle():!1===o.isLineSelected&&o.Toggle())}this.ctrl=!1,t.scene.Remove(this.collisionBox.id)}},mousewheel:function(t,e){if(!1!==t.scrollable){e.delta>0?this.OffsetZoomTo(-100,e.position):this.OffsetZoomTo(100,e.position)}},click:function(t,e){!0===this.ctrl&&(this.ctrl=!1,t.scene.Remove(this.collisionBox.id)),null!=this.collisionBox&&t.scene.Remove(this.collisionBox.id),t.blur()}},i.scene.Add(n),i.control=new z(i),i.mode="EDIT",i.controlMode="DRAG",i}return g(e,t),x(e,[{key:"showAllAttachers",value:function(t){var e=this.scene.searchInstance(T);for(var i in e)e[i].showAllAttachers()}},{key:"hideAllAttachers",value:function(t){var e=this.scene.searchInstance(T);for(var i in e)e[i].hideAllAttachers()}},{key:"changeCollision",value:function(t){var e=this.scene.searchInstance(w);for(var i in e)e[i].ChangeTextCollision(t)}},{key:"changeObjectValue",value:function(t,e){var i=this.scene.searchItems({isSelected:!0});for(var n in i)i[n]}},{key:"searchObjectItem",value:function(t){return this.scene.searchItems(t)}},{key:"getLatestPosition",value:function(){return null==this.latestPoint?{x:this.scene.camera._viewport.min.x+10,y:this.scene.camera._viewport.min.y+10}:(this.scene.camera._viewport.containsPoint(this.latestPoint)||(this.latestPoint.x=this.scene.camera._viewport.min.x+10,this.latestPoint.y=this.latestPoint.y+50),{x:this.latestPoint.x,y:this.latestPoint.y})}},{key:"getCenterPosition",value:function(){return{x:this.scene.camera._position.x,y:this.scene.camera._position.y}}},{key:"addObject",value:function(t,e){var i=null,o={mode:this.mode,id:e.id,x:e.x,y:e.y,width:e.width,height:e.height,order:e.order,stage:this};if("IMAGE"==t){o.width=e.width||100,o.height=e.height||100,o.width<30&&(o.width=30),o.height<30&&(o.height=30),o.url=e.url,null!=e.lineColor&&(o.lineColor=e.lineColor),null!=e.lineType&&(o.lineType=e.lineType),null!=e.lineWidth&&(o.lineWidth=e.lineWidth);var s=new O(o);i=this.scene.Add(s)}else{o.width=e.width||160,o.height=e.height||100,"TEXT"==t&&(t=null),o.dataSource=t,o.text=e.text||"",o.url=e.url;var r=n.Load("textOptionsCallback");if("function"==typeof r&&(o=r(e.id,this,o)),null!=e.color&&(o.color=e.color),null!=e.bgColor&&(o.bgColor=e.bgColor),null!=e.textColor&&(o.textColor=e.textColor),null!=e.textAlign&&(o.textAlign=e.textAlign),null!=e.textVAlign&&(o.textVAlign=e.textVAlign),null!=e.font&&(o.font=e.font),null!=e.polygonType&&(o.polygonType=e.polygonType),null!=e.lineColor&&(o.lineColor=e.lineColor),null!=e.lineType&&(o.lineType=e.lineType),null!=e.lineWidth&&(o.lineWidth=e.lineWidth),"TEXT"==e.polygonType){var a=new A(o);i=this.scene.Add(a)}else{var h=new P(o);i=this.scene.Add(h)}}return this.latestPoint={x:o.x+o.width+15,y:e.y},i}},{key:"modifyObject",value:function(t,e,i){var n=this.scene.getItem(t);null!=n&&(this.setIcon(n,e),this.setText(n,i.text),this.setUrl(n,i.url))}},{key:"removeObject",value:function(t){this.scene.Remove(t)}},{key:"getSelectedAllObjects",value:function(){return this.scene.searchItems({isSelected:!0,isLineSelected:!0})}},{key:"getSelectedLineObjects",value:function(){return this.scene.searchItems({isLineSelected:!0})}},{key:"getAllLineObjects",value:function(){return this.scene.searchInstance(S)}},{key:"getSelectedObjects",value:function(){return this.scene.searchItems({isSelected:!0})}},{key:"getAllItemObjects",value:function(){return this.scene.searchInstance(T)}},{key:"bringToFront",value:function(){var t=this.scene.searchItems({isSelected:!0});for(var e in t){var i=t[e];this.scene.bringToFront(i)}this.scene.resetOrder()}},{key:"sendToBack",value:function(){var t=this.scene.searchItems({isSelected:!0});for(var e in t){var i=t[e];this.scene.sendToBack(i)}this.scene.resetOrder()}},{key:"alignObjects",value:function(t,e){for(var i={x:null,y:null},n={x:null,y:null},o={x:null,y:null},s=0;s<t.length;s++)null==i.x&&(i.x=t[s]._boundbox.min.x),null==i.y&&(i.y=t[s]._boundbox.min.y),null==n.x&&(n.x=t[s]._boundbox.max.x),null==n.y&&(n.y=t[s]._boundbox.max.y),i.x>t[s]._boundbox.min.x&&(i.x=t[s]._boundbox.min.x),i.y>t[s]._boundbox.min.y&&(i.y=t[s]._boundbox.min.y),n.x<t[s]._boundbox.max.x&&(n.x=t[s]._boundbox.max.x),n.y<t[s]._boundbox.max.y&&(n.y=t[s]._boundbox.max.y);o.x=i.x+(n.x-i.x)/2,o.y=i.y+(n.y-i.y)/2;for(s=0;s<t.length;s++){var r=t[s]._boundbox,a={x:0,y:0};"LEFT"==e?a.x=i.x-r.min.x:"RIGHT"==e?a.x=n.x-r.max.x:"TOP"==e?a.y=i.y-r.min.y:"BOTTOM"==e?a.y=n.y-r.max.y:"CENTER_H"==e?a.x=o.x-r.GetCenter().x:"CENTER_V"==e&&(a.y=o.y-r.GetCenter().y),r.Translate(a)}}},{key:"setTooltip",value:function(t,e){try{"string"==typeof t&&(t=this.scene.getItem(t)),t.ChangeTooltip(e)}catch(t){}}},{key:"setIcon",value:function(t,e){try{t.ChangeIcon(e)}catch(t){}}},{key:"setIconColor",value:function(t,e){try{t.ChangeIconColor(e)}catch(t){}}},{key:"setColor",value:function(t,e){try{t.ChangeColor(e)}catch(t){}}},{key:"setBgColor",value:function(t,e){try{t.ChangeBgColor(e)}catch(t){}}},{key:"setTextAlign",value:function(t,e){try{t.ChangeTextAlign(e)}catch(t){}}},{key:"setTextVAlign",value:function(t,e){try{t.ChangeTextVAlign(e)}catch(t){}}},{key:"setTextColor",value:function(t,e){try{t.ChangeTextColor(e)}catch(t){}}},{key:"setText",value:function(t,e){try{t.ChangeText(e)}catch(t){}}},{key:"setUrl",value:function(t,e){try{t.ChangeUrl(e)}catch(t){}}},{key:"setFont",value:function(t,e){try{t.ChangeFont(e)}catch(t){}}},{key:"setFontSize",value:function(t,e){try{t.ChangeFontSize(e)}catch(t){}}},{key:"setFontStyle",value:function(t,e){try{t.ChangeFontStyle(e)}catch(t){}}},{key:"setFontWeight",value:function(t,e){try{t.ChangeFontWeight(e)}catch(t){}}},{key:"setFontFace",value:function(t,e){try{t.ChangeFontFace(e)}catch(t){}}},{key:"changePolygonType",value:function(t,e){try{t.ChangePolygonType(e)}catch(t){}}},{key:"blur",value:function(){var t=this.getSelectedAllObjects();for(var e in t)t[e].Toggle(),t[e].hideAllAttachers();try{var i=n.Load("CanvasBlur");"function"==typeof i&&(options=i("",this,{}))}catch(t){}}},{key:"changeLineStyle",value:function(t,e){t.ChangeLineStyle(e)}},{key:"removeObjects",value:function(t){for(var e in t)this.scene.Remove(t[e].id)}},{key:"removeAll",value:function(){this.latestPoint=null,this.RemoveAll()}},{key:"zoomIn",value:function(t){this.scene.camera.OffsetZoomTo(-t)}},{key:"zoomOut",value:function(t){this.scene.camera.OffsetZoomTo(t)}},{key:"zoomToFit",value:function(){var t=this.getItemBoundSize();this.scene.camera.ZoomToFit(t.x+20,t.y+20);var e=this.getCenterOfAllItems();this.scene.camera.MoveTo(e.x,e.y)}},{key:"getCenterOfAllItems",value:function(){for(var t=this.scene.searchInstance(T),e={x:null,y:null},i={x:null,y:null},n={x:null,y:null},o=0;o<t.length;o++)null==e.x&&(e.x=t[o]._boundbox.min.x),null==e.y&&(e.y=t[o]._boundbox.min.y),null==i.x&&(i.x=t[o]._boundbox.max.x),null==i.y&&(i.y=t[o]._boundbox.max.y),e.x>t[o]._boundbox.min.x&&(e.x=t[o]._boundbox.min.x),e.y>t[o]._boundbox.min.y&&(e.y=t[o]._boundbox.min.y),i.x<t[o]._boundbox.max.x&&(i.x=t[o]._boundbox.max.x),i.y<t[o]._boundbox.max.y&&(i.y=t[o]._boundbox.max.y);return n.x=e.x+(i.x-e.x)/2,n.y=e.y+(i.y-e.y)/2,n}},{key:"getItemBoundSize",value:function(){for(var t=this.scene.searchInstance(T),e={x:null,y:null},i={x:null,y:null},n={x:null,y:null},o=0;o<t.length;o++)null==e.x&&(e.x=t[o]._boundbox.min.x),null==e.y&&(e.y=t[o]._boundbox.min.y),null==i.x&&(i.x=t[o]._boundbox.max.x),null==i.y&&(i.y=t[o]._boundbox.max.y),e.x>t[o]._boundbox.min.x&&(e.x=t[o]._boundbox.min.x),e.y>t[o]._boundbox.min.y&&(e.y=t[o]._boundbox.min.y),i.x<t[o]._boundbox.max.x&&(i.x=t[o]._boundbox.max.x),i.y<t[o]._boundbox.max.y&&(i.y=t[o]._boundbox.max.y);return n.x=i.x-e.x,n.y=i.y-e.y,n}},{key:"loadJson",value:function(t,e){if(null!=t&&null!=t.objects&&t.objects.length>0){for(var i in t.objects){var n=t.objects[i];if(null==n.x||null==n.y){var o=this.getLatestPosition();n.x=o.x,n.y=o.y}this.addObject(n.dataSource,n)}if(null!=t.links&&t.links.length>0)for(var s in t.links){var r=t.links[s],a=this.scene.getItem(r.source.id),h=this.scene.getItem(r.target.id);if(null!=a&&null!=h){var l=a["_"+r.source.direction+"Attacher"],c=h["_"+r.target.direction+"Attacher"];l.parentId=a.id,c.parentId=h.id,null!=l&&null!=c&&a._lineConnecting(this,l,c,r)}}null!=t.camera&&null!=t.camera.distance&&(isNaN(t.camera.x)&&(t.camera.x=0),isNaN(t.camera.y)&&(t.camera.y=0),this.scene.camera.MoveTo(t.camera.x,t.camera.y),this.scene.camera.ZoomTo(t.camera.distance)),null!=e&&e(this,t)}else console.log("Fail to Load : There are empty Data")}},{key:"SetScaleX",value:function(t){this.scene.camera.SetDistanceFromScale(t)}},{key:"getAllData",value:function(){var t=[],e=[],i=this.getAllItemObjects();for(var n in i)t.push(i[n].getSaveData());var o=this.getAllLineObjects();for(var s in o)e.push(o[s].getSaveData());var r=this.getCenterOfAllItems();return{objects:t,links:e,camera:{x:r.x,y:r.y,distance:this.scene.camera.distance,scaleX:this.scene.camera.GetScale().x}}}},{key:"chaptureImage",value:function(){return null}},{key:"Stop",value:function(){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Stop",this).call(this)}},{key:"Resize",value:function(t){m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"Resize",this).call(this,t);try{this.Update(),this.Render()}catch(t){}}}]),e}(o),R=function t(e,i){function n(t,e){var i={x:0,y:0};return i.x=t.x-e.x,i.y=t.y-e.y,i}function o(t){var i={x:t.clientX,y:t.clientY};if(null!==e.scene.camera){var n=e.canvas.getBoundingClientRect();i.x-=n.left,i.y-=n.top,i=e.scene.camera.ScreenToWorld(i.x,i.y)}return i}function s(t){return function(e){if(e.touches.length>0&&t(e.touches[0]))return e.preventDefault(),!1}}function r(t){var i=o(t);if(null==(f=x.FindItemOne(i))&&(f=e.scene.camera),null!=f){y=i,v=i;var n={event:t,position:i};x.Trigger(f,"mousedown",n)}t.preventDefault()}function a(t){var e=o(t),i=x.FindItemOne(e);if(null!=i?(null==m&&x.Trigger(i,"mouseover",{event:t,position:e}),null!=m&&m.id!=i.id&&(x.Trigger(m,"mouseout",{event:t,position:e}),x.Trigger(i,"mouseover",{event:t,position:e})),m=i,x.Trigger(i,"mouseovermove",{event:t,position:e})):null!=m&&(x.Trigger(m,"mouseout",{event:t,position:e}),m=null),null!=f){var s=n(e,y),r=n(e,v);v=e;var a={offset:r,cameraOffset:s,event:t,currentObject:i};x.Trigger(f,"mousemove",a)}t.preventDefault()}function h(t){var e=o(t),i={event:t,currentObject:x.FindItemOne(e),position:e};y&&v&&y.x==v.x&&y.y==v.y?x.Trigger(f,"click",i):x.Trigger(f,"mouseup",i),m=null,f=null,t.preventDefault()}function l(t){x.Trigger(e.scene.camera,"mouseover",{event:t}),t.preventDefault()}function c(t){x.Trigger(e.scene.camera,"mouseout",{event:t}),t.preventDefault()}function u(t){var i=o(t),n=0;t||(t=window.event),t.wheelDelta?n=t.wheelDelta/120:t.detail&&(n=-t.detail/3),x.Trigger(e.scene.camera,"mousewheel",{event:t,delta:n,position:i}),t.preventDefault()}function d(t){var e=o(t),i=x.FindItemOne(e,"dblclick"),n={event:t,position:e};x.Trigger(i,"dblclick",n),t.preventDefault()}_(this,t);var y,v,f,p=i||e.canvas,x=e.EventStore,m=null;p.onmousedown=r,p.ontouchstart=s(r),p.onmousemove=a,p.ontouchmove=s(a),p.onmouseup=h,p.ontouchup=s(h),p.ondblclick=d,p.onmousewheel=u,p.onmouseover=l,p.onmouseout=c};t.DataSource=n,t.init=e,Object.defineProperty(t,"__esModule",{value:!0})});
