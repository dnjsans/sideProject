!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.hetajs={})}(this,function(t){"use strict";for(var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=(function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}()),n=(function t(e,i,n){null===e&&(e=Function.prototype);var s=Object.getOwnPropertyDescriptor(e,i);if(void 0===s){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,i,n)}if("value"in s)return s.value;var r=s.get;if(void 0!==r)return r.call(n)}),s=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},o=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},r={},a={},h=[],u=0;u<256;u++)h[u]=(u<16?"0":"")+u.toString(16);var l=function(){function t(){e(this,t)}return i(t,null,[{key:"UUID",value:function(){var t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return h[255&t]+h[t>>8&255]+h[t>>16&255]+h[t>>24&255]+"-"+h[255&e]+h[e>>8&255]+"-"+h[e>>16&15|64]+h[e>>24&255]+"-"+h[63&i|128]+h[i>>8&255]+"-"+h[i>>16&255]+h[i>>24&255]+h[255&n]+h[n>>8&255]+h[n>>16&255]+h[n>>24&255]}},{key:"Add",value:function(t,e){e.loaded=!1;var i=e.type,n=e.target;if("IMAGE"==i){var s=new Image;s.onload=function(){r[t]=s,e.loaded=!0},s.src=n}else"OBJECT"==i?(r[t]=n,e.loaded=!0):"TEXT"==i?(r[t]=n,e.loaded=!0):"MESH"==i?(r[t]=n,e.loaded=!0):"SOUND"==i?(r[t]=n,e.loaded=!0):"CALLBACK"!=i&&"LINK"!=i||("function"!=typeof n&&console.log("Warning!!! LINK target must be Function"),r[t]=n,e.loaded=!0);a[t]=e}},{key:"Remove",value:function(t){delete r[t],delete a[t]}},{key:"Load",value:function(t){return null==a[t]?null:!0===a[t].loaded?r[t]:"IMAGE"==a[t].type?"":void 0}},{key:"EncodeImageToBase64",value:function(t){var e=document.createElement("canvas");e.width=t.naturalWidth,e.height=t.naturalHeight,e.getContext("2d").drawImage(t,0,0);try{return e.toDataURL("image/png")}catch(t){return console.log(t),""}}}]),t}(),c=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e(this,t),this.x=i,this.y=n}return i(t,[{key:"set",value:function(t,e){return this.x=t,this.y=e,this}},{key:"clone",value:function(){return new this.constructor(this.x,this.y)}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}},{key:"angle",value:function(){var t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t}},{key:"distanceTo",value:function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this}},{key:"multiplyScalar",value:function(t){return this.x*=t,this.y*=t,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"lenSq",value:function(){return this.x*this.x+this.y*this.y}},{key:"length",value:function(){return Math.sqrt(this.lenSq())}},{key:"snap",value:function(t){return{x:Math.round(this.x/t)*t,y:Math.round(this.y/t)*t}}},{key:"snapTo",value:function(t){var e=this.snap(t);this.x=e.x,this.y=e.y}}]),t}(),y=function(){function t(i){e(this,t),this.stage=i,this._eventStoreList={},this._unitsFromEvents={},this.history={mousedown:{x:null,y:null},mouseup:{x:null,y:null},click:{x:null,y:null}}}return i(t,[{key:"_addUnitsFromEvents",value:function(t,e){for(var i in t)null==this._unitsFromEvents[i]&&(this._unitsFromEvents[i]=[]),this._unitsFromEvents[i].push(e)}},{key:"_removeUnitsFromEvents",value:function(t,e){var i=this._eventStoreList[t];for(var n in i)if((null==e||e==n)&&null!=this._unitsFromEvents[n])for(var s=0;s<this._unitsFromEvents[n].length;++s)if(this._unitsFromEvents[n][s].id==t){this._unitsFromEvents[n].splice(s,1);break}}},{key:"Add",value:function(t,e,i){null!=i&&this._addUnitsFromEvents(e,t),null!=i&&(e.parentId=i),this._eventStoreList[t.id]=e}},{key:"Remove",value:function(t){this._removeUnitsFromEvents(t),delete this._eventStoreList[t]}},{key:"FindItems",value:function(t,e,i){return void 0===i?this._getCollisionObject(this.stage.scene.getUnitArrays(),new c(t.x,t.y),e):this._getEventOrientedCollision(new c(t.x,t.y),e,i)}},{key:"FindItemOne",value:function(t,e){var i=this.FindItems(new c(t.x,t.y),1,e);return i.length>0?i[0]:null}},{key:"Trigger",value:function(t,e,i){var n=!1;if(this.setHistory(e,i.position),null!=t){for(var s in this._eventStoreList)if(s==t.id){var o=this._eventStoreList[t.id],r=o[e];if(void 0==r)return;if(void 0!==o.parentId&&(t.parentId=o.parentId),r instanceof Array)for(var a in r)n=r[a].call(t,this.stage,i);else n=r.call(t,this.stage,i)}return null!=n&&n}}},{key:"getHistory",value:function(t){return this.history[t]}},{key:"setHistory",value:function(t,e){void 0!==this.history[t]&&(this.history[t].x=e.x,this.history[t].y=e.y)}},{key:"_getEventOrientedCollision",value:function(t,e,i){var n=[],s=this._unitsFromEvents[i];return null!=s&&(n=this._getCollisionObject(s,t,e)),n}},{key:"_getCollisionObject",value:function(t,e,i){for(var n=[],s=0,o=0;o<t.length;o++){var r=t[o];if(1!=r.hide&&(!0===r.CollisionCheck(e)&&(n.push(r),s++),null!=i&&i<=s))return n}return n}}]),t}(),v=function(){function t(i){e(this,t),this.stage=i,this.arrLen=20,this.list=[],this.index=-1}return i(t,[{key:"getHistory",value:function(t){var e=null==t?this.index:t;return this.list[e]}},{key:"setHistory",value:function(t,e){var i=null==t?this.index:t;this.list.splice(i,1,e)}},{key:"Add",value:function(t){this.index>=-1&&this.index+1<this.list.length&&this.list.splice(this.index+1),this.list.length>=this.arrLen&&(this.list.shift(),--this.index),null==t&&(t={oldData:[],newData:[],undo:function(t,e,i){},redo:function(t,e,i){}}),null==t.undo&&(t.undo=function(){}),null==t.redo&&(t.redo=function(){}),this.list.push({oldData:t.oldData,newData:t.newData,undo:t.undo,redo:t.redo}),++this.index}},{key:"Undo",value:function(){var t=this.list[this.index];null!=t&&(t.undo&&t.undo(this.stage,t.oldData,t.newData),--this.index)}},{key:"Redo",value:function(){if(this.list.length>this.index){var t=this.list[this.index+1];null!=t&&(t.redo&&t.redo(this.stage,t.oldData,t.newData),++this.index)}}}]),t}(),f=function(){function t(){e(this,t),this.activeFPS=!1,this.activeUpdateLoop=!1,this.activeRenderLoop=!1,this.useUpdateLoop=!0,this.useRenderLoop=!0,this.fps=40}return i(t,[{key:"useUpdate",value:function(t){this.useUpdateLoop=t}},{key:"useRender",value:function(t){this.useRenderLoop=t}},{key:"Start",value:function(){var t=this;if(this.activeFPS=!0,this.Resume(),this.lastUpdate=Date.now(),this.d=0,!0===this.useUpdateLoop&&(this._Updateloop=setInterval(function(){t._UpdateLoop()},this.fps)),!0===this.useRenderLoop){!function e(){requestAnimationFrame(e),t.activeFPS&&t._RenderLoop()}()}}},{key:"Resume",value:function(){!0===this.useUpdateLoop&&(this.activeUpdateLoop=!0),!0===this.useRenderLoop&&(this.activeRenderLoop=!0)}},{key:"Pause",value:function(){!0===this.useUpdateLoop&&(this.activeUpdateLoop=!1),!0===this.useRenderLoop&&(this.activeRenderLoop=!1)}},{key:"Stop",value:function(){this.activeFPS=!1,!0===this.useUpdateLoop&&clearInterval(this._Updateloop)}},{key:"_UpdateLoop",value:function(){if(this.activeUpdateLoop){var t=Date.now(),e=(t-this.lastUpdate)/this.fps;this.Update(this.d,e),this.lastUpdate=t,this.d+=e}}},{key:"_RenderLoop",value:function(){this.activeRenderLoop&&this.Render()}},{key:"Update",value:function(){}},{key:"Render",value:function(){}}]),t}(),d=function(){function t(i,n){var s=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"/";e(this,t),this.stage=i,this.socketStore={},this._socketList={},n.of(o).on("connection",function(t,e){t.id=Math.random().toString(36).slice(2),s._socketList[t.id]=t,s._ConnectSocket(t),t.on("disconnect",function(){s._DisConnectSocket(t)})})}return i(t,[{key:"_ConnectSocket",value:function(t){var e=this;this.socketStore._connect&&this.socketStore._connect.call(this.stage,t);for(var i in this.socketStore)!function(i){0!=i.indexOf("_")&&t.on(i,function(n){e.socketStore[i].call(e.stage,n,t)})}(i);return!0}},{key:"_DisConnectSocket",value:function(t){delete this._socketList[t.id],this.socketStore._disconnect&&this.socketStore._disconnect.call(this.stage,t)}},{key:"Add",value:function(t){this.socketStore=t}},{key:"EmitAllSockets",value:function(t,e){for(var i in this._socketList)this._socketList[i].emit(t,e)}},{key:"getSocket",value:function(t){return this._socketList[t]}},{key:"Update",value:function(t,e,i){for(var n in this._socketList){var s=this._socketList[n];t.length>0&&s.emit("_init",t),e.length>0&&s.emit("_update",e),i.length>0&&s.emit("_remove",i)}}}]),t}(),_=function(t){function n(t,i,s){var r=t.id;e(this,n);var a=o(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return a.useRender(!1),a.sceneList={},a.id=r,a.SocketStore=new d(a,i,s),a.initPack=[],a.updatePack=[],a.removePack=[],a.initLockedList=[],a.updateLockedList=[],a.removeLockedList=[],a.locked=!1,a}return s(n,t),i(n,[{key:"getSceneItemPacks",value:function(t){var e=this.sceneList[t],i=[];if(e){var n=e.getItemArrays(),s=!0,o=!1,r=void 0;try{for(var a,h=n[Symbol.iterator]();!(s=(a=h.next()).done);s=!0){var u=a.value;i.push(u.getPack())}}catch(t){o=!0,r=t}finally{try{!s&&h.return&&h.return()}finally{if(o)throw r}}}return i}},{key:"setInitPack",value:function(t){null!=t&&(!0===this.locked?this.initLockedList.push(t):this.initPack.push(t))}},{key:"setUpdatePack",value:function(t){null!=t&&(!0===this.locked?this.updateLockedList.push(t):this.updatePack.push(t))}},{key:"setRemovePack",value:function(t){null!=t&&(!0===this.locked?this.removeLockedList.push(t):this.removePack.push(t))}},{key:"lockPack",value:function(){this.initLockedList=[],this.updateLockedList=[],this.removeLockedList=[],this.locked=!0}},{key:"unLockPack",value:function(){this.initPack=[],this.updatePack=[],this.removePack=[];for(var t in this.initLockedList)this.initPack.push(this.initLockedList[t]);for(var e in this.updateLockedList)this.updatePack.push(this.updateLockedList[e]);for(var i in this.removeLockedList)this.removePack.push(this.removeLockedList[i]);this.locked=!1}},{key:"Update",value:function(t,e){this.lockPack(),this.SocketStore&&this.SocketStore.Update(this.initPack,this.updatePack,this.removePack),this.unLockPack()}}]),n}(f),p={basic:{uniform:[],vs:"attribute vec2 a_position;\r\nattribute vec2 a_texCoord;\r\n\r\nvarying vec2 v_texCoord;\r\nvoid main(){\r\n\tgl_Position = vec4(a_position, 1.0, 1.0);\r\n\tv_texCoord = a_texCoord;\r\n}\r\n",fs:"precision mediump float;\r\nuniform sampler2D u_image;\r\nvarying vec2 v_texCoord;\r\n\r\nvoid main(){\r\n\tgl_FragColor = texture2D(u_image, v_texCoord);\r\n}\r\n"}},m=function(){function t(i){e(this,t),this.gl=i,this.getProgram()}return i(t,[{key:"getProgram",value:function(){var t=this.gl,e=this._getShader(p.basic.vs,"VERTEX"),i=this._getShader(p.basic.fs,"FRAGMENT");if(e&&i){if(this.program=t.createProgram(),t.attachShader(this.program,e),t.attachShader(this.program,i),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))return console.log("Error Linking PROGRAM :"+t.getProgramInfoLog(this.program)),null;if(t.validateProgram(this.program),!t.getProgramParameter(this.program,t.VALIDATE_STATUS))return console.log("Error Validating PROGRAM :"+t.getProgramInfoLog(this.program)),null;t.detachShader(this.program,e),t.detachShader(this.program,i),t.deleteShader(e),t.deleteShader(i),t.useProgram(null)}}},{key:"_getShader",value:function(t,e){var i=this.gl,n=i.VERTEX_SHADER;"FRAGMENT"===e&&(n=i.FRAGMENT_SHADER);var s=i.createShader(n);return i.shaderSource(s,t),i.compileShader(s),i.getShaderParameter(s,i.COMPILE_STATUS)?s:(console.log("Error "+e+" Shader :"+i.getShaderInfoLog(s)),null)}}]),t}(),x=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e(this,t),this.isVec3=!0,this.x=i,this.y=n,this.z=s}return i(t,[{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"clamp",value:function(t,e){return this.x=Math.min(e.x,Math.max(t.x,this.x)),this.y=Math.min(e.y,Math.max(t.y,this.y)),this.z=Math.min(e.z,Math.max(t.z,this.z)),this}},{key:"angleTo",value:function(t){var e=this.x*this.x+this.y*this.y+this.z*this.z,i=t.x*t.x+t.y*t.y+t.z*t.z,n=this.dot(t)/Math.sqrt(e*i);return Math.acos(Math.min(1,Math.max(-1,n)))}},{key:"distanceTo",value:function(t){var e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return Math.sqrt(e*e+i*i+n*n)}},{key:"dot",value:function(t){return t.x*this.x+t.y*this.y+t.z*this.z}},{key:"cross",value:function(t){var e=this.x,i=this.y,n=this.z;return this.x=i*t.z-n*t.y,this.y=n*t.x-e*t.z,this.z=e*t.y-i*t.x,this}},{key:"crossVec",value:function(t,e){var i=t.x,n=t.y,s=t.z;return this.x=n*e.z-s*e.y,this.y=s*e.x-i*e.z,this.z=i*e.y-n*e.x,this}},{key:"set",value:function(t,e,i){return this.x=t,this.y=e,this.z=i,this}},{key:"setScalar",value:function(t){return this.x=t,this.y=t,this.z=t,this}},{key:"setX",value:function(t){return this.x=t,this}},{key:"setY",value:function(t){return this.y=t,this}},{key:"setZ",value:function(t){return this.z=t,this}},{key:"setComponent",value:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}},{key:"getComponent",value:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}},{key:"add",value:function(t,e){return void 0!==e?this.addVectors(t,e):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}},{key:"sub",value:function(t,e){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}},{key:"multiply",value:function(t,e){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return this.x*=t,this.y*=t,this.z*=t,this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}},{key:"applyMatrix3",value:function(t){var e=this.x,i=this.y,n=this.z,s=t.ele;return this.x=s[0]*e+s[3]*i+s[6]*n,this.y=s[1]*e+s[4]*i+s[7]*n,this.z=s[2]*e+s[5]*i+s[8]*n,this}},{key:"applyMatrix4",value:function(t){var e=this.x,i=this.y,n=this.z,s=t.ele,o=1/(s[3]*e+s[7]*i+s[11]*n+s[15]);return this.x=(s[0]*e+s[4]*i+s[8]*n+s[12])*o,this.y=(s[1]*e+s[5]*i+s[9]*n+s[13])*o,this.z=(s[2]*e+s[6]*i+s[10]*n+s[14])*o,this}},{key:"applyQuaternion",value:function(t){var e=this.x,i=this.y,n=this.z,s=t.x,o=t.y,r=t.z,a=t.w,h=a*e+o*n-r*i,u=a*i+r*e-s*n,l=a*n+s*i-o*e,c=-s*e-o*i-r*n;return this.x=h*a+c*-s+u*-r-l*-o,this.y=u*a+c*-o+l*-s-h*-r,this.z=l*a+c*-r+h*-o-u*-s,this}},{key:"transformDirection",value:function(t){var e=this.x,i=this.y,n=this.z,s=t.ele;return this.x=s[0]*e+s[4]*i+s[8]*n,this.y=s[1]*e+s[5]*i+s[9]*n,this.z=s[2]*e+s[6]*i+s[10]*n,this.normalize()}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clampScalar",value:function(e,i){return this.clamp(new t(e,e,e),new t(i,i,i))}},{key:"clampLength",value:function(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}},{key:"floor",value:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}},{key:"ceil",value:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}},{key:"round",value:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}},{key:"roundToZero",value:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"manhattanLength",value:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}},{key:"normalize",value:function(){return this.divideScalar(this.length()||1)}},{key:"setLength",value:function(t){return this.normalize().multiplyScalar(t)}},{key:"lerp",value:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}},{key:"lerpVectors",value:function(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t)}},{key:"projectOnVector",value:function(t){var e=t.dot(this)/t.lengthSq();return this.copy(t).multiplyScalar(e)}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}},{key:"manhattanDistanceTo",value:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}},{key:"setFromSpherical",value:function(t){var e=Math.sin(t.phi)*t.radius;return this.x=e*Math.sin(t.theta),this.y=Math.cos(t.phi)*t.radius,this.z=e*Math.cos(t.theta),this}},{key:"setFromCylindrical",value:function(t){return this.x=t.radius*Math.sin(t.theta),this.y=t.y,this.z=t.radius*Math.cos(t.theta),this}},{key:"setFromMatrixPosition",value:function(t){var e=t.ele;return this.x=e[12],this.y=e[13],this.z=e[14],this}},{key:"setFromMatrixScale",value:function(t){var e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}},{key:"setFromMatrixColumn",value:function(t,e){return this.fromArray(t.ele,4*e)}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}},{key:"fromBufferAttribute",value:function(t,e,i){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}}]),t}(),k=function(){function t(){e(this,t),this.isMat4=!0,this.ele=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.lookVecX=new x,this.lookVecY=new x,this.lookVecZ=new x,this.vecApplyBuff=new x,this.extractRotVec=new x}return i(t,[{key:"set",value:function(t,e,i,n,s,o,r,a,h,u,l,c,y,v,f,d){var _=this.ele;return _[0]=t,_[4]=e,_[8]=i,_[12]=n,_[1]=s,_[5]=o,_[9]=r,_[13]=a,_[2]=h,_[6]=u,_[10]=l,_[14]=c,_[3]=y,_[7]=v,_[11]=f,_[15]=d,this}},{key:"identity",value:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}},{key:"clone",value:function(){return(new t).fromArray(this.ele)}},{key:"copy",value:function(t){var e=this.ele,i=t.ele;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}},{key:"copyPosition",value:function(t){var e=this.ele,i=t.ele;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}},{key:"extractBasis",value:function(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}},{key:"makeBasis",value:function(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}},{key:"extractRotation",value:function(t){var e=this.extractRotVec,i=this.ele,n=t.ele,s=1/e.setFromMatrixColumn(t,0).length(),o=1/e.setFromMatrixColumn(t,1).length(),r=1/e.setFromMatrixColumn(t,2).length();return i[0]=n[0]*s,i[1]=n[1]*s,i[2]=n[2]*s,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[8]=n[8]*r,i[9]=n[9]*r,i[10]=n[10]*r,this}},{key:"makeRotationFromEuler",value:function(t){var e=this.ele,i=t.x,n=t.y,s=t.z,o=Math.cos(i),r=Math.sin(i),a=Math.cos(n),h=Math.sin(n),u=Math.cos(s),l=Math.sin(s);if("XYZ"===t.order){var c=o*u,y=o*l,v=r*u,f=r*l;e[0]=a*u,e[4]=-a*l,e[8]=h,e[1]=y+v*h,e[5]=c-f*h,e[9]=-r*a,e[2]=f-c*h,e[6]=v+y*h,e[10]=o*a}else if("YXZ"===t.order){var d=a*u,_=a*l,p=h*u,m=h*l;e[0]=d+m*r,e[4]=p*r-_,e[8]=o*h,e[1]=o*l,e[5]=o*u,e[9]=-r,e[2]=_*r-p,e[6]=m+d*r,e[10]=o*a}else if("ZXY"===t.order){var d=a*u,_=a*l,p=h*u,m=h*l;e[0]=d-m*r,e[4]=-o*l,e[8]=p+_*r,e[1]=_+p*r,e[5]=o*u,e[9]=m-d*r,e[2]=-o*h,e[6]=r,e[10]=o*a}else if("ZYX"===t.order){var c=o*u,y=o*l,v=r*u,f=r*l;e[0]=a*u,e[4]=v*h-y,e[8]=c*h+f,e[1]=a*l,e[5]=f*h+c,e[9]=y*h-v,e[2]=-h,e[6]=r*a,e[10]=o*a}else if("YZX"===t.order){var x=o*a,k=o*h,g=r*a,S=r*h;e[0]=a*u,e[4]=S-x*l,e[8]=g*l+k,e[1]=l,e[5]=o*u,e[9]=-r*u,e[2]=-h*u,e[6]=k*l+g,e[10]=x-S*l}else if("XZY"===t.order){var x=o*a,k=o*h,g=r*a,S=r*h;e[0]=a*u,e[4]=-l,e[8]=h*u,e[1]=x*l+S,e[5]=o*u,e[9]=k*l-g,e[2]=g*l-k,e[6]=r*u,e[10]=S*l+x}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}},{key:"makeRotationFromQuaternion",value:function(t){var e=this.ele,i=t._x,n=t._y,s=t._z,o=t._w,r=i+i,a=n+n,h=s+s,u=i*r,l=i*a,c=i*h,y=n*a,v=n*h,f=s*h,d=o*r,_=o*a,p=o*h;return e[0]=1-(y+f),e[4]=l-p,e[8]=c+_,e[1]=l+p,e[5]=1-(u+f),e[9]=v-d,e[2]=c-_,e[6]=v+d,e[10]=1-(u+y),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}},{key:"lookAt",value:function(t,e,i){var n=this.ele,s=this.lookVecX,o=this.lookVecY,r=this.lookVecZ;return r.subVectors(t,e),0===r.lengthSq()&&(r.z=1),r.normalize(),s.crossVectors(i,r),0===s.lengthSq()&&(1===Math.abs(i.z)?r.x+=1e-4:r.z+=1e-4,r.normalize(),s.crossVectors(i,r)),s.normalize(),o.crossVectors(r,s),n[0]=s.x,n[4]=o.x,n[8]=r.x,n[1]=s.y,n[5]=o.y,n[9]=r.y,n[2]=s.z,n[6]=o.z,n[10]=r.z,this}},{key:"multiply",value:function(t,e){return null!=e?this.multiplyMatrices(t,e):this.multiplyMatrices(this,t)}},{key:"premultiply",value:function(t){return this.multiplyMatrices(t,this)}},{key:"multiplyMatrices",value:function(t,e){var i=t.ele,n=e.ele,s=this.ele,o=i[0],r=i[4],a=i[8],h=i[12],u=i[1],l=i[5],c=i[9],y=i[13],v=i[2],f=i[6],d=i[10],_=i[14],p=i[3],m=i[7],x=i[11],k=i[15],g=n[0],S=n[4],w=n[8],z=n[12],P=n[1],T=n[5],M=n[9],R=n[13],C=n[2],b=n[6],O=n[10],I=n[14],L=n[3],A=n[7],U=n[11],F=n[15];return s[0]=o*g+r*P+a*C+h*L,s[4]=o*S+r*T+a*b+h*A,s[8]=o*w+r*M+a*O+h*U,s[12]=o*z+r*R+a*I+h*F,s[1]=u*g+l*P+c*C+y*L,s[5]=u*S+l*T+c*b+y*A,s[9]=u*w+l*M+c*O+y*U,s[13]=u*z+l*R+c*I+y*F,s[2]=v*g+f*P+d*C+_*L,s[6]=v*S+f*T+d*b+_*A,s[10]=v*w+f*M+d*O+_*U,s[14]=v*z+f*R+d*I+_*F,s[3]=p*g+m*P+x*C+k*L,s[7]=p*S+m*T+x*b+k*A,s[11]=p*w+m*M+x*O+k*U,s[15]=p*z+m*R+x*I+k*F,this}},{key:"multiplyScalar",value:function(t){var e=this.ele;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}},{key:"applyToBufferAttribute",value:function(t){for(var e=this.vecApplyBuff,i=0,n=t.count;i<n;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix4(this),t.setXYZ(i,e.x,e.y,e.z);return t}},{key:"determinant",value:function(){var t=this.ele,e=t[0],i=t[4],n=t[8],s=t[12],o=t[1],r=t[5],a=t[9],h=t[13],u=t[2],l=t[6],c=t[10],y=t[14];return t[3]*(+s*a*l-n*h*l-s*r*c+i*h*c+n*r*y-i*a*y)+t[7]*(+e*a*y-e*h*c+s*o*c-n*o*y+n*h*u-s*a*u)+t[11]*(+e*h*l-e*r*y-s*o*l+i*o*y+s*r*u-i*h*u)+t[15]*(-n*r*u-e*a*l+e*r*c+n*o*l-i*o*c+i*a*u)}},{key:"transpose",value:function(){var t,e=this.ele;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}},{key:"setPosition",value:function(t){var e=this.ele;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this}},{key:"getInverse",value:function(t,e){var i=this.ele,n=t.ele,s=n[0],o=n[1],r=n[2],a=n[3],h=n[4],u=n[5],l=n[6],c=n[7],y=n[8],v=n[9],f=n[10],d=n[11],_=n[12],p=n[13],m=n[14],x=n[15],k=v*m*c-p*f*c+p*l*d-u*m*d-v*l*x+u*f*x,g=_*f*c-y*m*c-_*l*d+h*m*d+y*l*x-h*f*x,S=y*p*c-_*v*c+_*u*d-h*p*d-y*u*x+h*v*x,w=_*v*l-y*p*l-_*u*f+h*p*f+y*u*m-h*v*m,z=s*k+o*g+r*S+a*w;if(0===z){var P="Matrix4 .getInverse() can't invert matrix, determinant is 0";if(!0===e)throw new Error(P);return console.warn(P),this.identity()}var T=1/z;return i[0]=k*T,i[1]=(p*f*a-v*m*a-p*r*d+o*m*d+v*r*x-o*f*x)*T,i[2]=(u*m*a-p*l*a+p*r*c-o*m*c-u*r*x+o*l*x)*T,i[3]=(v*l*a-u*f*a-v*r*c+o*f*c+u*r*d-o*l*d)*T,i[4]=g*T,i[5]=(y*m*a-_*f*a+_*r*d-s*m*d-y*r*x+s*f*x)*T,i[6]=(_*l*a-h*m*a-_*r*c+s*m*c+h*r*x-s*l*x)*T,i[7]=(h*f*a-y*l*a+y*r*c-s*f*c-h*r*d+s*l*d)*T,i[8]=S*T,i[9]=(_*v*a-y*p*a-_*o*d+s*p*d+y*o*x-s*v*x)*T,i[10]=(h*p*a-_*u*a+_*o*c-s*p*c-h*o*x+s*u*x)*T,i[11]=(y*u*a-h*v*a-y*o*c+s*v*c+h*o*d-s*u*d)*T,i[12]=w*T,i[13]=(y*p*r-_*v*r+_*o*f-s*p*f-y*o*m+s*v*m)*T,i[14]=(_*u*r-h*p*r-_*o*l+s*p*l+h*o*m-s*u*m)*T,i[15]=(h*v*r-y*u*r+y*o*l-s*v*l-h*o*f+s*u*f)*T,this}},{key:"scale",value:function(t){var e=this.ele,i=t.x,n=t.y,s=t.z;return e[0]*=i,e[4]*=n,e[8]*=s,e[1]*=i,e[5]*=n,e[9]*=s,e[2]*=i,e[6]*=n,e[10]*=s,e[3]*=i,e[7]*=n,e[11]*=s,this}},{key:"getMaxScaleOnAxis",value:function(){var t=this.ele,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,n))}},{key:"makeTranslation",value:function(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}},{key:"makeRotationX",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}},{key:"makeRotationY",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}},{key:"makeRotationZ",value:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}},{key:"makeRotationAxis",value:function(t,e){var i=Math.cos(e),n=Math.sin(e),s=1-i,o=t.x,r=t.y,a=t.z,h=s*o,u=s*r;return this.set(h*o+i,h*r-n*a,h*a+n*r,0,h*r+n*a,u*r+i,u*a-n*o,0,h*a-n*r,u*a+n*o,s*a*a+i,0,0,0,0,1),this}},{key:"makeScale",value:function(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}},{key:"makeShear",value:function(t,e,i){return this.set(1,e,i,0,t,1,i,0,t,e,1,0,0,0,0,1),this}},{key:"compose",value:function(t,e,i){return this.makeRotationFromQuaternion(e),this.scale(i),this.setPosition(t),this}},{key:"makePerspective",value:function(t,e,i,n,s,o){var r=this.ele,a=2*s/(e-t),h=2*s/(i-n),u=(e+t)/(e-t),l=(i+n)/(i-n),c=-(o+s)/(o-s),y=-2*o*s/(o-s);return r[0]=a,r[4]=0,r[8]=u,r[12]=0,r[1]=0,r[5]=h,r[9]=l,r[13]=0,r[2]=0,r[6]=0,r[10]=c,r[14]=y,r[3]=0,r[7]=0,r[11]=-1,r[15]=0,this}},{key:"makeOrthographic",value:function(t,e,i,n,s,o){var r=this.ele,a=1/(e-t),h=1/(i-n),u=1/(o-s),l=(e+t)*a,c=(i+n)*h,y=(o+s)*u;return r[0]=2*a,r[4]=0,r[8]=0,r[12]=-l,r[1]=0,r[5]=2*h,r[9]=0,r[13]=-c,r[2]=0,r[6]=0,r[10]=-2*u,r[14]=-y,r[3]=0,r[7]=0,r[11]=0,r[15]=1,this}},{key:"equals",value:function(t){for(var e=this.ele,i=t.ele,n=0;n<16;n++)if(e[n]!==i[n])return!1;return!0}},{key:"fromArray",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<16;i++)this.ele[i]=t[i+e];return this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this.ele;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}]),t}(),g=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e(this,t),this._x=i,this._y=n,this._z=s,this._w=o,this.UnitVec3=new x,this.EPS=1e-6}return i(t,[{key:"clone",value:function(){return new this.constructor(this._x,this._y,this._z,this._w)}},{key:"set",value:function(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this.onChangeCallback(),this}},{key:"copy",value:function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this.onChangeCallback(),this}},{key:"inverse",value:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this}},{key:"dot",value:function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}},{key:"slerp",value:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this._x,n=this._y,s=this._z,o=this._w,r=o*t._w+i*t._x+n*t._y+s*t._z;if(r<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,r=-r):this.copy(t),r>=1)return this._w=o,this._x=i,this._y=n,this._z=s,this;var a=Math.sqrt(1-r*r);if(Math.abs(a)<.001)return this._w=.5*(o+this._w),this._x=.5*(i+this._x),this._y=.5*(n+this._y),this._z=.5*(s+this._z),this;var h=Math.atan2(a,r),u=Math.sin((1-e)*h)/a,l=Math.sin(e*h)/a;return this._w=o*u+this._w*l,this._x=i*u+this._x*l,this._y=n*u+this._y*l,this._z=s*u+this._z*l,this.onChangeCallback(),this}},{key:"setFromEuler",value:function(t,e){var i=t._x,n=t._y,s=t._z,o=t.order,r=Math.cos,a=Math.sin,h=r(i/2),u=r(n/2),l=r(s/2),c=a(i/2),y=a(n/2),v=a(s/2);return"XYZ"===o?(this._x=c*u*l+h*y*v,this._y=h*y*l-c*u*v,this._z=h*u*v+c*y*l,this._w=h*u*l-c*y*v):"YXZ"===o?(this._x=c*u*l+h*y*v,this._y=h*y*l-c*u*v,this._z=h*u*v-c*y*l,this._w=h*u*l+c*y*v):"ZXY"===o?(this._x=c*u*l-h*y*v,this._y=h*y*l+c*u*v,this._z=h*u*v+c*y*l,this._w=h*u*l-c*y*v):"ZYX"===o?(this._x=c*u*l-h*y*v,this._y=h*y*l+c*u*v,this._z=h*u*v-c*y*l,this._w=h*u*l+c*y*v):"YZX"===o?(this._x=c*u*l+h*y*v,this._y=h*y*l+c*u*v,this._z=h*u*v-c*y*l,this._w=h*u*l-c*y*v):"XZY"===o&&(this._x=c*u*l-h*y*v,this._y=h*y*l-c*u*v,this._z=h*u*v+c*y*l,this._w=h*u*l+c*y*v),!1!==e&&this.onChangeCallback(),this}},{key:"setFromAxisAngle",value:function(t,e){var i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this.onChangeCallback(),this}},{key:"setFromRotationMatrix",value:function(t){var e,i=t.elements,n=i[0],s=i[4],o=i[8],r=i[1],a=i[5],h=i[9],u=i[2],l=i[6],c=i[10],y=n+a+c;return y>0?(e=.5/Math.sqrt(y+1),this._w=.25/e,this._x=(l-h)*e,this._y=(o-u)*e,this._z=(r-s)*e):n>a&&n>c?(e=2*Math.sqrt(1+n-a-c),this._w=(l-h)/e,this._x=.25*e,this._y=(s+r)/e,this._z=(o+u)/e):a>c?(e=2*Math.sqrt(1+a-n-c),this._w=(o-u)/e,this._x=(s+r)/e,this._y=.25*e,this._z=(h+l)/e):(e=2*Math.sqrt(1+c-n-a),this._w=(r-s)/e,this._x=(o+u)/e,this._y=(h+l)/e,this._z=.25*e),this.onChangeCallback(),this}},{key:"setFromUnitVectors",value:function(t,e){var i=this.UnitVec3;return this.r=t.dot(e)+1,this.r<this.EPS?(this.r=0,Math.abs(t.x)>Math.abs(t.z)?i.set(-t.y,t.x,0):i.set(0,-t.z,t.y)):i.crossVectors(t,e),this._x=i.x,this._y=i.y,this._z=i.z,this._w=this.r,this.normalize()}},{key:"lengthSq",value:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}},{key:"length",value:function(){return Math.sqrt(this.lengthSq())}},{key:"normalize",value:function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this.onChangeCallback(),this}},{key:"multiply",value:function(t,e){return void 0!==e?this.multiplyQuaternions(t,e):this.multiplyQuaternions(this,t)}},{key:"premultiply",value:function(t){return this.multiplyQuaternions(t,this)}},{key:"multiplyQuaternions",value:function(t,e){var i=t._x,n=t._y,s=t._z,o=t._w,r=e._x,a=e._y,h=e._z,u=e._w;return this._x=i*u+o*r+n*h-s*a,this._y=n*u+o*a+s*r-i*h,this._z=s*u+o*h+i*a-n*r,this._w=o*u-i*r-n*a-s*h,this.onChangeCallback(),this}},{key:"equals",value:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this.onChangeCallback(),this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}},{key:"onChange",value:function(t){return this.onChangeCallback=t,this}},{key:"onChangeCallback",value:function(){}}]),t}(),S=function(){function t(){e(this,t),this.type="Camera",this.isCamera=!0,this.matrixWorldInverse=new k,this.projectionMatrix=new k,this.quat=new g}return i(t,[{key:"copy",value:function(e,i){return n(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"copy",this).call(this,this,e,i),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"getWorldDirection",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new x,e=this.quat;return this.getWorldQuaternion(e),t.set(0,0,-1).applyQuaternion(e)}},{key:"updateMatrixWorld",value:function(e){n(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateMatrixWorld",this).call(this,e),this.matrixWorldInverse.getInverse(this.matrixWorld)}}]),t}(),w=function(){function t(i){e(this,t),this.gl=i}return i(t,[{key:"Remove",value:function(t){}},{key:"Add",value:function(t){t instanceof S&&console.log("camera")}},{key:"Start",value:function(){}},{key:"Update",value:function(){}},{key:"Render",value:function(){}},{key:"Stop",value:function(){}},{key:"Resize",value:function(t){}}]),t}(),z=function(t){function r(t){var i=t.id,n=t.canvas,s=void 0===n?null:n;e(this,r);var a=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return a._currScene=null,a.id=i,a.ctx=a._WebGLContext(s),a}return s(r,t),i(r,[{key:"_WebGLContext",value:function(t){this.canvas=t;var e=null;if(null==this.canvas)return console.log("No canvas"),null;for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],n=0;n<i.length;++n){try{e=this.canvas.getContext(i[n])}catch(t){}if(e)break}return null==e?(console.log("WebGL Initializing Fail"),null):e}},{key:"Start",value:function(){if(null==this._currScene)return void console.log("Scene is Empty!");n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Start",this).call(this),this._currScene.Start()}},{key:"Update",value:function(){this._currScene.Update()}},{key:"Render",value:function(){this._currScene.Render()}},{key:"Stop",value:function(){this._currScene.Stop(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Stop",this).call(this)}},{key:"Resize",value:function(t){this._currScene.Resize(t)}},{key:"scene",get:function(){return this._currScene},set:function(t){this.Pause(),null==t?null!=this._currScene&&this._currScene.Stop():this._currScene=new t(this.ctx),this.Resume()}}]),r}(f),P=function(){function t(i,n){e(this,t),this.stage=i,this.socket=n}return i(t,[{key:"Add",value:function(t){var e=this;for(var i in t)!function(i){e.socket.on(i,function(n){t[i].call(e.stage,n,e.socket)})}(i)}},{key:"Trigger",value:function(t,e){this.socket.emit(t,e)}},{key:"Destroy",value:function(){this.socket.close()}}]),t}(),T=function(){function t(i,n){e(this,t),this.stage=i,this.socketStore={},this.id=Math.random().toString(36).slice(2),this.Add(n),this.stage.initPack=[],this.stage.updatePack=[],this.stage.removePack=[]}return i(t,[{key:"Add",value:function(t){for(var e in t)this.socketStore[e]=t[e]}},{key:"Trigger",value:function(t,e){var i=this,n={id:this.id,emit:function(t,e){i.socketStore[t].call(i.stage,e,null)}};this.socketStore[t].call(this.stage,e,n)}},{key:"Destroy",value:function(){}},{key:"ConnectSocket",value:function(){var t=this,e={id:this.id,emit:function(e,i){t.socketStore[e].call(t.stage,i,null)}};this.socketStore._connect&&this.socketStore._connect.call(this.stage,e)}},{key:"EmitAllSockets",value:function(t,e){var i=this,n={id:this.id,emit:function(t,e){i.socketStore[t].call(i.stage,e,null)}};this.socketStore[t].call(this.stage,e,n)}},{key:"Update",value:function(t,e){var i=this,n={id:this.id,emit:function(t,e){i.socketStore[t].call(i.stage,e,null)}},s=this.stage.scene,o=s.getItems();for(var r in o){var a=o[r].Update(t,e,s);null!=a&&this.stage.updatePack.push(a)}this.stage.initPack.length>0&&this.socketStore._init.call(this.stage,this.stage.initPack,n),this.stage.updatePack.length>0&&this.socketStore._update.call(this.stage,this.stage.updatePack,n),this.stage.removePack.length>0&&this.socketStore._remove.call(this.stage,this.stage.removePack,n),this.stage.initPack=[],this.stage.updatePack=[],this.stage.removePack=[]}}]),t}(),M=function(t){function r(t,i){var n=t.id,s=t.canvas,a=void 0===s?null:s;e(this,r);var h=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return h.id=n||"S"+Math.random().toString(36).slice(2),h._currScene=null,h.ctx=h._GetContext(a),h.Resize(),h.EventStore=new y(h),void 0!==i&&void 0!==i.io?(h.SocketStore=new P(h,i),h.useUpdate(!1)):h.SocketStore=new T(h,i),h}return s(r,t),i(r,[{key:"_GetContext",value:function(t){this.canvas=t;var e=null;if(null==this.canvas)return console.log("No canvas"),null;try{e=this.canvas.getContext("2d")}catch(t){}return null==e?(console.log("Canvas Initializing Fail"),null):e}},{key:"Start",value:function(){if(null==this._currScene)return void console.log("Scene is Empty!");n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Start",this).call(this),this._currScene.Start()}},{key:"Update",value:function(t,e){null!=this.SocketStore&&this.SocketStore.Update(t,e),this._currScene.Update(t,e)}},{key:"Render",value:function(t,e){this._currScene.Render(t,e)}},{key:"Stop",value:function(){this._currScene.Stop(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Stop",this).call(this)}},{key:"Resize",value:function(t){this.width=this.ctx.canvas.offsetWidth,this.height=this.ctx.canvas.offsetHeight,null!=this._currScene&&this._currScene.Resize(t,{width:this.width,height:this.height})}},{key:"RemoveAll",value:function(){this.scene.RemoveAll()}},{key:"Destroy",value:function(){this.SocketStore&&this.SocketStore.Destroy()}},{key:"scene",get:function(){return this._currScene},set:function(t){null==t?null!=this._currScene&&this._currScene.Stop():(null!=this._currScene&&(this._currScene.Stop(),this._currScene.RemoveAll()),this._currScene=new t(this,{width:this.width,height:this.height}))}}]),r}(f),R=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new c(0,0),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c(0,0);e(this,t),this.min=i,this.max=n}return i(t,[{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"set",value:function(t,e){return this.min.copy(t),this.max.copy(e),this}},{key:"setFromXYWH",value:function(t){this.min.x=t.x,this.min.y=t.y,this.max.x=t.width+t.x,this.max.y=t.height+t.y}},{key:"setFromPoints",value:function(t){for(var e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}},{key:"isEmpty",value:function(){return this.max.x<this.min.x||this.max.y<this.min.y}},{key:"setCenter",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new c(0,0),e=this.getCenter(),i=e.subVectors(t,e);this.translate(i)}},{key:"getCenter",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new c(0,0)).addVectors(this.min,this.max).multiplyScalar(.5)}},{key:"getSize",value:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new c(0,0)).subVectors(this.max,this.min)}},{key:"setSize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new c(0,0);return this.max.x=this.min.x+t.x,this.max.y=this.min.y+t.y,this}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"expandByVector",value:function(t){return this.min.sub(t),this.max.add(t),this}},{key:"expandByScalar",value:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this}},{key:"containsPoint",value:function(t,e){return e?!(t.x<this.min.x-e||t.x>this.max.x+e||t.y<this.min.y-e||t.y>this.max.y+e):!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)}},{key:"containsBox",value:function(t,e){return e?this.min.x-e<=t.min.x&&t.max.x<=this.max.x+e&&this.min.y-e<=t.min.y&&t.max.y<=this.max.y+e:this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}},{key:"intersectsBox",value:function(t,e){return e?!(t.max.x<this.min.x-e||t.min.x>this.max.x+e||t.max.y<this.min.y-e||t.min.y>this.max.y+e):!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}},{key:"clampPoint",value:function(t){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:new c).copy(t).clamp(this.min,this.max)}},{key:"equationNW",value:function(){return(this.max.y-this.min.y)/(this.max.x-this.min.x)}},{key:"equationNE",value:function(){return(this.min.y-this.max.y)/(this.max.x-this.min.x)}},{key:"intersect",value:function(t){return this.min.max(t.min),this.max.min(t.max),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"translate",value:function(t){return this.min.add(t),this.max.add(t),this}},{key:"position",value:function(t){var e=this.max.x-this.min.x,i=this.max.y-this.min.y;this.min.x=t.x,this.min.y=t.y,this.max.x=t.x+e,this.max.y=t.y+i}},{key:"positionX",value:function(t){var e=this.max.x-this.min.x;this.min.x=t,this.max.x=t+e}},{key:"positionY",value:function(t){var e=this.max.y-this.min.y;this.min.y=t,this.max.y=t+e}},{key:"reconstruct",value:function(){var t=this.min.x,e=this.min.y,i=this.max.x,n=this.max.y;this.min.x=Math.min(t,i),this.min.y=Math.min(e,n),this.max.x=Math.max(t,i),this.max.y=Math.max(e,n)}},{key:"equals",value:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}},{key:"snap",value:function(t){return{min:this.min.snap(t),max:this.max.snap(t)}}},{key:"snapTo",value:function(t){this.min.snapTo(t),this.max.snapTo(t)}}]),t}(),C=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,t),this.id=i.id||"I"+Math.random().toString(36).slice(2),this._eventStore=void 0,this.hide=!1,this.order=i.order||0}return i(t,[{key:"Hide",value:function(){this.hide=!0}},{key:"Show",value:function(){this.hide=!1}},{key:"CollisionCheck",value:function(t){}},{key:"Picker",value:function(t){}},{key:"Update",value:function(t,e,i,n){}},{key:"UpdateServer",value:function(t,e){}},{key:"Render",value:function(t,e){}},{key:"RenderBefore",value:function(t,e){}},{key:"RenderAfter",value:function(t,e){}},{key:"Destroy",value:function(t){}}]),t}(),b=function(){function t(i,n){e(this,t),n=n||{},this.id=n.id||Math.random().toString(36).slice(2),this.ctx=i,this.Resize(),this._position=new c(n.x,n.y),this.distance=n.distance||1e3,this._viewport=new R,this._viewport.setFromXYWH({x:0,y:0,width:0,height:0}),this._viewport.scale={x:1,y:1},this.flustrum=[100,5e3],this.fieldOfView=Math.tan(Math.PI/4).toFixed(6),this.followId=null,this._eventStore={mousemove:function(t,e){this.OffsetMoveTo(-e.cameraOffset.x,-e.cameraOffset.y)},mousewheel:function(t,e){e.delta>0?this.OffsetZoomTo(-100,e.position):this.OffsetZoomTo(100,e.position)}},this.UpdateCamera()}return i(t,[{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"GetCenter",value:function(){return this._position}},{key:"RenderStart",value:function(){this.ctx.save(),this.ctx.scale(this._viewport.scale.x,this._viewport.scale.y),this.ctx.translate(-this._viewport.min.x,-this._viewport.min.y)}},{key:"RenderEnd",value:function(){this.ctx.restore()}},{key:"UpdateCamera",value:function(){this.setViewportFromSize(this.cvsWidth,this.cvsHeight)}},{key:"setViewportFromSize",value:function(t,e){var i=t/e,n=this.distance*this.fieldOfView,s=n/i;this._viewport.scale.x=t/n,this._viewport.scale.y=e/s,this._viewport.min.x=this._position.x-n/2,this._viewport.min.y=this._position.y-s/2,this._viewport.max.x=this._viewport.min.x+n,this._viewport.max.y=this._viewport.min.y+s}},{key:"GetScale",value:function(){return{x:this._viewport.scale.x,y:this._viewport.scale.y}}},{key:"SetDistanceFromScale",value:function(t){this.distance=this.cvsWidth/(t*this.fieldOfView),this.UpdateCamera()}},{key:"SetDistanceFromWidth",value:function(t){this.distance=t/this.fieldOfView,this.UpdateCamera()}},{key:"ZoomToFit",value:function(t,e){var i=this.cvsWidth/t,n=this.cvsHeight/e,s=i<n?i:n;this.SetDistanceFromScale(s)}},{key:"ZoomTo",value:function(t,e){var i=this.distance;this.distance=t,this.flustrum[0]>this.distance&&(this.distance=this.flustrum[0]),this.flustrum[1]<this.distance&&(this.distance=this.flustrum[1]),this._fixWorldPointZoom(i,e),this.UpdateCamera()}},{key:"OffsetZoomTo",value:function(t,e){var i=this.distance;this.distance+=t,this.flustrum[0]>this.distance&&(this.distance=this.flustrum[0]),this.flustrum[1]<this.distance&&(this.distance=this.flustrum[1]),this._fixWorldPointZoom(i,e),this.UpdateCamera()}},{key:"_fixWorldPointZoom",value:function(t,e){if(null!=e&&null!=e.x){var i=this.distance/t,n=this._position.x-e.x,s=this._position.y-e.y;this._position.x=e.x+n*i,this._position.y=e.y+s*i}}},{key:"MoveTo",value:function(t,e){this._position.x=t,this._position.y=e,this.UpdateCamera()}},{key:"OffsetMoveTo",value:function(t,e){this._position.x+=t,this._position.y+=e,this.UpdateCamera()}},{key:"ScreenToWorld",value:function(t,e){var i={};return i.x=t/this._viewport.scale.x+this._viewport.min.x,i.y=e/this._viewport.scale.y+this._viewport.min.y,i}},{key:"WorldToScreen",value:function(t,e){var i={};return i.x=(t-this._viewport.min.x)*this._viewport.scale.x,i.y=(e-this._viewport.min.y)*this._viewport.scale.y,i}},{key:"follow",value:function(t){this.followId=t}},{key:"Update",value:function(t){if(t){if(null!=this.followId){var e=t.getItem(this.followId);this.MoveTo(e.x,e.y)}if(null!=t.map){var i=this.x,n=this.y,s=this._viewport.min.x,o=this._viewport.min.y,r=this._viewport.max.x,a=this._viewport.max.y,h=0,u=0,l=this._viewport.getSize();l.x<t.map.w*t.map.scale&&(t.map.x*t.map.scale>s&&(h=t.map.x*t.map.scale-s),(t.map.x+t.map.w)*t.map.scale<r&&(h=(t.map.x+t.map.w)*t.map.scale-r)),l.y<t.map.h*t.map.scale&&(t.map.y*t.map.scale>o&&(u=t.map.y*t.map.scale-o),(t.map.y+t.map.h)*t.map.scale<a&&(u=(t.map.y+t.map.h)*t.map.scale-a)),this.MoveTo(i+h,n+u)}}}},{key:"Resize",value:function(){this.cvsWidth=this.ctx.canvas.offsetWidth,this.cvsHeight=this.ctx.canvas.offsetHeight}},{key:"x",set:function(t){this._position.x=t},get:function(){return this._position.x}},{key:"y",set:function(t){this._position.y=t},get:function(){return this._position.y}},{key:"zoom",get:function(){return this._viewport.scale}}]),t}(),O=function(){function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,t),this.id=i.id||"U"+Math.random().toString(36).slice(2),this._position=null,this.originalPosition=null,this.attachs={},this.attachObjects={},this._eventStore={},this.hide=null!=i.hide&&i.hide,this.opacity=i.opacity||1,this._collisionCheck=void 0===i.collisionCheck||i.collisionCheck,this.order=i.order||0,this.scale=i.scale||[1,1],this.originalScale=i.scale||[1,1],this.offset=[0,0],this.aura=0}return i(t,[{key:"Hide",value:function(){this.hide=!0}},{key:"Show",value:function(){this.hide=!1}},{key:"setCollisionCheck",value:function(t){this._collisionCheck=void 0===t||t}},{key:"changeScale",value:function(t){this.scale=t}},{key:"setScale",value:function(){if(this._position instanceof c)this.svgWidth&&this.svgHeight&&(this.scale[0]=2*this.radius/this.svgWidth,this.scale[1]=2*this.radius/this.svgHeight);else if(this._position instanceof R){var t=this.originalPosition.getSize(),e=this._position.getSize();this.scale[0]=e.x/t.x,this.scale[1]=e.y/t.y}}},{key:"Position",value:function(t,e){this._position instanceof c?null!=e?"X"==e?this._position.x=t.x:"Y"==e&&(this._position.y=t.y):this._position.copy(t):this._position instanceof R&&(null!=e?"X"==e?this._position.positionX(t.x):"Y"==e&&this._position.positionY(t.y):this._position.position(t)),this.executeAttach()}},{key:"Translate",value:function(t,e){if(null!=e){var i=t;i.snapTo(e),this.Position(i)}else this._position instanceof c?this._position.add(t):this._position instanceof R&&this._position.translate(t),this.executeAttach()}},{key:"Rotate",value:function(){this.executeAttach()}},{key:"Scale",value:function(){this.executeAttach()}},{key:"GetCenter",value:function(){return this._position instanceof c?this._position:this._position instanceof R?this._position.getCenter():new c(0,0)}},{key:"getSnap",value:function(t){return this._position instanceof c?this._position.snap(t):this._position instanceof R?this._position.snap(t):new c(0,0)}},{key:"setSnap",value:function(t){return this._position instanceof c?this._position.snapTo(t):this._position instanceof R?this._position.snapTo(t):new c(0,0)}},{key:"CollisionCheck",value:function(e){if(!0!==this._collisionCheck)return!1;var i=e;if(e instanceof t&&(i=e._position),this._position instanceof c){var n=this._position.clone();if(i instanceof c){var s=n.sub(i).lenSq(),o=this.radius+this.aura;if(s<1/0&&s<o*o)return!0}else if(i instanceof R)return i.containsPoint(this._position,this.aura)}else if(this._position instanceof R){if(i instanceof c)return this._position.containsPoint(i,this.aura);if(i instanceof R)return this._position.intersectsBox(i,this.aura)}return!1}},{key:"Destroy",value:function(){delete this._position,delete this.originalPosition}},{key:"Update",value:function(t,e,i,n){}},{key:"Render",value:function(t){this.opacity<1&&(t.globalAlpha=this.opacity)}},{key:"SetOffset",value:function(t,e){this.offset=[t,e]}},{key:"EventStore",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];for(var i in t)!0===e||void 0===this._eventStore[i]?this._eventStore[i]=[t[i]]:this._eventStore[i].push(t[i])}},{key:"Attach",value:function(t,e){void 0===this.attachs[t.id]?this.attachs[t.id]=[e]:this.attachs[t.id].push(e),this.attachObjects[t.id]=t,this.executeAttach()}},{key:"Detach",value:function(t){delete this.attachs[t.id],delete this.attachObjects[t.id]}},{key:"executeAttach",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};for(var i in this.attachs)if(t!=i){for(var n=this.attachs[i],s=this.attachObjects[i],o=[],r=0;r<n.length;r++){var a=n[r].call(s,e);null!=a&&(o=a instanceof Array?o.concat(a):o.concat([a]))}null==t&&(t=this.id);for(var h in o)o[h].executeAttach(t,e)}}}]),t}(),I=function(t){function r(t){e(this,r);var i=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return i.shadow=t.shadow,i.originalColor=t.color,i.color=t.color,i.lineColor=t.lineColor||"#000000",i.setLineType(t.lineType),i.lineWidth=null==t.lineWidth?0:t.lineWidth,i}return s(r,t),i(r,[{key:"setColor",value:function(t){this.color=t}},{key:"setLineColor",value:function(t){this.lineColor=t}},{key:"setLineType",value:function(t){this.lineType="DASH"==t?[15,5]:"DOT"==t?[5,5]:"SOLID"==t?null:t}},{key:"Render",value:function(t){n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Render",this).call(this,t),null!=this.shadow&&(t.shadowColor=this.shadow.color,t.shadowBlur=this.shadow.blur,t.shadowOffsetX=this.shadow.offsetX,t.shadowOffsetY=this.shadow.offsetY),this.lineWidth>0&&(t.strokeStyle=this.lineColor,t.lineWidth=this.lineWidth,null!=this.lineType&&t.setLineDash(this.lineType))}},{key:"checkLinePointDist",value:function(t,e,i,n){return!!(this._pointNearByLine(t,e,i,n)&&this._linePointDist(t,e,i)<n)}},{key:"_pointNearByLine",value:function(t,e,i,n){var s=t.x<e.x?t.x:e.x,o=t.y<e.y?t.y:e.y,r=t.x>e.x?t.x:e.x,a=t.y>e.y?t.y:e.y;return i.x>=s-n&&i.x<=r+n&&i.y>=o-n&&i.y<=a+n}},{key:"_linePointDist",value:function(t,e,i){var n=t.y-e.y,s=e.x-t.x,o=t.x*e.y-e.x*t.y;return Math.abs(n*i.x+s*i.y+o)/Math.sqrt(n*n+s*s)}}]),r}(O),L=function(t){function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,r);var i=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return i._position=new R,i._position.setFromXYWH(t),i.originalPosition=new R,i.originalPosition.setFromXYWH(t),i.angle=0,i}return s(r,t),i(r,[{key:"Render",value:function(t){if(!0===this.hide)return!1;t.save(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Render",this).call(this,t);var e=this._position.min,i=this._position.getSize();if(this.angle){var s=this._position.getCenter();t.translate(s.x,s.y),t.rotate(this.angle),t.translate(-s.x,-s.y)}null!=this.color&&(t.fillStyle=this.color,t.fillRect(e.x,e.y,i.x,i.y)),t.strokeRect(e.x,e.y,i.x,i.y),t.scale(this.scale[0],this.scale[1]),t.restore()}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}},{key:"width",set:function(t){this._position.max.x=t+this._position.min.x}},{key:"height",set:function(t){this._position.max.y=t+this._position.min.y}}]),r}(I),A=function(){function t(){e(this,t),this.ARG_LENGTH={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0}}return i(t,[{key:"_parseValues",value:function(t){var e=t.match(/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/gi);return e?e.map(Number):[]}},{key:"Parse",value:function(t){var e=this,i=[],n=String(t).trim();return"M"!==n[0]&&"m"!==n[0]?i:(n.replace(/([astvzqmhlc])([^astvzqmhlc]*)/gi,function(t,n,s){var o=n.toLowerCase(),r=e._parseValues(s),a=n;if("m"===o&&r.length>2&&(i.push([a].concat(r.splice(0,2))),o="l",a="m"===a?"l":"L"),r.length<e.ARG_LENGTH[o])return"";for(i.push([a].concat(r.splice(0,e.ARG_LENGTH[o])));r.length>=e.ARG_LENGTH[o]&&r.length&&e.ARG_LENGTH[o];)i.push([a].concat(r.splice(0,e.ARG_LENGTH[o])));return""}),i)}}]),t}(),U=function(){function t(i){e(this,t),this.segments=[];var n=new A;this.segments=n.Parse(i)}return i(t,[{key:"Render",value:function(t){this.buildPath(t,this.segments)}},{key:"_rotatePoint",value:function(t,e){var i=t.x*Math.cos(e)-t.y*Math.sin(e),n=t.y*Math.cos(e)+t.x*Math.sin(e);t.x=i,t.y=n}},{key:"_translatePoint",value:function(t,e,i){t.x+=e,t.y+=i}},{key:"_scalePoint",value:function(t,e){t.x*=e,t.y*=e}},{key:"moveTo",value:function(t,e){this.segments.push(["M",t,e])}},{key:"lineTo",value:function(t,e){this.segments.push(["L",t,e])}},{key:"arc",value:function(t,e,i,n,s,o){this.segments.push(["AC",t,e,i,n,s,!!o])}},{key:"arcTo",value:function(t,e,i,n,s){this.segments.push(["AT",t,e,i,n,s])}},{key:"ellipse",value:function(t,e,i,n,s,o,r,a){this.segments.push(["E",t,e,i,n,s,o,r,!!a])}},{key:"closePath",value:function(){this.segments.push(["Z"])}},{key:"bezierCurveTo",value:function(t,e,i,n,s,o){this.segments.push(["C",t,e,i,n,s,o])}},{key:"quadraticCurveTo",value:function(t,e,i,n){this.segments.push(["Q",t,e,i,n])}},{key:"rect",value:function(t,e,i,n){this.segments.push(["R",t,e,i,n])}},{key:"buildPath",value:function(t,e){var i=void 0,n=void 0,s=void 0,o=void 0,r=void 0,a=void 0,h=void 0,u=void 0,l=void 0,c=void 0,y=void 0,v=void 0,f=void 0,d=void 0,_=void 0,p=void 0,m=void 0,x=void 0,k=void 0,g=void 0,S=void 0,w=void 0,z=void 0,P=void 0,T=void 0,M=void 0,R={x:0,y:0},C={x:0,y:0};t.beginPath();for(var b=0;b<e.length;++b){var O=e[b];"S"!==(g=O[0])&&"s"!==g&&"C"!==g&&"c"!==g&&(w=null,z=null),"T"!==g&&"t"!==g&&"Q"!==g&&"q"!==g&&(P=null,T=null),"M"==g||"m"==g?("m"===g?(y+=O[1],f+=O[2]):(y=O[1],f=O[2]),"M"!==g&&R||(R={x:y,y:f}),t.moveTo(y,f)):"l"==g?(y+=O[1],f+=O[2],t.lineTo(y,f)):"L"==g?(y=O[1],f=O[2],t.lineTo(y,f)):"h"==g?(y+=O[1],t.lineTo(y,f)):"H"==g?(y=O[1],t.lineTo(y,f)):"v"==g?(f+=O[1],t.lineTo(y,f)):"V"==g?(f=O[1],t.lineTo(y,f)):"A"==g||"a"==g?("a"===g?(y+=O[6],f+=O[7]):(y=O[6],f=O[7]),p=O[1],m=O[2],h=O[3]*Math.PI/180,s=!!O[4],o=!!O[5],r={x:y,y:f},a={x:(C.x-r.x)/2,y:(C.y-r.y)/2},this._rotatePoint(a,-h),(u=a.x*a.x/(p*p)+a.y*a.y/(m*m))>1&&(p*=u=Math.sqrt(u),m*=u),S={x:p*a.y/m,y:-m*a.x/p},l=p*p*m*m,c=p*p*a.y*a.y+m*m*a.x*a.x,o!==s?this._scalePoint(S,Math.sqrt((l-c)/c)||0):this._scalePoint(S,-Math.sqrt((l-c)/c)||0),n=Math.atan2((a.y-S.y)/m,(a.x-S.x)/p),i=Math.atan2(-(a.y+S.y)/m,-(a.x+S.x)/p),this._rotatePoint(S,h),this._translatePoint(S,(r.x+C.x)/2,(r.y+C.y)/2),t.save(),t.translate(S.x,S.y),t.rotate(h),t.scale(p,m),t.arc(0,0,1,n,i,!o),t.restore()):"c"==g?(t.bezierCurveTo(O[1]+y,O[2]+f,O[3]+y,O[4]+f,O[5]+y,O[6]+f),w=O[3]+y,z=O[4]+f,y+=O[5],f+=O[6]):"C"==g?(w=O[3],z=O[4],y=O[5],f=O[6],t.bezierCurveTo(O[1],O[2],w,z,y,f)):"s"==g?(null!==w&&null!==w||(w=y,z=f),t.bezierCurveTo(2*y-w,2*f-z,O[1]+y,O[2]+f,O[3]+y,O[4]+f),w=O[1]+y,z=O[2]+f,y+=O[3],f+=O[4]):"S"==g?(null!==w&&null!==w||(w=y,z=f),t.bezierCurveTo(2*y-w,2*f-z,O[1],O[2],O[3],O[4]),w=O[1],z=O[2],y=O[3],f=O[4]):"q"==g?(P=O[1]+y,T=O[2]+f,y+=O[3],f+=O[4],t.quadraticCurveTo(P,T,y,f)):"Q"==g?(P=O[1],T=O[2],y=O[3],f=O[4],t.quadraticCurveTo(P,T,y,f)):"t"==g?(null!==P&&null!==P||(P=y,T=f),P=2*y-P,T=2*f-T,y+=O[1],f+=O[2],t.quadraticCurveTo(P,T,y,f)):"T"==g?(null!==P&&null!==P||(P=y,T=f),P=2*y-P,T=2*f-T,y=O[1],f=O[2],t.quadraticCurveTo(P,T,y,f)):"z"==g||"Z"==g?(y=R.x,f=R.y,R=void 0,t.closePath()):"AC"==g?(y=O[1],f=O[2],_=O[3],n=O[4],i=O[5],M=O[6],t.arc(y,f,_,n,i,M)):"AT"==g?(v=O[1],d=O[2],y=O[3],f=O[4],_=O[5],t.arcTo(v,d,y,f,_)):"E"==g?(y=O[1],f=O[2],p=O[3],m=O[4],h=O[5],n=O[6],i=O[7],M=O[8],t.save(),t.translate(y,f),t.rotate(h),t.scale(p,m),t.arc(0,0,1,n,i,M),t.restore()):"R"==g?(y=O[1],f=O[2],x=O[3],k=O[4],R={x:y,y:f},t.rect(y,f,x,k)):console.log(g+"is not implemented"),C.x=y,C.y=f}}}]),t}(),F=function(t){function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,r);var i=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return i._position=new c(t.x,t.y),i.originalPosition=new c(t.x,t.y),i.radius=t.radius||5,i.pivotCenter=t.pivotCenter,i.pointType=t.pointType||"POINT",i.angle=t.angle||0,null!=t.svg&&(i.svgData=new U(t.svg.dataSource),i.svgWidth=t.svg.width||10,i.svgHeight=t.svg.height||10),i}return s(r,t),i(r,[{key:"set",value:function(t,e){this._position=new c(t,e)}},{key:"setAngle",value:function(t,e){this.angle=Math.atan2(e.y-t.y,e.x-t.x)}},{key:"setPointType",value:function(t){"POINT"!=t&&"ARROW"!=t&&"RECT"!=t&&"SVG"!=t||(this.pointType=t)}},{key:"changeSvg",value:function(t){null!=t&&(this.svgData=new U(t))}},{key:"Update",value:function(){}},{key:"Render",value:function(t){if(!0!==this.hide){t.save(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Render",this).call(this,t),t.beginPath();var e=this._position.x+this.offset[0],i=this._position.y+this.offset[1];if("POINT"==this.pointType)t.arc(e,i,this.radius,0,2*Math.PI,!1);else if("ARROW"==this.pointType){var s=2*this.radius,o=this.angle;!0===this.pivotCenter&&(e+=this.radius*Math.cos(o),i+=this.radius*Math.sin(o)),t.moveTo(e,i),t.lineTo(e-s*Math.cos(o-Math.PI/6),i-s*Math.sin(o-Math.PI/6)),t.lineTo(e-s*Math.cos(o+Math.PI/6),i-s*Math.sin(o+Math.PI/6))}else if("RECT"==this.pointType){var a=this.radius;null!=this.color&&(t.fillStyle=this.color,t.fillRect(e-a,i-a,2*a,2*a)),t.strokeRect(e-a,i-a,2*a,2*a)}else"SVG"==this.pointType&&(t.fillStyle=this.color,t.translate(e,i),t.rotate(this.angle),t.translate(-this.radius,-this.radius),t.scale(this.scale[0],this.scale[1]),null!=this.svgData&&this.svgData.Render(t));t.closePath(),t.stroke(),null!=this.color&&(t.fillStyle=this.color,t.fill()),t.restore()}}},{key:"x",set:function(t){this._position.x=t},get:function(){return this._position.x}},{key:"y",set:function(t){this._position.y=t},get:function(){return this._position.y}}]),r}(I),D=function(t){function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,r);var i=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return i.dataSource=t.dataSource,i.image=l.Load(i.dataSource),""!==i.image&&(null==t.width&&(t.width=i.image.width),null==t.height&&(t.height=i.image.height)),i._position=new R,i._position.setFromXYWH(t),i.originalPosition=new R,i.originalPosition.setFromXYWH(t),i.isDynamic=null!=t.isDynamic&&t.isDynamic,i.angle=0,i}return s(r,t),i(r,[{key:"resetImage",value:function(t){null!=t&&(this.dataSource=t),this.image=l.Load(this.dataSource),null!=this.image&&(this.originalPosition.setSize({x:this.image.width,y:this.image.height}),this.setScale())}},{key:"Destroy",value:function(){n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Destroy",this).call(this),!0===this.isDynamic&&l.Remove(this.dataSource)}},{key:"Render",value:function(t){if(!0===this.hide)return!1;if(null===this.image)return!1;t.save(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Render",this).call(this,t);var e=this._position.min,i=this._position.getSize();if(""===this.image&&this.resetImage(),this.angle){var s=this._position.getCenter();t.translate(s.x,s.y),t.rotate(this.angle),t.translate(-s.x,-s.y)}""!==this.image&&t.drawImage(this.image,e.x,e.y,i.x,i.y),t.scale(this.scale[0],this.scale[1]),t.restore()}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),r}(I),E=function(){function t(i){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e(this,t),this.id=Math.random().toString(36).slice(2),this.stage=i,this.ctx=i.ctx,this.width=n.width||100,this.height=n.height||100,this.camera=null,this.EventStore=i.EventStore,this.Items={},this.Units={},this._orderedItems=[],this._orderedUnits=[],this._unitsWithParent={},this.gravity=!1}return i(t,[{key:"_World",value:function(t){}},{key:"RemoveAll",value:function(){for(var t in this.Items)this.Remove(t)}},{key:"Remove",value:function(t){var e=null,i=this.getItem(t);if(null!=i){if(this.stage.setRemovePack&&this.stage.setRemovePack(t),i instanceof C)for(var n in i){var s=i[n];s instanceof O&&(this.getUnit(s.id).Destroy(this.stage),this.removeUnit(s.id,i.id),void 0!==this.EventStore&&this.EventStore.Remove(s.id))}else i instanceof O&&(this.getUnit(t).Destroy(this.stage),this.removeUnit(t,t),this.EventStore.Remove(t));i.Destroy(),e=this.removeItem(t)}return this.resetOrder(),e}},{key:"resetOrder",value:function(){this._orderedItems=this._makeOrderedArray(this._orderedItems,!0),this.makeOrderdUnits()}},{key:"setUnitOrder",value:function(t){var e=this._unitsWithParent[t];this._unitsWithParent[t]=this._makeOrderedArray(e)}},{key:"makeOrderdUnits",value:function(){this._orderedUnits=[];for(var t in this._orderedItems){var e=this._orderedItems[t],i=this._unitsWithParent[e.id];null!=i&&(this._orderedUnits=i.concat(this._orderedUnits))}for(var n in this._orderedUnits)if(this._orderedUnits[n].order==1/0){var s=this._orderedUnits.splice(n,1);for(var o in s)this._orderedUnits.unshift(s[o])}}},{key:"sortByIndex",value:function(t,e){if(!isNaN(e)){for(var i in this._orderedItems)if(this._orderedItems[i].id==t){var n=this._orderedItems.splice(i,1);this._orderedItems.splice(Number(e),0,n[0]);break}this.resetOrder()}}},{key:"bringToFront",value:function(t){for(var e in this._orderedItems)if(this._orderedItems[e].id==t.id){var i=this._orderedItems.splice(e,1);for(var n in i)this._orderedItems.push(i[n]);break}}},{key:"sendToBack",value:function(t){for(var e in this._orderedItems)if(this._orderedItems[e].id==t.id){var i=this._orderedItems.splice(e,1);for(var n in i)this._orderedItems.unshift(i[n]);break}}},{key:"Add",value:function(t,e){if(t instanceof b)this.camera=t,void 0!==this.EventStore&&this.EventStore.Add(t,t._eventStore);else if(t instanceof O)this.setItem(t.id,t,e),this.setUnit(t.id,t,t.id),void 0!==this.EventStore&&this.EventStore.Add(t,t._eventStore);else if(t instanceof C){!0===this.gravity?t.gravity=t.weight:t.gravity=0,this.setItem(t.id,t,e);for(var i in t){var n=t[i];n instanceof O&&(this.setUnit(n.id,n,t.id),void 0!==this.EventStore&&this.EventStore.Add(n,n._eventStore,t.id))}this.setUnitOrder(t.id),this.stage.setInitPack&&this.stage.setInitPack(t.getPack())}return this.resetOrder(),t.id}},{key:"searchItems",value:function(t){var e=[];for(var i in this._orderedItems){var n=this._orderedItems[i];for(var s in t)if(n[s]===t[s]){e.push(n);break}}return e}},{key:"searchInstance",value:function(t){var e=[];for(var i in this._orderedItems){var n=this._orderedItems[i];n instanceof t&&e.push(n)}return e}},{key:"_findIndex",value:function(t,e){for(var i in e)if(e[i].id==t)return i}},{key:"setItem",value:function(t,e,i){if(this.Items[t]=e,null!=i)return this._orderedItems.splice(i,0,e),i;var n=this._findIndex(t,this._orderedItems);return void 0!=n?this._orderedItems[n]=e:this._orderedItems.push(e),n}},{key:"getItem",value:function(t){return this.Items[t]}},{key:"getItem",value:function(t){return this.Items[t]}},{key:"getItemArray",value:function(t){return this._orderedItems[t]}},{key:"getItems",value:function(){return this.Items}},{key:"getItemArrays",value:function(){return this._orderedItems}},{key:"removeItem",value:function(t){delete this.Items[t];var e=this._findIndex(t,this._orderedItems);return this._orderedItems.splice(e,1),e}},{key:"getUnit",value:function(t){return this.Units[t]}},{key:"getUnitArray",value:function(t){return this._orderedUnits[t]}},{key:"setUnit",value:function(t,e,i){this.Units[t]=e,null==this._unitsWithParent[i]&&(this._unitsWithParent[i]=[]),this._unitsWithParent[i].push(e)}},{key:"getUnits",value:function(t){return this.Units}},{key:"getUnitArrays",value:function(){return this._orderedUnits}},{key:"removeUnit",value:function(t,e){delete this.Units[t];var i=this._unitsWithParent[e],n=this._findIndex(t,i);return i.splice(n,1),n}},{key:"_makeOrderedArray",value:function(t,e){var i=new Array,n=new Array;for(var s in t){var o=t[s];null==n[Number(o.order)]?n[Number(o.order)]=[o]:n[Number(o.order)].push(o)}for(var r in n){var a=n[r];if(a instanceof Array)for(var h in a){var u=a[h];!0===e?i.push(u):i.unshift(u)}}return i}},{key:"Start",value:function(){}},{key:"Update",value:function(t,e){for(var i in this._orderedItems)this._orderedItems[i].Update(t,e,this,i)}},{key:"RenderBefore",value:function(){if(!0===this.renderBefore)for(var t in this._orderedItems){var e=this._orderedItems[t];1!=e.hide&&(e.RenderBefore&&e.RenderBefore(this.ctx,this.camera,t))}}},{key:"RenderAfter",value:function(){if(!0===this.renderAfter)for(var t in this._orderedItems){var e=this._orderedItems[t];1!=e.hide&&(e.RenderAfter&&e.RenderAfter(this.ctx,this.camera,t))}}},{key:"Render",value:function(){this.ctx.clearRect(0,0,this.width,this.height),null!=this.camera&&(this.camera.Update(this),this.camera.RenderStart()),this.RenderBefore(this.ctx,this.camera);for(var t in this._orderedItems){var e=this._orderedItems[t];1!=e.hide&&e.Render(this.ctx,this.camera,t)}this.RenderAfter(this.ctx,this.camera),null!=this.camera&&this.camera.RenderEnd()}},{key:"Stop",value:function(){}},{key:"Resize",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};null!=e.width&&(this.width=e.width),null!=e.height&&(this.height=e.height),null!=this.camera&&(this.camera.Resize(),this.camera.UpdateCamera())}}]),t}(),W=function(){function t(i){var n=i.x,s=void 0===n?0:n,o=i.y,r=void 0===o?0:o,a=i.width,h=void 0===a?0:a,u=i.height,l=void 0===u?0:u,c=i.tileW,y=void 0===c?0:c,v=i.tileH,f=void 0===v?0:v,d=i.scale,_=void 0===d?1:d,p=i.collision,m=void 0===p?[]:p;e(this,t),this.x=s,this.y=r,this.scale=_,this.width=h,this.height=l,this.tileW=y,this.tileH=f,this.w=h*y,this.h=l*f,this.collision=m}return i(t,[{key:"collisionCheck",value:function(t){var e=t.x,i=t.y,n=t.dir,s=this.tileW*this.scale,o=this.tileH*this.scale,r=Math.floor(e/s),a=Math.floor(i/o);if(r<this.x||r>=this.width)return 0;if(a<this.y||a>=this.height)return 0;var h=this.collision[r+a*this.width];return h>0?"L"===n||"U"===n?{status:h,x:s-e%s,y:o-i%o}:{status:h,x:e%s,y:i%o}:0}},{key:"Destroy",value:function(){}}]),t}(),j=function(){function t(i,n){e(this,t),this.hide=!1,this.pos={x:i.x||0,y:i.y||0},this.size={x:i.w||64,y:i.h||64},this.scale=i.scale,this.dataSource=n.dataSource,this.image=l.Load(this.dataSource)}return i(t,[{key:"resetImage",value:function(t){null!=t&&(this.dataSource=t),this.image=l.Load(this.dataSource)}},{key:"Render",value:function(t,e){if(!0===this.hide)return!1;if(null===this.image)return!1;t.save();var i=this.pos,n=this.size;""===this.image&&this.resetImage(),""!==this.image&&t.drawImage(this.image,i.x,i.y,n.x,n.y,i.x*this.scale,i.y*this.scale,n.x*this.scale,n.y*this.scale),t.restore()}},{key:"Destroy",value:function(){!0===this.isDynamic&&l.Remove(this.dataSource)}}]),t}(),q=function(t){function r(t){e(this,r);var i=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));if(null==t.pos||t.pos.length<2)return console.error("[pos] is not valid"),o(i);i._position=[];for(var n=0;n<t.pos.length;n++)t.pos[n]instanceof c?i._position[n]=t.pos[n]:t.pos[n]instanceof Array&&(i._position[n]=new c(t.pos[n][0],t.pos[n][1]));return i}return s(r,t),i(r,[{key:"Render",value:function(t){if(!0!==this.hide){t.save(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Render",this).call(this,t),t.beginPath();for(var e=0;e<this._position.length;e++)0==e?t.moveTo(this._position[0].x,this._position[0].y):t.lineTo(this._position[e].x,this._position[e].y);t.stroke(),t.closePath(),t.restore()}}},{key:"CollisionCheck",value:function(t){if(!0!==this._collisionCheck)return!1;var e=t;t instanceof O&&(e=t._position);if(e instanceof c)for(s=0;s<this._position.length-1;s++){var i=this._position[s],n=this._position[s+1];if(this.checkLinePointDist(i,n,e,5))return!0}else if(e instanceof R)for(var s=0;s<this._position.length;s++){var o=this._position[s];if(e.containsPoint(o))return!0}return!1}}]),r}(I),H=function(t){function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,r);var i=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return i._position=new R,i._position.setFromXYWH(t),i.originalPosition=new R,i.originalPosition.setFromXYWH(t),i.round=t.round||0,i.polygonType=t.polygonType||"RECT",i}return s(r,t),i(r,[{key:"setPolygonType",value:function(t){this.polygonType=t}},{key:"Render",value:function(t){if(!0===this.hide)return!1;t.save(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Render",this).call(this,t);var e=this._position.min,i=this._position.getSize();"RECT"===this.polygonType?this.drawRect(t,e.x,e.y,i.x,i.y):"ROUND"===this.polygonType?this.drawRoundRect(t,e.x,e.y,i.x,i.y):"CIRCLE"===this.polygonType?this.drawEllipse(t,e.x,e.y,i.x,i.y):"DIAMOND"===this.polygonType?this.drawDiamond(t,e.x,e.y,i.x,i.y):"ARROW"===this.polygonType&&this.drawArrow(t,e.x,e.y,i.x,i.y),null!=this.color&&(t.fillStyle=this.color,t.fill()),t.scale(this.scale[0],this.scale[1]),t.restore()}},{key:"drawRect",value:function(t,e,i,n,s){t.beginPath(),t.moveTo(e,i),t.lineTo(e+n,i),t.lineTo(e+n,i+s),t.lineTo(e,i+s),t.closePath(),t.stroke()}},{key:"drawArrow",value:function(t,e,i,n,s){var o=i+s/2,r=.2*n;t.beginPath(),t.moveTo(e,i),t.lineTo(e+n-r,i),t.lineTo(e+n,o),t.lineTo(e+n-r,i+s),t.lineTo(e,i+s),t.lineTo(e+r,o),t.closePath(),t.stroke()}},{key:"drawDiamond",value:function(t,e,i,n,s){var o=e+n/2,r=i+s/2;t.beginPath(),t.moveTo(o,i),t.lineTo(e+n,r),t.lineTo(o,i+s),t.lineTo(e,r),t.closePath(),t.stroke()}},{key:"drawEllipse",value:function(t,e,i,n,s){var o=n/2*.5522848,r=s/2*.5522848,a=e+n,h=i+s,u=e+n/2,l=i+s/2;t.beginPath(),t.moveTo(e,l),t.bezierCurveTo(e,l-r,u-o,i,u,i),t.bezierCurveTo(u+o,i,a,l-r,a,l),t.bezierCurveTo(a,l+r,u+o,h,u,h),t.bezierCurveTo(u-o,h,e,l+r,e,l),t.closePath(),t.stroke()}},{key:"drawRoundRect",value:function(t,e,i,n,s){var o=n/2*.5,r=s/2*.5;o<r&&(r=o),o>r&&(o=r);var a=e+n,h=i+s;t.beginPath(),t.moveTo(e,i+r),t.quadraticCurveTo(e,i,e+o,i),t.lineTo(a-o,i),t.quadraticCurveTo(a,i,a,i+r),t.lineTo(a,h-r),t.quadraticCurveTo(a,h,a-o,h),t.lineTo(e+o,h),t.quadraticCurveTo(e,h,e,h-r),t.lineTo(e,i+r),t.closePath(),t.stroke()}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),r}(I),B=function(t){function r(t){e(this,r);var i=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));if(null==t.pos||t.pos.length<2)return console.error("[pos] is not valid"),o(i);i._position=[];for(var n=0;n<t.pos.length;n++)t.pos[n]instanceof c?i._position[n]=t.pos[n]:t.pos[n]instanceof Array&&(i._position[n]=new c(t.pos[n][0],t.pos[n][1]));return i.isBezier=t.isBezier||!1,i}return s(r,t),i(r,[{key:"Render",value:function(t){if(!0!==this.hide){t.save(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Render",this).call(this,t),t.beginPath();for(var e=[],i=0;i<this._position.length;i++)0==i?t.moveTo(this._position[0].x,this._position[0].y):(e.push(this._position[i].x),e.push(this._position[i].y));t.bezierCurveTo.apply(t,e),t.stroke(),t.closePath(),t.restore()}}}]),r}(I),V=function(t){function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,r);var i=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return i._position=new R,i._position.setFromXYWH(t),i.originalPosition=new R,i.originalPosition.setFromXYWH(t),null!=t.svg&&(i.svg=new U(t.svg)),i}return s(r,t),i(r,[{key:"changeSvg",value:function(t){null!=t&&(this.svg=new U(t))}},{key:"Render",value:function(t){!0!==this.hide&&(t.save(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Render",this).call(this,t),t.fillStyle=this.color,t.translate(this._position.min.x,this._position.min.y),t.scale(this.scale[0],this.scale[1]),null!=this.svg&&this.svg.Render(t),t.fill(),t.restore())}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),r}(I),X=function(t){function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,r);var i=o(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t));return i.text=t.text||"",i.url=t.url||"",i._position=new R,i._position.setFromXYWH(t),i.font=t.font||'normal normal 12px "serif"',null!=t.font&&i.makeFontAttr(t.font),null!=t.fontStyle?i.fontStyle=t.fontStyle:null==i.fontStyle&&(i.fontStyle="normal"),null!=t.fontWeight?i.fontWeight=t.fontWeight:null==i.fontWeight&&(i.fontWeight="normal"),null!=t.fontSize?i.fontSize=t.fontSize:null==i.fontSize&&(i.fontSize=12),null!=t.fontFace?i.fontFace=t.fontFace:null==i.fontFace&&(i.fontFace="serif"),i.align=t.align||"left",i.makeFont(),i.isChangeLine=null!=t.isChangeLine&&t.isChangeLine,i.isEllipsis=null==t.isEllipsis||t.isEllipsis,i.showBoundBox=null!=t.showBoundBox&&t.showBoundBox,i.setOpacity(t.boundboxOpacity),i.bgColor=t.bgColor,i.maxTextWidth=0,i.maxTextHeight=1,i}return s(r,t),i(r,[{key:"makeFontAttr",value:function(t){if(t.indexOf(" ")>-1){var e=t.substring(0,t.indexOf('"')-1),i=t.substring(t.indexOf('"'),t.length-1).replace('"',""),n=e.split(" ");n.length>2?(this.fontStyle=n[0],this.fontWeight=n[1],this.fontSize=Number(n[2].replace("px","")),this.fontFace=i):console.log('Error : please check Mask of Font.(style weight size "face")')}else this.fontFace=opts.font}},{key:"makeFont",value:function(){this.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+'px "'+this.fontFace+'"'}},{key:"setFontStyle",value:function(t){this.fontStyle=t||"normal",this.makeFont()}},{key:"setFontWeight",value:function(t){this.fontWeight=t||"normal",this.makeFont()}},{key:"setFontSize",value:function(t){this.fontSize=t||12,this.makeFont()}},{key:"setFontFace",value:function(t){this.fontFace=t||"serif",this.makeFont()}},{key:"setText",value:function(t){this.text=t||""}},{key:"setUrl",value:function(t){this.url=t||""}},{key:"setAlign",value:function(t){this.align=t||"left"}},{key:"setOpacity",value:function(t){var e=this.boundboxOpacity;this.boundboxOpacity=null!=t?t:1,0==t&&""!=this.text&&(this.boundboxOpacity=e)}},{key:"getMaxWidth",value:function(){return this.maxTextWidth}},{key:"getMaxHeight",value:function(){return this.maxTextHeight}},{key:"setMaxWidth",value:function(t){t.save(),t.font=this.font,t.textBaseline="top";var e=this.text.split("\n");this.maxTextHeight=e.length;for(var i in e){var n=t.measureText(e[i]).width;this.maxTextWidth<n&&(this.maxTextWidth=n)}t.restore()}},{key:"setBoxSizeCenter",value:function(t){var e=this._position.getCenter();if(null!=t&&!1===this.isEllipsis){t.save(),t.font=this.font,t.textBaseline="top";var i=t.measureText(this.text).width;i<20&&(i=20),this._position.max.x=this._position.min.x+i,this._position.setCenter(e),t.restore()}}},{key:"Update",value:function(t){}},{key:"Render",value:function(t){if(!0!==this.hide){if(t.save(),n(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"Render",this).call(this,t),!0===this.showBoundBox){this.boundboxOpacity<1&&(t.globalAlpha=this.boundboxOpacity);var e=this._position.min,i=this._position.getSize();null!=this.bgColor?(t.fillStyle=this.bgColor,t.fillRect(e.x,e.y,i.x,i.y)):(t.fillStyle=this.lineColor,t.strokeRect(e.x,e.y,i.x,i.y))}t.font=this.font,t.textBaseline="top",t.fillStyle=this.color;var s=this._position.min.x,o=this._position.getCenter();t.textAlign=this.align,"center"==this.align?s=o.x:"right"==this.align&&(s=this._position.max.x);var a=this._position.getSize();if(!0===this.isChangeLine){this.TextLineBreak(t,this.text,this.fontSize,1.2,s,this._position.min.y,a.x,this._position.max.y)}else!0===this.isEllipsis?t.fillText(this.TextEllipsis(t,this.text,a.x),s,this._position.min.y):t.fillText(this.text,s,this._position.min.y);t.restore()}}},{key:"TextEllipsis",value:function(t,e,i){var n=t.measureText(e).width,s=t.measureText("…").width;if(n<=i||n<=s)return e;for(var o=e.length;n>=i-s&&o-- >0;)e=e.substring(0,o),n=t.measureText(e).width;return e+"…"}},{key:"TextLineBreak",value:function(t,e,i,n,s,o,r,a){for(var h="",u=o,l=i*n,c=0;c<e.length;c++){var y=h+e[c],v=t.measureText(y).width;if(u+l>a)return void t.fillText("...",s+10,a-l);v<r&&"\n"!=e[c]?h=y:(t.fillText(h,s,u),h="\n"!=e[c]?e[c]:"",u+=l)}t.fillText(h,s,u)}},{key:"min",get:function(){return this._position.min}},{key:"max",get:function(){return this._position.max}}]),r}(I),Y=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,n);var i=o(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i.dataSource=t.dataSource,i.image=l.Load(i.dataSource),i.x=t.x||0,i.y=t.y||0,i.scale=t.scale||1,i.currAnim=t.currAnim,i.currFrame=0,i.anims=t.anim,i.action=i.anims[i.currAnim],i.isDynamic=null!=t.isDynamic&&t.isDynamic,i}return s(n,t),i(n,[{key:"resetImage",value:function(t){null!=t&&(this.dataSource=t),this.image=l.Load(this.dataSource)}},{key:"ChangeDatasource",value:function(t){this.resetImage(t)}},{key:"_ableToChangeAnim",value:function(){return this.action.next!==this.currAnim}},{key:"ChangeScale",value:function(t){this.scale=t}},{key:"ChangeAnim",value:function(t,e){this.currAnim!==t&&(e||!1===this._ableToChangeAnim())&&null!=this.anims[t]&&(this.currAnim=t,this.action=this.anims[t],this.currFrame=0,this.currTimmer=0,this.action.dir.length<this.currDir+1&&(this.currDir=0))}},{key:"ChangeDir",value:function(t){null!=this.action&&(this.currDir=this.action.dir[t])}},{key:"ChangeDirFromAngle",value:function(t){var e=this.action;if(null!=e){var i=Math.round(t/(360/e.dir.length))%e.dir.length;this.currDir=e.dir[i]}}},{key:"getAnim",value:function(t){return this.anims[t]}},{key:"Update",value:function(t,e){}},{key:"Render",value:function(t){if(!0===this.hide)return!1;if(null===this.image)return!1;if(t.save(),""===this.image&&this.resetImage(),""!==this.image){var e=this.action;if(null!=e){this.currTimmer+=e.animSpd,this.currTimmer||(this.currTimmer=0),this.currFrame=Math.floor(this.currTimmer),this.currFrame>=e.frame-1&&(this.currFrame=0,this.currTimmer=0,this.ChangeAnim(e.next,!0));var i=e.startX+this.currFrame*e.sizeX,n=e.startY+this.currDir*e.sizeY,s=.5*e.sizeX,o=.5*e.sizeY;t.drawImage(this.image,i,n,e.sizeX,e.sizeY,this.x-s*this.scale,this.y-o*this.scale,e.sizeX*this.scale,e.sizeY*this.scale)}}t.restore()}},{key:"Destroy",value:function(){!0===this.isDynamic&&l.Remove(this.dataSource)}}]),n}(O),N=function(t){function n(t){e(this,n);var i=o(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i._shape=new F(t),i._shape.EventStore({mousedown:function(t,e){this.setColor("#ff0000")},mouseup:function(t){this.setColor(this.originalColor)},mousemove:function(t,e){this.Translate(e.offset),t.Render()},click:function(t,e){console.log(this.parentId),t.scene.Remove(this.parentId),t.Render()}}),i}return s(n,t),i(n,[{key:"Render",value:function(t){this._shape.Render(t)}}]),n}(C),Z=function(t){function n(t){e(this,n);var i=o(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i._shape=new L(t),i._shape.EventStore({mousedown:function(t,e){this.setColor("#ff0000")},mouseup:function(t,e){this.setColor(this.originalColor)},mousemove:function(t,e){this.Translate(e.offset)},click:function(t,e){t.scene.Remove(this.parentId)},_afterCallback:function(t,e){t.Render()}}),i}return s(n,t),i(n,[{key:"Render",value:function(t){0==this._shape.hide&&this._shape.Render(t)}}]),n}(C),G=function(t){function n(t){e(this,n);var i=o(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));return i.controlRect=new L(t),i.text=t.text,i}return s(n,t),i(n,[{key:"Update",value:function(t){}},{key:"Render",value:function(t){t.fillText(this.text,10,10)}}]),n}(C),Q=function(t){function n(t){e(this,n);var i=o(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));i._c1=new F,i._c2=new F,i._c3=new F,i._c4=new F,i._rect=new L(t),i._c1.set(i._rect._position.min.x,i._rect._position.min.y),i._c2.set(i._rect._position.max.x,i._rect._position.min.y),i._c3.set(i._rect._position.min.x,i._rect._position.max.y),i._c4.set(i._rect._position.max.x,i._rect._position.max.y),i._rect.Attach(i.id,{min:{x:[i._c1._position,i._c3._position],y:[i._c1._position,i._c2._position]},max:{x:[i._c2._position,i._c4._position],y:[i._c3._position,i._c4._position]}}),i._c1.Attach(i.id,{min:{x:i._rect._position.min,y:i._rect._position.min},_next:[i._rect]}),i._c2.Attach(i.id,{min:{x:i._rect._position.max,y:i._rect._position.min},_next:[i._rect]}),i._c3.Attach(i.id,{min:{x:i._rect._position.min,y:i._rect._position.max},_next:[i._rect]}),i._c4.Attach(i.id,{min:{x:i._rect._position.max,y:i._rect._position.max},_next:[i._rect]}),i._rect.eventStore={mousemove:function(t,e){this.Translate(e.offset)},click:function(t,e){t.scene.Remove(this.parentId)},_after:function(t,e){t.Render()}};var s={mousemove:function(t,e){this.Translate(e.offset),t.Render()}};return i._c1.eventStore=s,i._c2.eventStore=s,i._c3.eventStore=s,i._c4.eventStore=s,i}return s(n,t),i(n,[{key:"Render",value:function(t){this._rect.Render(t),this._c1.Render(t),this._c2.Render(t),this._c3.Render(t),this._c4.Render(t)}}]),n}(C),K=function(t){function n(t){e(this,n);var i=o(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t));i._rect=new L(t),i._c1=new F,i._c2=new F,i._c3=new F,i._c4=new F,i._c1.set(i._rect._position.min.x,i._rect._position.min.y),i._c2.set(i._rect._position.max.x,i._rect._position.min.y),i._c3.set(i._rect._position.min.x,i._rect._position.max.y),i._c4.set(i._rect._position.max.x,i._rect._position.max.y),i._line=new q({pos:[i._c1._position,i._c2._position,i._c3._position,i._c4._position],isBezier:!0,lineType:"DASH",lineWidth:5}),i._rect.Attach(i.id,{min:{x:[i._line._position[0],i._line._position[2],i._c1._position,i._c3._position],y:[i._line._position[0],i._line._position[1],i._c1._position,i._c2._position]},max:{x:[i._line._position[1],i._line._position[3],i._c2._position,i._c4._position],y:[i._line._position[2],i._line._position[3],i._c3._position,i._c4._position]}}),i._c1.Attach(i.id,{min:{x:[i._rect._position.min,i._line._position[0]],y:[i._rect._position.min,i._line._position[0]]},_next:[i._rect]}),i._c2.Attach(i.id,{min:{x:[i._rect._position.max,i._line._position[1]],y:[i._rect._position.min,i._line._position[1]]},_next:[i._rect]}),i._c3.Attach(i.id,{min:{x:[i._rect._position.min,i._line._position[2]],y:[i._rect._position.max,i._line._position[2]]},_next:[i._rect]}),i._c4.Attach(i.id,{min:{x:[i._rect._position.max,i._line._position[3]],y:[i._rect._position.max,i._line._position[3]]},_next:[i._rect]}),i._rect.eventStore={mousemove:function(t,e){this.Translate(e.offset)},click:function(t,e){t.scene.Remove(this.parentId)},_after:function(t,e){t.Render()}};var s={mousemove:function(t,e){this.Translate(e.offset),t.Render()}};return i._c1.eventStore=s,i._c2.eventStore=s,i._c3.eventStore=s,i._c4.eventStore=s,i}return s(n,t),i(n,[{key:"Render",value:function(t){this._c1.Render(t),this._c2.Render(t),this._c3.Render(t),this._c4.Render(t),this._line.Render(t)}}]),n}(C),J=function(){function t(i){e(this,t),this.ctx=i.getContext("2d"),this.hudList={},this.Resize()}return i(t,[{key:"Add",value:function(t,e){this.hudList[t]=e,this.Render(t)}},{key:"Update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t.width=this.width,t.height=this.height;for(var e in t){var i=this.hudList[e];i&&(i.Update(t[e]),this.Render(e))}}},{key:"Render",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(e.ctx=this.ctx,e.width=this.width,e.height=this.height,null!=t)this.hudList[t].Render(e);else for(var i in this.hudList)this.hudList[i].Render(e)}},{key:"Resize",value:function(){this.width=this.ctx.canvas.offsetWidth,this.height=this.ctx.canvas.offsetHeight,this.Render()}}]),t}(),$=function(){function t(){e(this,t)}return i(t,[{key:"Update",value:function(t){}},{key:"Render",value:function(t){}}]),t}(),tt=function t(i,n){function s(t,e){var i={x:0,y:0};return i.x=t.x-e.x,i.y=t.y-e.y,i}function o(t){var e={x:t.clientX,y:t.clientY};if(null!==i.scene.camera){var n=i.canvas.getBoundingClientRect();e.x-=n.left,e.y-=n.top,e=i.scene.camera.ScreenToWorld(e.x,e.y)}return e}function r(t){return function(e){if(e.touches.length>0&&t(e.touches[0]))return e.preventDefault(),!1}}function a(t){var e=!1,n=o(t);if(null==(_=m.FindItemOne(n))&&(_=i.scene.camera),null!=_){f=n,d=n;var s={event:t,position:n};e=m.Trigger(_,"mousedown",s)}!0!==e&&t.preventDefault()}function h(t){if(++k%g!=0){var e=!1,i=o(t),n=m.FindItemOne(i);if(null!=n?(null==x&&(e=m.Trigger(n,"mouseover",{event:t,position:i,startPosition:f})),null!=x&&x.id!=n.id&&(e=m.Trigger(x,"mouseout",{event:t,position:i,startPosition:f}),e=m.Trigger(n,"mouseover",{event:t,position:i,startPosition:f})),x=n,e=m.Trigger(n,"mouseovermove",{event:t,position:i,startPosition:f})):null!=x&&(e=m.Trigger(x,"mouseout",{event:t,position:i,startPosition:f}),x=null),null!=_){var r=s(i,f),a=s(i,d);d=i;var h={offset:a,cameraOffset:r,event:t,currentObject:n,position:i,startPosition:f};e=m.Trigger(_,"mousemove",h)}!0!==e&&t.preventDefault()}}function u(t){var e=!1,i=o(t),n={event:t,currentObject:m.FindItemOne(i),position:i,startPosition:f};e=f&&d&&f.x==d.x&&f.y==d.y?m.Trigger(_,"click",n):m.Trigger(_,"mouseup",n),x=null,_=null,!0!==e&&t.preventDefault()}function l(t){!0!==m.Trigger(i.scene.camera,"mouseover",{event:t})&&t.preventDefault()}function c(t){!0!==m.Trigger(i.scene.camera,"mouseout",{event:t})&&t.preventDefault()}function y(t){var e=o(t),n=0;t||(t=window.event),t.wheelDelta?n=t.wheelDelta/120:t.detail&&(n=-t.detail/3),!0!==m.Trigger(i.scene.camera,"mousewheel",{event:t,delta:n,position:e})&&t.preventDefault()}function v(t){var e=o(t),i=m.FindItemOne(e,"dblclick"),n={event:t,position:e};!0!==m.Trigger(i,"dblclick",n)&&t.preventDefault()}e(this,t);var f,d,_,p=n||i.canvas,m=i.EventStore,x=null,k=0,g=2;p.onmousedown=a,p.ontouchstart=r(a),p.onmousemove=h,p.ontouchmove=r(h),p.onmouseup=u,p.ontouchup=r(u),p.ondblclick=v,p.onmousewheel=y,p.onmouseover=l,p.onmouseout=c},et=function t(i){function n(t){if(null!==i.scene.camera){var e={event:t,keyCode:t.which||t.keyCode};o.Trigger(i.scene.camera,"keydown",e)}}function s(t){if(null!==i.scene.camera){var e={event:t,keyCode:t.which||t.keyCode};o.Trigger(i.scene.camera,"keyup",e)}}e(this,t);var o=i.EventStore;document.onkeydown=n,document.onkeyup=s};t.DataSource=l,t.EventStore=y,t.HistoryStore=v,t.StageServer=_,t.ShaderProgram=m,t.Scene3D=w,t.Stage3D=z,t.Stage2D=M,t.Vec2=c,t.Box2=R,t.Scene2D=E,t.Camera2D=b,t.Path2D=U,t.Item=C,t.Map=W,t.MapImage=j,t.Shape=I,t.Rect=L,t.Point=F,t.Line=q,t.Polygon=H,t.BezierLine=B,t.Svg=V,t.Text=X,t.Image=D,t.Sprite=Y,t.Unit=O,t.Point2D=N,t.Rect2D=Z,t.TextBox2D=G,t.EditRect2D=Q,t.BezierLine2D=K,t.HUDContainer=J,t.HUD=$,t.MouseControl=tt,t.KeyboardControl=et,Object.defineProperty(t,"__esModule",{value:!0})});
